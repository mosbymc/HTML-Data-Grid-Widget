<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - ./dist/scripts/grid.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>./dist/scripts/grid.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">57.99</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">4270</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">221.31</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">95.96</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var grid = (function _grid($) {
    &#039;use strict&#039;;
    var dataTypes, events, aggregates, generateId, expressionParser,
        gridState = [],
        groupMenuText = &#039;Drag and drop a column header here to group by that column&#039;,
        predicates = {
            strictEqual: &#039;eq&#039;,
            looseEqual: &#039;==&#039;,
            strictNotEqual: &#039;neq&#039;,
            looseNotEqual: &#039;!=&#039;,
            greaterThanOrEqual: &#039;gte&#039;,
            greaterThan: &#039;gt&#039;,
            lessThanOrEqual: &#039;lte&#039;,
            lessThan: &#039;lt&#039;,
            not: &#039;!&#039;,
            contains: &#039;ct&#039;,
            notContains: &#039;nct&#039;
        };

    function create(gridData, gridElem) {
        if (gridData &amp;&amp; isDomElement(gridElem)) {
            var id = generateId();
            gridElem = $(gridElem).addClass(&#039;grid_elem&#039;);
            var wrapperDiv = $(&#039;&lt;div id=&quot;grid-wrapper-&#039; + id + &#039;&quot; data-grid_id=&quot;&#039; + id + &#039;&quot; class=grid-wrapper&gt;&lt;/div&gt;&#039;).appendTo(gridElem);
            var headerDiv = $(&#039;&lt;div id=&quot;grid-header-&#039; + id + &#039;&quot; data-grid_header_id=&quot;&#039; + id + &#039;&quot; class=grid-header-div&gt;&lt;/div&gt;&#039;).appendTo(wrapperDiv);
            headerDiv.append(&#039;&lt;div class=grid-header-wrapper&gt;&lt;/div&gt;&#039;);
            wrapperDiv.append(&#039;&lt;div id=&quot;grid-content-&#039; + id + &#039;&quot; data-grid_content_id=&quot;&#039; + id + &#039;&quot; class=grid-content-div&gt;&lt;/div&gt;&#039;);
            wrapperDiv.append(&#039;&lt;div id=&quot;grid-footer-&#039; + id + &#039;&quot; data-grid_footer_id=&quot;&#039; + id + &#039;&quot; class=grid-footer-div&gt;&lt;/div&gt;&#039;);

            gridState[id] = {};
            gridElem[0].grid = {};

            createGridInstanceMethods(gridElem, id);

            (gridData.useValidator === true &amp;&amp; window.validator &amp;&amp; typeof validator.setAdditionalEvents === &#039;function&#039;) ? validator.setAdditionalEvents([&#039;blur&#039;, &#039;change&#039;]) : gridData.useValidator = false;
            gridData.useFormatter = gridData.useFormatter === true &amp;&amp; window.formatter &amp;&amp; typeof formatter.getFormattedInput === &#039;function&#039;;

            gridData.columnIndices = {};
            gridData.columns.forEach(function _createColumnIndices(col, idx) {
                gridData.columnIndices[col.field] = idx;
            });
            createGridHeaders(gridData, gridElem);
            getInitialGridData(gridData.dataSource, gridData.pageSize || 25, function initialGridDataCallback(err, res) {
                if (!err) {
                    gridData.dataSource.data = res.data;
                    gridData.dataSource.rowCount = isInteger(res.rowCount) ? res.rowCount : res.data.length;
                    if (res.aggregations) {
                        for (var col in gridData.aggregates) {
                            if (res.aggregations[col])
                                gridData.aggregates[col].value = res.aggregations[col];
                        }
                    }
                }
                else {
                    gridData.dataSource.data = {};
                    gridData.dataSource.rowCount = 0;
                }
                initializeGrid(id, gridData, gridElem);
            });
        }
        return gridElem[0].grid;
    }

    function drillDownCreate(gridData, gridElem, parentId) {
        gridData.parentGridId = parentId;
        grid.createGrid(gridData, gridElem);
    }

    function createGridInstanceMethods(gridElem, gridId) {

        Object.defineProperties(
            gridElem[0].grid, {
                &#039;bindEvents&#039;: {
                    value: function _bindGridEvents(evt, funcs) {
                        if (!funcs || (typeof funcs !== &#039;function&#039; &amp;&amp; !Array.isArray(funcs))) return false;
                        if (typeof funcs === &#039;function&#039;) funcs = [funcs];
                        if (events.includes(evt)) {
                            gridState[gridId].events[evt] = gridState[gridId].events[evt].concat(funcs);
                            return true;
                        }
                        return false;
                    },
                    writable: false,
                    configurable: false
                },
                &#039;unbindEvents&#039;: {
                    value: function _unbindEvents(evt, funcs) {
                        if (events.includes(evt) &amp;&amp; (funcs || (typeof funcs === &#039;function&#039; || Array.isArray(funcs)))) {
                            if (typeof funcs === &#039;function&#039;) funcs = [funcs];
                            var tmpEvts = [];
                            for (var i = 0; i &lt; gridState[gridId].events[evt].length; i++) {
                                for (var j = 0; j &lt; funcs.length; j++) {
                                    if (gridState[gridId].events[evt][i] !== funcs[j])
                                        tmpEvts.push(gridState[gridId].events[evt][i]);
                                }
                            }
                            gridState[gridId].events[evt] = tmpEvts;
                            return true;
                        }
                        return false;
                    },
                    writable: false,
                    configurable: false
                },
                &#039;removeAllEventHandlers&#039;: {
                    value: function _removeAllEventHandlers() {
                        for (var i = 0; i &lt; events.length; i++) {
                            gridState[gridId].events[events[i]] = [];
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;getHandledEvents&#039;: {
                    value: function _getHandledEvents() {
                        var evts = [];
                        for (var i = 0; i &lt; events.length; i++) {
                            if (gridState[gridId].events[events[i]].length)
                                evts.push(events[i]);
                        }
                        return evts;
                    },
                    writable: false,
                    configurable: false
                },
                &#039;getAvailableEvents&#039;: {
                    value: function _getAvailableEvents() {
                        return events;
                    },
                    writable: false,
                    configurable: false
                },
                &#039;hideColumn&#039;: {
                    value: function _hideColumn(col) {
                        var colIdx = gridState[gridId].columnIndices[col];
                        if (colIdx != null) {
                            gridState[gridId].columns[colIdx].isHidden = true;
                            var column = gridState[gridId].grid.find(&#039;.grid-header-wrapper&#039;).find(&#039;[data-field=&quot;&#039; + col + &#039;&quot;]&#039;),
                                columnIdx = column.data(&#039;index&#039;);
                            column.css(&#039;display&#039;, &#039;none&#039;);
                            gridState[gridId].grid.find(&#039;.grid-content-div&#039;).find(&#039;[data-field=&quot;&#039; + col + &#039;&quot;]&#039;).css(&#039;display&#039;, &#039;none&#039;);
                            var colGroups = gridState[gridId].grid.find(&#039;colgroup&#039;);
                            var group1 = $(colGroups[0]).find(&#039;col&#039;);
                            var group2 = $(colGroups[1]).find(&#039;col&#039;);
                            var offset = columnIdx;
                            if (gridState[gridId].drillDown)
                                ++offset;
                            if (gridState[gridId].groupedBy)
                                offset += gridState[gridId].groupedBy.length;
                            group1.eq(offset).remove();
                            group2.eq(offset).remove();
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;showColumn&#039;: {
                    value: function _showColumn(col) {
                        col = gridState[gridId].columnIndices[col];
                        if (gridState[gridId].columns[col] &amp;&amp; gridState[gridId].columns[col].isHidden) {
                            gridState[gridId].columns[col].isHidden = false;
                            gridState[gridId].grid.find(&#039;.grid-header-wrapper&#039;).find(&#039;[data-field=&quot;&#039; + col + &#039;&quot;]&#039;).css(&#039;display&#039;, &#039;&#039;);
                            gridState[gridId].grid.find(&#039;.grid-content-div&#039;).find(&#039;[data-field=&quot;&#039; + col + &#039;&quot;]&#039;).css(&#039;display&#039;, &#039;&#039;);
                            gridState[gridId].grid.find(&#039;colgroup&#039;).append(&#039;&lt;col&gt;&#039;);
                            setColWidth(gridState[gridId], gridState[gridId].grid);
                            copyGridWidth(gridState[gridId].grid);
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;addColumn&#039;: {
                    value: function _addColumn(column, data) {
                        if (typeof column !== &#039;object&#039; &amp;&amp; typeof column !== &#039;string&#039; || !data || !data.length)
                            return;
                        var field = typeof column === &#039;object&#039; ? column.field || &#039;field&#039; : column,
                            newCol;
                        if (!gridState[gridId].columnIndices[field]) {
                            for (var i = 0; i &lt; gridState[gridId].dataSource.data.length; i++) {
                                gridState[gridId].dataSource.data[i][field] = data[i] ? data[i] : null;
                            }
                            if (typeof column === &#039;object&#039;) newCol = column;
                            else {
                                newCol = {};
                            }
                            newCol.filterable = newCol.filterable || false;
                            newCol.editable = newCol.editable || false;
                            newCol.selectable = newCol.selectable ||false;
                            newCol.title = newCol.title || field;
                            newCol.type = newCol.type || &#039;string&#039;;

                            gridState[gridId].columns.push(newCol);
                            if (gridState[gridId].aggregates) gridState[gridId].aggregates[field] = {
                                type: newCol.type
                            };

                            gridState[gridId].hasAddedColumn = true;
                            gridState[gridId].grid.find(&#039;.grid-header-wrapper&#039;).empty();
                            createGridHeaders(gridState[gridId], gridElem);
                            gridState[gridId].grid.find(&#039;.grid-content-div&#039;).empty();
                            createGridContent(gridState[gridId], gridState[gridId].grid);
                            gridState[gridId].grid.find(&#039;.grid-footer-div&#039;).empty();
                            createGridFooter(gridState[gridId], gridState[gridId].grid);
                            buildHeaderAggregations(gridId);
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;addRow&#039;: {
                    value: function _addRow(data) {
                        var newModel = {}, prop;
                        if (!data) {
                            for (prop in gridState[gridId].dataSource.data[0]) {
                                if (prop !== &#039;_initialRowIndex&#039;) newModel[prop] = null;
                            }
                        }
                        else if (typeof data === &#039;object&#039;) {
                            for (prop in gridState[gridId].dataSource.data[0]) {
                                if (typeof data[prop] !== &#039;undefined&#039;) newModel[prop] = data[prop];
                                else newModel[prop] = null;
                            }
                        }
                        gridState[gridId].originalData.push(newModel);
                        var dataSourceModel = cloneGridData(newModel);
                        dataSourceModel._initialRowIndex = gridState[gridId].dataSource.data.length;
                        gridState[gridId].dataSource.data.push(dataSourceModel);
                        gridState[gridId].dataSource.rowCount++;

                        gridState[gridId].pageSize = gridState[gridId].pageSize + 1;
                        gridState[gridId].grid.find(&#039;.grid-content-div&#039;).empty();
                        createGridContent(gridState[gridId], gridState[gridId].grid);
                        gridState[gridId].grid.find(&#039;.grid-footer-div&#039;).empty();
                        createGridFooter(gridState[gridId], gridState[gridId].grid);
                        buildHeaderAggregations(gridId);
                    },
                    writable: false,
                    configurable: false
                },
                &#039;getAggregates&#039;: {
                    value: function _getAggregates() {
                        return gridState[gridId].gridAggregations;
                    },
                    writable: false,
                    configurable: false
                },
                &#039;getCurrentPageData&#039;: {
                    value: function _getCurrentPageData(index) {
                        var rows = [],
                            result = [],
                            tmpRowModel,
                            validRow;
                        if (typeof index === &#039;number&#039; &amp;&amp; index &gt; -1 &amp;&amp; index &lt;= gridState[gridId].dataSource.data.length) {
                            validRow = findValidRows(index);
                            if (validRow) rows.push(validRow);
                        }
                        else {
                            for (var i = 0; i &lt; gridState[gridId].pageSize; i++) {
                                validRow = findValidRows(i);
                                if (validRow) rows.push(validRow);
                            }
                        }

                        for (var j = 0; j &lt; rows.length; j++) {
                            tmpRowModel = {};
                            var cells = rows[j].find(&#039;td&#039;);
                            for (var k = 0; k &lt; cells.length; k++) {
                                tmpRowModel[$(cells[k]).data(&#039;field&#039;)] = $(cells[k]).text();
                            }
                            result.push(tmpRowModel);
                        }
                        return result;

                        function findValidRows(index) {
                            var counter = 0;
                            var row = null;
                            gridState[gridId].grid.find(&#039;.grid-content-div&#039;).find(&#039;table&#039;).find(&#039;tr&#039;).each(function iterateTableRowsCallback() {
                                if ($(this).hasClass(&#039;grouped_row_header&#039;))
                                    return true;
                                if (counter === index) {
                                    row = $(this);
                                    return false;
                                }
                                counter++;
                            });
                            return row;
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;getCurrentDataSourceData&#039;: {
                    value: function _getCurrentDataSourceData(index) {
                        var i;
                        if (typeof index === &#039;number&#039; &amp;&amp; index &gt; -1 &amp;&amp; index &lt;= gridState[gridId].dataSource.data.length) {
                            var val = cloneGridData([].concat(gridState[gridId].dataSource.data[index]));
                            delete val[0]._initialRowIndex;
                            return val;
                        }
                        else {
                            var gd = cloneGridData(gridState[gridId].dataSource.data);
                            for (i = 0; i &lt; gd.length; i++) {
                                delete gd[i]._initialRowIndex;
                            }
                            return gd;
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;updatePageData&#039;: {
                    value: function _updatePageData(data) {
                        if (data != null &amp;&amp; typeof data === &#039;object&#039; &amp;&amp; data.constructor === Array) {
                            gridState[gridId].dataSource.data = data;
                            gridState[gridId].pageSize = data.length;
                            gridState[gridId].dataSource.rowCount = data.length;
                            gridState[gridId].grid.find(&#039;.grid-content-div&#039;).empty();
                            createGridContent(gridState[gridId], gridState[gridId].grid);
                            gridState[gridId].grid.find(&#039;.grid-footer-div&#039;).empty();
                            createGridFooter(gridState[gridId], gridState[gridId].grid);
                            buildHeaderAggregations(gridId);
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;updateRowData&#039;: {
                    value: function _updateRowData(rowData) {
                        var appliedUpdate = false;
                        if (!rowData)
                            return;
                        if (rowData.constructor === Array) {
                            for (var i = 0; i &lt; rowData.length; i++) {
                                if (typeof rowData[i].index !== &#039;number&#039; || rowData[i].index &gt;= gridState[gridId].dataSource.data.length)
                                    continue;
                                gridState[gridId].dataSource.data[rowData[i].index] = rowData[i].data;
                                appliedUpdate = true;
                            }
                        }
                        else if (typeof rowData.index === &#039;number&#039;) {
                            gridState[gridId].dataSource.data[rowData.index] = rowData.data;
                            appliedUpdate = true;
                        }

                        if (appliedUpdate) {
                            gridState[gridId].grid.find(&#039;.grid-content-div&#039;).empty();
                            createGridContent(gridState[gridId], gridState[gridId].grid);
                            gridState[gridId].grid.find(&#039;.grid-footer-div&#039;).empty();
                            createGridFooter(gridState[gridId], gridState[gridId].grid);
                            buildHeaderAggregations(gridId);
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;updateCellData&#039;: {
                    value: function _updateCellData(cellData, setAsDirty) {
                        if (!cellData) return;
                        if (Array.isArray(cellData)) {
                            cellData.forEach(function cellIterationCallback(cell) {
                                applyUpdate(cell, setAsDirty);
                            });
                        }
                        else applyUpdate(cellData, setAsDirty);

                        function applyUpdate(cell, setAsDirty) {
                            if (typeof cell.index !== &#039;number&#039; || typeof cell.field !== &#039;string&#039; || cell.index &gt; gridState[gridId].dataSource.data.length)
                                return;
                            var column = gridState[gridId].columns[gridState[gridId].columnIndices[cell.field]];
                            if (column) {
                                var dataType = column.type;
                                if (!dataType)
                                    dataType = &#039;string&#039;;
                                if (dataType !== &#039;time&#039; &amp;&amp; dataType !== &#039;date&#039; &amp;&amp; dataType !== &#039;datetime&#039;) {
                                    if (typeof cell.value !== dataType)
                                        return;
                                }
                                else {
                                    var re = new RegExp(dataTypes[dataType]);
                                    if (!re.test(cell.value)) return;
                                }
                                gridState[gridId].dataSource.data[cell.index][cell.field] = cell.value;
                                var tableCell;
                                if (gridState[gridId].groupedBy) {
                                    var counter = 0;
                                    gridState[gridId].grid.find(&#039;.grid-content-div&#039;).find(&#039;table&#039;).find(&#039;tr&#039;).each(function iterateTableRowsCallback() {
                                        if ($(this).hasClass(&#039;grouped_row_header&#039;))
                                            return true;
                                        if (counter === cell.index) {
                                            tableCell = $(this).find(&#039;[data-field=&quot;&#039; + cell.field + &#039;&quot;]&#039;);
                                            return false;
                                        }
                                        counter++;
                                    });
                                }
                                else
                                    tableCell = gridState[gridId].grid.find(&#039;.grid-content-div&#039;).find(&#039;table&#039;).find(&#039;tr:nth-child(&#039; + (cell.index + 1) + &#039;)&#039;).find(&#039;[data-field=&quot;&#039; + cell.field + &#039;&quot;]&#039;);
                                var text = getFormattedCellText(column, cell.value) || cell.value;
                                tableCell.text(text);
                                if (setAsDirty) tableCell.prepend(&#039;&lt;span class=&quot;dirty&quot;&gt;&lt;/span&gt;&#039;);
                            }
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;destroy&#039;: {
                    value: function _destroy() {
                        findChildren(gridState[gridId].grid.children());
                        delete gridState[gridId];

                        function findChildren(nodes) {
                            for (var i = 0; i &lt; nodes.length; i++) {
                                var child = $(nodes[i]);
                                while (child.children().length)
                                    findChildren(child.children());
                                child.off();
                                child.remove();
                            }
                        }
                    },
                    writable: false,
                    configurable: false
                },
                &#039;removeSelection&#039;: {
                    value: function _removeSelection() {
                        gridElem.find(&#039;.selected&#039;).each(function removeSelectedClass(idx, val) {
                            $(val).removeClass(&#039;selected&#039;);
                        });
                    },
                    writable: false,
                    configurable: false
                },
                &#039;exportToExcel&#039;: {
                    value: function _exportToExcel(exportType) {
                        exportDataAsExcelFile(gridId, exportType || &#039;page&#039;);
                    }
                },
                &#039;activeCellData&#039;: {
                    get: function _getActiveCellData() {
                        var cell = gridElem.find(&#039;.active-cell&#039;);
                        if (!cell.length)
                            return null;
                        var field = cell.parents(&#039;td&#039;).data(&#039;field&#039;);
                        var colIndex = cell.parents(&#039;.grid-wrapper&#039;).find(&#039;.grid-header-wrapper&#039;).find(&#039;.grid-headerRow&#039;).children(&#039;[data-field=&quot;&#039; + field + &#039;&quot;]&#039;).data(&#039;index&#039;);
                        if (cell[0].type === &#039;checkbox&#039;)
                            return { data: cell[0].checked, row: cell.parents(&#039;tr&#039;).index(), column: colIndex, field: field };
                        return { data: cell.val(), row: cell.parents(&#039;tr&#039;).index(), column: colIndex, field: field, cell: cell.parents(&#039;td&#039;)[0] };
                    },
                    configurable: false
                },
                &#039;selected&#039;: {
                    get: function _getSelectedItems() {
                        var selectedItems = [];
                        gridElem.find(&#039;.selected&#039;).each(function iteratedSelectedGridItems(idx, val) {
                            selectedItems.push(val);
                        });
                        return selectedItems;
                    },
                    set: function _setSelectedItems(itemArray) {
                        if (!itemArray || itemArray.constructor !== Array) return;
                        for (var i = 0; i &lt; itemArray.length; i++) {
                            if (typeof itemArray[i].rowIndex !== &#039;number&#039;) continue;
                            var row = gridElem.find(&#039;.grid-content-div&#039;).find(&#039;tbody&#039;).children(&#039;tr:nth-child(&#039; + (itemArray[i].rowIndex + 1) + &#039;)&#039;);
                            if (typeof itemArray[i].columnIndex === &#039;number&#039;) {
                                row.children(&#039;td:nth-child(&#039; + (itemArray[i].columnIndex + 1) + &#039;)&#039;).addClass(&#039;selected&#039;);
                            }
                            else
                                row.addClass(&#039;selected&#039;);
                        }
                    },
                    configurable: false
                },
                &#039;selectedData&#039;: {
                    get: function _getSelectedGridItemData() {
                        var data = [];
                        gridElem.find(&#039;.selected&#039;).each(function getSelectedElementData(index, value) {
                            var item = $(value);
                            if (value.tagName.toLowerCase() === &#039;tr&#039;) {
                                var rowIndex = item.index();
                                $(value).children().each(function iterateTableCells(idx, val) {
                                    var cell = $(val);
                                    data.push({ rowIndex: rowIndex, columnIndex: cell.index(), data: cell.text(), field: cell.data(&#039;field&#039;) });
                                });
                            }
                            else {
                                data.push({ rowIndex: item.parents(&#039;tr&#039;).index(), columnIndex: item.index(), data: item.text(), field: item.data(&#039;field&#039;) });
                            }
                        });
                        return data;
                    },
                    configurable: false
                }
            });

        var keys = Object.getOwnPropertyNames(gridElem[0].grid);
        for (var i = 0; i &lt; keys.length; i++) {
            Object.preventExtensions(gridElem[0].grid[keys[i]]);
        }
    }

    function getInitialGridData(dataSource, pageSize, callback) {
        if (dataSource &amp;&amp; typeof dataSource.data === &#039;object&#039;)
            callback(null, { data: dataSource.data, rowCount: dataSource.rowCount });
        else if (typeof dataSource.get == &#039;function&#039;) {
            dataSource.get({ pageSize: pageSize, pageNum: 1 },
                function gridDataCallback(data) {
                    if (data) callback(null, data);
                    else callback(true, {});
                });
        }
        else callback(true, {});
    }

    function initializeGrid(id, gridData, gridElem) {
        var storageData = cloneGridData(gridData);
        storageData.events = {
            beforeCellEdit: typeof storageData.beforeCellEdit === &#039;object&#039; &amp;&amp; storageData.beforeCellEdit.constructor === Array ? storageData.beforeCellEdit : [],
            cellEditChange: typeof storageData.cellEditChange === &#039;object&#039; &amp;&amp; storageData.cellEditChange.constructor === Array ? storageData.cellEditChange : [],
            afterCellEdit: typeof storageData.afterCellEdit === &#039;object&#039; &amp;&amp; storageData.afterCellEdit.constructor === Array ? storageData.afterCellEdit : [],
            pageRequested: typeof storageData.pageRequested === &#039;object&#039; &amp;&amp; storageData.pageRequested.constructor === Array ? storageData.pageRequested : [],
            beforeDataBind: typeof storageData.beforeDataBind === &#039;object&#039; &amp;&amp; storageData.beforeDataBind.constructor === Array ? storageData.beforeDataBind : [],
            afterDataBind: typeof storageData.afterDataBind === &#039;object&#039; &amp;&amp; storageData.afterDataBind.constructor === Array ? storageData.afterDataBind : [],
            columnReorder: typeof storageData.columnReorder === &#039;object&#039; &amp;&amp; storageData.columnReorder.constructor === Array ? storageData.columnReorder : []
        };

        Object.keys(storageData.events).forEach(function setEvtHandlers(evt) {
            storageData.events[evt] = storageData.events[evt].map(function mapEventsCallback(fn) {
                if (typeof fn == &#039;function&#039;) return fn;
            });
        });

        delete storageData.beforeCellEdit;
        delete storageData.cellEditChange;
        delete storageData.afterCellEdit;
        delete storageData.pageRequested;
        delete storageData.beforeDataBind;
        delete storageData.afterDataBind;
        delete storageData.columnReorder;

        storageData.originalData = cloneGridData(gridData.dataSource.data);
        storageData.pageNum = 1;
        storageData.pageSize = gridData.pageSize || 25;
        storageData.grid = gridElem;
        storageData.currentEdit = {};
        storageData.pageRequest = {};
        storageData.putRequest = {};
        storageData.resizing = false;
        storageData.sortedOn = [];
        storageData.basicFilters = { conjunct: &#039;and&#039;, filterGroup: null };
        storageData.advancedFilters = {};
        storageData.filters = {};
        storageData.groupedBy = [];
        storageData.gridAggregations = {};
        storageData.advancedFiltering = storageData.filterable ? storageData.advancedFiltering : false;
        if (storageData.advancedFiltering) {
            storageData.advancedFiltering.groupsCount = isInteger(storageData.advancedFiltering.groupsCount) ? storageData.advancedFiltering.groupsCount : 5;
            storageData.advancedFiltering.filtersCount = isInteger(storageData.advancedFiltering.filtersCount) ? storageData.advancedFiltering.filtersCount : 10;
        }
        storageData.parentGridId = gridData.parentGridId != null ? gridData.parentGridId : null;
        if (storageData.dataSource.rowCount == null) storageData.dataSource.rowCount = gridData.dataSource.data.length;

        var eventObj = { element: storageData.grid };
        callGridEventHandlers(storageData.events.beforeDataBind, storageData.grid, eventObj);

        gridState[id] = storageData;
        if (gridData.aggregates &amp;&amp; typeof gridData.dataSource.get === &#039;function&#039;) {
            constructAggregationsFromServer(id, storageData.gridAggregations);
            buildHeaderAggregations(id);
        }

        createGridFooter(storageData, gridElem);
        createGridContent(storageData, gridElem);
        callGridEventHandlers(storageData.events.afterDataBind, storageData.grid, eventObj);
    }

    function createGridHeaders(gridData, gridElem) {
        var gridHeader = gridElem.find(&#039;.grid-header-div&#039;),
            gridHeadWrap = gridHeader.find(&#039;.grid-header-wrapper&#039;),
            headerTable = $(&#039;&lt;table&gt;&lt;/table&gt;&#039;).appendTo(gridHeadWrap);
        headerTable.css(&#039;width&#039;,&#039;auto&#039;);
        var colgroup = $(&#039;&lt;colgroup&gt;&lt;/colgroup&gt;&#039;).appendTo(headerTable),
            headerTHead = $(&#039;&lt;thead&gt;&lt;/thead&gt;&#039;).appendTo(headerTable),
            headerRow = $(&#039;&lt;tr class=grid-headerRow&gt;&lt;/tr&gt;&#039;).appendTo(headerTHead),
            id = gridHeader.data(&#039;grid_header_id&#039;);

        if (gridData.groupedBy &amp;&amp; gridData.groupedBy.length) {
            gridData.groupedBy.forEach(function _createGroupingCols() {
                colgroup.prepend(&#039;&lt;col class=&quot;group_col&quot;/&gt;&#039;);
                headerRow.prepend(&#039;&lt;th class=&quot;group_spacer&quot;&gt;&amp;nbsp&lt;/th&gt;&#039;);
            });
        }

        if (gridData.drillDown) {
            colgroup.prepend(&#039;&lt;col class=&quot;groupCol&quot;/&gt;&#039;);
            headerRow.prepend(&#039;&lt;th class=&quot;group_spacer&quot;&gt;&amp;nbsp&lt;/th&gt;&#039;);
        }

        gridData.columns.forEach(function _createColumnHeaders(col, idx) {
            if (typeof col !== &#039;object&#039;) return;
            $(&#039;&lt;col/&gt;&#039;).appendTo(colgroup);
            var text = col.title || col.field,
                th = $(&#039;&lt;th id=&quot;&#039; + col.field + &#039;_grid_id_&#039; + id + &#039;&quot; data-field=&quot;&#039; + col.field + &#039;&quot; data-index=&quot;&#039; + idx + &#039;&quot; class=grid-header-cell&gt;&lt;/th&gt;&#039;).appendTo(headerRow);

            if (typeof col.attributes === &#039;object&#039; &amp;&amp; col.attributes.headerClasses &amp;&amp; col.attributes.headerClasses.constructor ===  Array) {
                col.attributes.headerClasses.forEach(function _applyHeaderClasses(className) {
                    th.addClass(className);
                });
            }

            if (col.type !== &#039;custom&#039;) {
                if (gridData.sortable === true &amp;&amp; (typeof col.sortable === &#039;undefined&#039; || col.sortable === true)) {
                    setSortableClickListener(th);
                    gridData.sortable = true;
                }

                if (col.filterable === true) {
                    setFilterableClickListener(th, gridData, col.field);
                    gridData.filterable = true;
                    gridData.advancedFiltering = gridData.advancedFiltering != null ? gridData.advancedFiltering : false;
                }

                if ((col.editable || gridData.selectable || gridData.groupable || gridData.columnToggle || gridData.excelExport || gridData.advancedFiltering))
                    createGridToolbar(gridData, gridElem, col.editable);

                $(&#039;&lt;a class=&quot;header-anchor&quot; href=&quot;#&quot;&gt;&lt;/a&gt;&#039;).appendTo(th).text(text);
            }
            else
                $(&#039;&lt;span class=&quot;header-anchor&quot;&gt;&lt;/span&gt;&#039;).appendTo(th).text(text);

            if (gridData.resizable) {
                th.on(&#039;mouseleave&#039;, mouseLeaveHandlerCallback);
            }
            if (gridData.reorderable === true &amp;&amp; (typeof col.reorderable === &#039;undefined&#039; || col.reorderable === true)) {
                th.prop(&#039;draggable&#039;, true);
                setDragAndDropListeners(th);
            }
        });
        headerTable.css(&#039;width&#039;,&#039;&#039;);
        setColWidth(gridData, gridElem);

        var gridContent = gridElem.find(&#039;.grid-content-div&#039;).css(&#039;height&#039;, gridData.height || 400),
            gcOffsets = gridContent.offset(),
            top = gcOffsets.top + (gridContent.height()/2) + $(window).scrollTop(),
            left = gcOffsets.left + (gridContent.width()/2) + $(window).scrollLeft();
            $(&#039;&lt;span id=&quot;loader-span_&#039; + id + &#039;&quot; class=&quot;spinner&quot;&gt;&lt;/span&gt;&#039;).appendTo(gridContent).css(&#039;top&#039;, top).css(&#039;left&#039;, left);
    }

    function buildHeaderAggregations(gridId) {
        var gridData = gridState[gridId],
            i;
        if (typeof gridState[gridId].dataSource.get !== &#039;function&#039;) {
            var dataToFilter = gridData.alteredData &amp;&amp; gridData.alteredData.length ? gridData.alteredData : gridData.originalData,
                remRows = dataToFilter.filter(function getRemainingRows(val, idx) {
                    return idx &gt; gridData.pageNum * gridData.pageSize - 1 || idx &lt; gridData.pageNum * gridData.pageSize - gridData.pageSize;
                });

            remRows.forEach(function _iterateRemainingRows(row) {
                gridData.columns.forEach(function _addColumnValsToAggregates(col) {
                    if (gridData.aggregates[col.field])
                        addValueToAggregations(gridId, col.field, row[col.field], gridData.gridAggregations);
                });
            });
        }

        var aggrs = gridData.gridAggregations;
        if (aggrs) {
            var headerTHead = $(&#039;#grid-header-&#039; + gridId).find(&#039;thead&#039;);
            var aggRow = headerTHead.find(&#039;.summary-row-header&#039;);
            if (aggRow.length)
                aggRow.remove();
            aggRow = $(&#039;&lt;tr class=summary-row-header&gt;&lt;/tr&gt;&#039;).appendTo(headerTHead);
            if (gridData.groupedBy.length) {
                for (i = 0; i &lt; gridData.groupedBy.length; i++) {
                    aggRow.append(&#039;&lt;td class=&quot;group_spacer&quot;&gt;&amp;nbsp&lt;/td&gt;&#039;);
                }
            }
            if (gridData.drillDown) {
                aggRow.append(&#039;&lt;td class=&quot;group_spacer&quot;&gt;&amp;nbsp&lt;/td&gt;&#039;);
            }
            gridData.columns.forEach(function _createAggregates(col) {
                var text = &#039;&#039;;
                if (col.field in aggrs) text = aggrs[col.field].text || &#039;&#039;;
                aggRow.append(&#039;&lt;td data-field=&quot;&#039; + col.field + &#039;&quot; class=summary-cell-header&gt;&#039; + text + &#039;&lt;/td&gt;&#039;);
            });
        }
    }

    function createGridContent(gridData, gridElem) {
        var gridContent = gridElem.find(&#039;.grid-content-div&#039;),
            id = gridContent.data(&#039;grid_content_id&#039;),
            contentTable = $(&#039;&lt;table id=&quot;&#039; + gridElem[0].id + &#039;_content&quot; style=&quot;height:auto;&quot;&gt;&lt;/table&gt;&#039;).appendTo(gridContent),
            colGroup = $(&#039;&lt;colgroup&gt;&lt;/colgroup&gt;&#039;).appendTo(contentTable),
            contentTBody = $(&#039;&lt;tbody&gt;&lt;/tbody&gt;&#039;).appendTo(contentTable),
            text, i, item;
        contentTBody.css(&#039;width&#039;, &#039;auto&#039;);
        if (typeof gridData.parentGridId !== &#039;number&#039; &amp;&amp; gridData.selectable) attachTableSelectHandler(contentTBody);

        var rowEnd = gridData.pageSize &gt; gridData.dataSource.data.length ? gridData.dataSource.data.length : gridData.pageSize,
            rows = gridData.rows,
            currentGroupingValues = {};

        if (gridData.groupAggregates) gridData.groupAggregations = {};

        if (gridData.dataSource.data.length) {
            for (i = 0; i &lt; rowEnd; i++) {
                gridData.dataSource.data[i]._initialRowIndex = i;
                if (gridData.groupedBy &amp;&amp; gridData.groupedBy.length) createGroupedRows(id, i, currentGroupingValues, contentTBody);

                var tr = $(&#039;&lt;tr class=&quot;data-row&quot;&gt;&lt;/tr&gt;&#039;).appendTo(contentTBody);
                if (typeof gridData.parentGridId === &#039;number&#039;) tr.addClass(&#039;drill-down-row&#039;);
                if (i % 2) {
                    tr.addClass(&#039;alt-row&#039;);
                    if (rows &amp;&amp; rows.alternateRows &amp;&amp; rows.alternateRows.constructor === Array)
                        rows.alternateRows.forEach(function _addAlternateRowClasses(className) {
                            tr.addClass(className);
                        });
                }

                if (rows &amp;&amp; rows.all &amp;&amp; rows.all.constructor === Array) {
                    rows.all.forEach(function _addRowClasses(className) {
                        tr.addClass(className);
                    });
                }

                if (gridData.groupedBy.length) {
                    gridData.groupedBy.forEach(function _appendGroupingCells() {
                        tr.append(&#039;&lt;td class=&quot;grouped_cell&quot;&gt;&amp;nbsp&lt;/td&gt;&#039;);
                    });
                }

                if (gridData.drillDown)
                    tr.append(&#039;&lt;td class=&quot;drillDown_cell&quot;&gt;&lt;span class=&quot;drillDown_span&quot; data-state=&quot;closed&quot;&gt;&lt;a class=&quot;drillDown-asc drillDown_acc&quot;&gt;&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;&#039;);

                gridData.columns.forEach(function _createGridCells(col) {
                    var td = $(&#039;&lt;td data-field=&quot;&#039; + col.field + &#039;&quot; class=&quot;grid-content-cell&quot;&gt;&lt;/td&gt;&#039;).appendTo(tr);
                    if (col.attributes &amp;&amp; col.attributes.cellClasses &amp;&amp; col.attributes.cellClasses.constructor === Array) {
                        col.attributes.cellClasses.forEach(function _addColumnClasses(className) {
                            td.addClass(className);
                        });
                    }
                    if (col.type !== &#039;custom&#039;) {
                        text = getFormattedCellText(col, gridData.dataSource.data[i][col.field]) || gridData.dataSource.data[i][col.field];
                        text = text == null ? &#039;Null&#039; : text;
                        td.text(text);
                    }
                    else {
                        td = col.html ? $(col.html).appendTo(td) : td;
                        if (col.class)
                            td.addClass(col.class);
                        if (col.text) {
                            var customText;
                            if (typeof col.text === &#039;function&#039;) {
                                col.text(gridData.originalData[gridData.dataSource.data[i]._initialRowIndex]);
                            }
                            else customText = col.text;
                            td.text(customText);
                        }
                    }

                    if (typeof col.events === &#039;object&#039;) {
                        attachCustomCellHandler(col, td, id);
                    }
                    if (gridData.aggregates &amp;&amp; gridData.aggregates[col.field] &amp;&amp; typeof gridData.dataSource.get !== &#039;function&#039;) {
                        if (gridData.pageRequest.eventType === &#039;filter&#039; || gridData.pageRequest.eventType === undefined)
                            addValueToAggregations(id, col.field, gridData.dataSource.data[i][col.field], gridData.gridAggregations);
                    }
                    if (typeof gridData.parentGridId !== &#039;number&#039; &amp;&amp; (col.editable &amp;&amp; col.editable !== &#039;drop-down&#039;)) {
                        makeCellEditable(id, td);
                        gridState[id].editable = true;
                    }
                    else if (typeof gridData.parentGridId !== &#039;number&#039; &amp;&amp; (col.editable === &#039;drop-down&#039;)) {
                        makeCellSelectable(id, td);
                        gridState[id].editable = true;
                    }
                });
            }

            gridData.columns.forEach(function appendCols() { colGroup.append(&#039;&lt;col/&gt;&#039;); });
            gridData.groupedBy.forEach(function _prependCols() { colGroup.prepend(&#039;&lt;col class=&quot;group_col&quot;/&gt;&#039;); });
            if (gridData.drillDown) colGroup.prepend(&#039;&lt;col class=&quot;groupCol&quot;/&gt;&#039;);

            if (gridData.aggregates &amp;&amp; gridData.aggregates.positionAt === &#039;top&#039; &amp;&amp; typeof gridData.dataSource.get !== &#039;function&#039; &amp;&amp;
                (gridData.pageRequest.eventType === &#039;filter&#039; || gridData.pageRequest.eventType === undefined))
                buildHeaderAggregations(id);

            if (gridData.aggregates &amp;&amp; gridData.aggregates.positionAt === &#039;bottom&#039;) {
                var aggrs = gridState[id].gridAggregations;
                if (aggrs) {
                    var aggRow = $(&#039;&lt;tr class=&quot;summary-row-footer&quot;&gt;&lt;/tr&gt;&#039;).appendTo(contentTBody);
                    if (gridState[id].groupedBy.length) {
                        gridState[id].groupedBy.forEach(function _appendGroupSpacers() {
                            aggRow.append(&#039;&lt;td class=&quot;group_spacer&quot;&gt;&amp;nbsp&lt;/td&gt;&#039;);
                        });
                    }
                    for (item in aggrs) {
                        text = aggrs[item].value || &#039;&#039;;
                        aggRow.append(&#039;&lt;td data-field=&quot;&#039; + item + &#039;&quot; class=summary-cell-header&gt;&#039; + text + &#039;&lt;/td&gt;&#039;);
                    }
                }
            }

            createGroupTrEventHandlers(id);
            attachDrillDownAccordionHandler(id);
        }

        gridContent[0].addEventListener(&#039;scroll&#039;, function contentDivScrollHandler() {
            var headWrap = gridContent.parents(&#039;.grid-wrapper&#039;).first().find(&#039;.grid-header-wrapper&#039;);
            if (gridState[id].resizing) return;
            headWrap.scrollLeft(gridContent.scrollLeft());
        });

        var headerId = &#039;grid-header-&#039; + gridContent.data(&#039;grid_content_id&#039;);
        var headDiv = $(&#039;#&#039; + headerId);
        var sizeDiff = headDiv[0].clientWidth - gridContent[0].clientWidth;
        headDiv.css(&#039;paddingRight&#039;, sizeDiff);

        copyGridWidth(gridElem);

        gridState[id].dataSource.data = gridData.dataSource.data;
        gridContent.find(&#039;#loader-span_&#039; + id).remove();
        gridState[id].updating = false;
    }

    function attachCustomCellHandler(column, cellItem, gridId) {
        Object.keys(column.events).forEach(function _attachColumnEventHandlers(evt) {
            if (typeof column.events[evt] === &#039;function&#039;) createEventHandler(cellItem, evt, column.events[evt]);
        });

        function createEventHandler(cellItem, eventName, eventHandler) {
            cellItem.on(eventName, function genericEventHandler() {
                var row = $(this).parents(&#039;tr&#039;),
                    rowIdx = row.index();
                eventHandler.call(this, gridState[gridId].dataSource.data[rowIdx]);
            });
        }
    }

    function createGroupedRows(gridId, rowIndex, currentGroupingValues, gridContent) {
        var j, k,
            foundDiff = false,
            groupedDiff = [],
            gridData = gridState[gridId];
        for (j = 0; j &lt; gridData.groupedBy.length; j++) {
            if (!currentGroupingValues[gridData.groupedBy[j].field] || currentGroupingValues[gridData.groupedBy[j].field] !== gridData.dataSource.data[rowIndex][gridData.groupedBy[j].field]) {
                currentGroupingValues[gridData.groupedBy[j].field] = gridData.dataSource.data[rowIndex][gridData.groupedBy[j].field];
                groupedDiff[j] = 1;
                foundDiff = true;
            }
            else {
                if (!j || !groupedDiff[j - 1]) groupedDiff[j] = 0;
                else groupedDiff[j] = 1;
            }
        }
        if (foundDiff &amp;&amp; rowIndex &amp;&amp; gridData.groupAggregates) {   
            for (j = groupedDiff.length - 1; j &gt;= 0; j--) {     
                var numItems = gridData.groupAggregations[j]._items_; 
                if (groupedDiff[j]) {                               
                    var groupAggregateRow = $(&#039;&lt;tr class=&quot;grouped_row_header&quot;&gt;&lt;/tr&gt;&#039;).appendTo(gridContent);
                    for (k = 0; k &lt; groupedDiff.length; k++) {
                        groupAggregateRow.append(&#039;&lt;td colspan=&quot;&#039; + 1 + &#039;&quot; class=&quot;grouped_cell&quot;&gt;&lt;/td&gt;&#039;);
                    }
                    if (gridData.drillDown)
                        groupAggregateRow.append(&#039;&lt;td colspan=&quot;1&quot; class=&quot;grouped_cell&quot;&gt;&lt;/td&gt;&#039;);
                    gridData.columns.forEach(function _createAggregateCells(col) {
                        if (col.field in gridData.groupAggregations[j] &amp;&amp; col.field !== &#039;_items_&#039;){
                            groupAggregateRow.append(&#039;&lt;td class=&quot;group_aggregate_cell&quot;&gt;&#039; + (gridData.groupAggregations[j][col.field].text || &#039;&#039;) + &#039;&lt;/td&gt;&#039;);
                        }
                        else
                            groupAggregateRow.append(&#039;&lt;td class=&quot;group_aggregate_cell&quot;&gt; &lt;/td&gt;&#039;);
                    });
                    gridData.groupAggregations[j] = {       
                        _items_: 0
                    };
                    for (k = j - 1; k &gt;= 0; k--) {  
                        if (groupedDiff[k] &amp;&amp; gridData.groupAggregations[k]._items_ == numItems) {    
                            groupedDiff[k] = 0;
                            gridData.groupAggregations[k] = {
                                _items_: 0
                            };
                        }
                    }
                }
            }
        }
        for (j = 0; j &lt; groupedDiff.length; j++) {
            if (gridData.groupAggregates) {
                if (gridData.groupAggregations &amp;&amp; !gridData.groupAggregations[j]) {
                    gridData.groupAggregations[j] = {
                        _items_: 0
                    };
                }
                gridData.columns.forEach(function _aggregateValues(col) {
                    if (gridData.aggregates &amp;&amp; gridData.aggregates[col.field])
                        addValueToAggregations(gridId, col.field, gridData.dataSource.data[rowIndex][col.field], gridData.groupAggregations[j]);
                });
                gridData.groupAggregations[j]._items_++;
            }
            if (groupedDiff[j]) {
                var groupedText = getFormattedCellText(gridData.columns[gridData.columnIndices[gridData.groupedBy[j].field]], gridData.dataSource.data[rowIndex][gridData.groupedBy[j].field]) ||
                    gridData.dataSource.data[rowIndex][gridData.groupedBy[j].field];
                var groupTr = $(&#039;&lt;tr class=&quot;grouped_row_header&quot;&gt;&lt;/tr&gt;&#039;).appendTo(gridContent);
                var groupTitle = gridData.columns[gridData.columnIndices[gridData.groupedBy[j].field]].title || gridData.groupedBy[j].field;
                for (k = 0; k &lt;= j; k++) {
                    var indent = k === j ? (gridData.columns.length + gridData.groupedBy.length - k) : 1;
                    if (gridData.drillDown) ++indent;
                    groupTr.data(&#039;group-indent&#039;, indent);
                    var groupingCell = $(&#039;&lt;td colspan=&quot;&#039; + indent + &#039;&quot; class=&quot;grouped_cell&quot;&gt;&lt;/td&gt;&#039;).appendTo(groupTr);
                    if (k === j) {
                        groupingCell.append(&#039;&lt;p class=&quot;grouped&quot;&gt;&lt;a class=&quot;group-desc sortSpan group_acc_link&quot; data-state=&quot;open&quot;&gt;&lt;/a&gt;&#039; + groupTitle + &#039;: &#039; + groupedText + &#039;&lt;/p&gt;&#039;);
                        break;
                    }
                }
            }
        }
    }

    function attachDrillDownAccordionHandler(gridId) {
        var gridData = gridState[gridId];
        gridData.grid.find(&#039;.drillDown_span&#039;).on(&#039;click&#039;, function drillDownAccordionHandler() {
            var accRow = $(this).parents(&#039;tr&#039;),
                accRowIdx = gridData.grid.find(&#039;.data-row&#039;).not(&#039;.drill-down-row&#039;).index(accRow);
            if (accRow.find(&#039;.drillDown_span&#039;).data(&#039;state&#039;) === &#039;open&#039;) {
                accRow.find(&#039;.drillDown_span&#039;).data(&#039;state&#039;, &#039;closed&#039;);
                accRow.next().css(&#039;display&#039;, &#039;none&#039;);
            }
            else {
                if (accRow.next().hasClass(&#039;drill-down-parent&#039;)) {
                    accRow.find(&#039;.drillDown_span&#039;).data(&#039;state&#039;, &#039;open&#039;);
                    accRow.next().css(&#039;display&#039;, &#039;inline-block&#039;);
                }
                else {
                    var drillDownRow = $(&#039;&lt;tr class=&quot;drill-down-parent&quot;&gt;&lt;/tr&gt;&#039;).insertAfter(accRow);
                    if (gridData.groupedBy &amp;&amp; gridData.groupedBy.length) {
                        for (var i = 0; i &lt; gridData.groupedBy.length; i++) {
                            drillDownRow.append(&#039;&lt;td class=&quot;grouped_cell&quot;&gt;&lt;/td&gt;&#039;);
                        }
                    }
                    drillDownRow.append(&#039;&lt;td class=&quot;grouped_cell&quot;&gt;&lt;/td&gt;&#039;);
                    var drillDownCellLength = 0;
                    gridData.grid.find(&#039;.grid-header-div&#039;).find(&#039;col&#039;).each(function getTotalGridLength() {
                        if (!$(this).hasClass(&#039;groupCol&#039;))
                            drillDownCellLength += $(this).width();
                    });
                    var containerCell = $(&#039;&lt;td class=&quot;drill-down-cell&quot; colspan=&quot;&#039; + gridData.columns.length + &#039;&quot; style=&quot;width: &#039; + drillDownCellLength + &#039;;&quot;&gt;&lt;/td&gt;&#039;).appendTo(drillDownRow),
                        newGridId = gridData.grid[0].id + generateId(),
                        gridDiv = $(&#039;&lt;div id=&quot;&#039; + newGridId + &#039;&quot; class=&quot;drill_down_grid&quot;&gt;&lt;/div&gt;&#039;).appendTo(containerCell);
                    accRow.find(&#039;.drillDown_span&#039;).data(&#039;state&#039;, &#039;open&#039;);
                    var parentRowData = gridData.grid[0].grid.getCurrentDataSourceData(accRowIdx);

                    if (typeof gridData.drillDown === &#039;function&#039;) {
                        drillDownCreate(gridData.drillDown(accRowIdx, parentRowData[0]), gridDiv[0], gridId);
                    }
                    else if (typeof gridData.drillDown === &#039;object&#039;) {
                        if (!gridData.drillDown.dataSource) gridData.drillDown.dataSource = {};
                        gridData.drillDown.dataSource.data = parentRowData[0].drillDownData;
                        gridData.drillDown.dataSource.rowCount = parentRowData[0].drillDownData ? parentRowData[0].drillDownData.length : 0;
                        drillDownCreate(gridData.drillDown, gridDiv[0], gridId);
                    }
                }
            }
        });
    }

    function constructAggregationsFromServer(gridId, aggregationObj) {
        gridState[gridId].columns.forEach(function _constructAggregationsFromServer(col) {
            if (!aggregationObj[col.field]) aggregationObj[col.field] = {};
            if (!gridState[gridId].aggregates[col.field]) {
                aggregationObj[col.field] = &#039;&#039;;
                return;
            }
            if (typeof gridState[gridId].dataSource.get === &#039;function&#039;) {
                if (gridState[gridId].aggregates[col.field].type &amp;&amp; gridState[gridId].aggregates[col.field].value) {
                    var text = getFormattedCellText(col, gridState[gridId].aggregates[col.field].value) || gridState[gridId].aggregates[col.field].value;
                    aggregationObj[col.field].text = aggregates[gridState[gridId].aggregates[col.field].type] + text;
                }
                else aggregationObj[col.field].text = null;
            }
        });
    }

    function addValueToAggregations(gridId, field, value, aggregationObj) {
        var text, total,
            column = gridState[gridId].columns[gridState[gridId].columnIndices[field]];
        if (!aggregationObj[field]) aggregationObj[field] = {};
        if (value == null) return;
        switch (gridState[gridId].aggregates[field].type) {
            case &#039;count&#039;:
                aggregationObj[field].value = gridState[gridId].dataSource.rowCount || gridState[gridId].dataSource.data.length;
                aggregationObj[field].text = aggregates[gridState[gridId].aggregates[field].type] + aggregationObj[field].value;
                return;
            case &#039;average&#039;:
                var count = aggregationObj[field].count ? aggregationObj[field].count + 1 : 1;
                value = parseFloat(value.toString());
                total = aggregationObj[field].total ? aggregationObj[field].total + value : value;
                var avg = total/count;
                text = getFormattedCellText(column, avg.toFixed(2)) || avg.toFixed(2);
                aggregationObj[field].total = total;
                aggregationObj[field].count = count;
                aggregationObj[field].text = aggregates[gridState[gridId].aggregates[field].type] + text;
                aggregationObj[field].value = avg;
                return;
            case &#039;max&#039;:
                if (!aggregationObj[field].value || parseFloat(aggregationObj[field].value) &lt; parseFloat(value.toString())) {
                    text = getFormattedCellText(column, value) || value;
                    aggregationObj[field].text = aggregates[gridState[gridId].aggregates[field].type] + text;
                    aggregationObj[field].value = value;
                }
                return;
            case &#039;min&#039;:
                if (!aggregationObj[field].value || parseFloat(aggregationObj[field].value) &gt; parseFloat(value.toString())) {
                    text = getFormattedCellText(column, value) || value;
                    aggregationObj[field].text = aggregates[gridState[gridId].aggregates[field].type] + text;
                    aggregationObj[field].value = text;
                }
                return;
            case &#039;total&#039;:
                total = (parseFloat(aggregationObj[field].total) || 0) + parseFloat(value);
                text = getFormattedCellText(column, total) || total;
                aggregationObj[field].total = total;
                aggregationObj[field].text = aggregates[gridState[gridId].aggregates[field].type] + text;
                aggregationObj[field].value = text;
                return;
            default:
                aggregationObj[field].text = null;
        }
    }

    function attachTableSelectHandler(tableBody) {
        var gridId = tableBody.parents(&#039;.grid-wrapper&#039;).data(&#039;grid_id&#039;);
        var isSelectable = gridState[gridId].selectable;
        if (isSelectable) {
            $(document).on(&#039;click&#039;, function tableBodySelectCallback(e) {
                if (e.target === tableBody[0] || $(e.target).parents(&#039;tbody&#039;)[0] === tableBody[0]) {
                    if (gridState[gridId].selecting) {
                        gridState[gridId].selecting = false;
                        return;
                    }
                    gridState[gridId].grid.find(&#039;.selected&#039;).each(function iterateSelectedItemsCallback(idx, elem) {
                        $(elem).removeClass(&#039;selected&#039;);
                    });
                    var target = $(e.target);
                    if (target.hasClass(&#039;drill-down-parent&#039;) || target.parents(&#039;.drill-down-parent&#039;).length) return;
                    if (target.hasClass(&#039;drillDown_cell&#039;) || target.parents(&#039;.drillDown_cell&#039;).length) return;
                    if (isSelectable === &#039;cell&#039; &amp;&amp; target[0].tagName.toUpperCase() === &#039;TD&#039;)
                        target.addClass(&#039;selected&#039;);
                    else if (target[0].tagName.toUpperCase() === &#039;TR&#039;)
                        target.addClass(&#039;selected&#039;);
                    else
                        target.parents(&#039;tr&#039;).first().addClass(&#039;selected&#039;);
                }
            });
        }
        if (isSelectable === &#039;multi-row&#039; || isSelectable === &#039;multi-cell&#039;) {
            $(document).on(&#039;mousedown&#039;, function mouseDownDragCallback(event) {
                var target = $(event.target);
                if (event.target === tableBody[0] || target.parents(&#039;tbody&#039;)[0] === tableBody[0]) {
                    if (target.hasClass(&#039;drill-down-parent&#039;) || target.parents(&#039;.drill-down-parent&#039;).length) return;
                    if (target.hasClass(&#039;drillDown_cell&#039;) || target.parents(&#039;.drillDown_cell&#039;).length) return;
                    gridState[gridId].selecting = true;
                    var contentDiv = tableBody.parents(&#039;.grid-content-div&#039;),
                        overlay = $(&#039;&lt;div class=&quot;selection-highlighter&quot;&gt;&lt;/div&gt;&#039;).appendTo(gridState[gridId].grid);
                    overlay.css(&#039;top&#039;, event.pageY).css(&#039;left&#039;, event.pageX).css(&#039;width&#039;, 0).css(&#039;height&#039;, 0);
                    overlay.data(&#039;origin-y&#039;, event.pageY + contentDiv.scrollTop()).data(&#039;origin-x&#039;, event.pageX + contentDiv.scrollLeft()).data(&#039;mouse-pos-x&#039;, event.pageX).data(&#039;mouse-pos-y&#039;, event.pageY);
                    overlay.data(&#039;previous-top&#039;, event.pageY).data(&#039;previous-left&#039;, event.pageX);
                    overlay.data(&#039;previous-bottom&#039;, event.pageY).data(&#039;previous-right&#039;, event.pageX);
                    overlay.data(&#039;origin-scroll_top&#039;, contentDiv.scrollTop()).data(&#039;origin-scroll_left&#039;, contentDiv.scrollLeft());
                    overlay.data(&#039;last-scroll_top_pos&#039;, contentDiv.scrollTop()).data(&#039;last-scroll_left_pos&#039;, contentDiv.scrollLeft());
                    overlay.data(&#039;actual-height&#039;, 0).data(&#039;actual-width&#039;, 0).data(&#039;event-type&#039;, &#039;mouse&#039;);

                    $(document).one(&#039;mouseup&#039;, function mouseUpDragCallback() {
                        gridState[gridId].grid.find(&#039;.selected&#039;).each(function iterateSelectedItemsCallback(idx, elem) {
                            $(elem).removeClass(&#039;selected&#039;);
                        });
                        var overlay = $(&quot;.selection-highlighter&quot;);
                        selectHighlighted(overlay, gridId);
                        overlay.remove();
                        contentDiv.off(&#039;scroll&#039;);
                        $(document).off(&#039;mousemove&#039;);
                    });

                    contentDiv.on(&#039;scroll&#039;, function updateSelectOverlayOnScrollHandler() {
                        if (gridState[gridId].selecting) {
                            overlay.data(&#039;event-type&#039;, &#039;scroll&#039;);
                            setOverlayDimensions(contentDiv, overlay);
                        }
                    });

                    $(document).on(&#039;mousemove&#039;, function updateSelectOverlayOnMouseMoveHandler(ev) {
                        if (gridState[gridId].selecting) {
                            var domTag = ev.target.tagName.toUpperCase();
                            if (domTag === &#039;INPUT&#039; || domTag === &#039;SELECT&#039;) return;

                            overlay.data(&#039;event-type&#039;, &#039;mouse&#039;);
                            overlay.data(&#039;mouse-pos-x&#039;, ev.pageX).data(&#039;mouse-pos-y&#039;, ev.pageY);
                            setOverlayDimensions(gridState[gridId].grid.find(&#039;.grid-content-div&#039;), overlay);
                        }
                    });
                }
            });
        }

        function setOverlayDimensions(contentDiv, overlay) {
            window.getSelection().removeAllRanges();

            var contentOffset = contentDiv.offset(),
                ctHeight = contentDiv[0].clientHeight,
                ctWidth = contentDiv[0].clientWidth,
                ctTop = contentOffset.top,
                ctLeft = contentOffset.left,
                ctBottom = ctTop + ctHeight,
                ctRight = ctLeft + ctWidth,
                ctScrollTop = contentDiv.scrollTop(),
                ctScrollLeft = contentDiv.scrollLeft(),
                top = Math.min(overlay.data(&#039;mouse-pos-y&#039;), ctTop, overlay.data(&#039;previous-top&#039;)),
                left = Math.min(overlay.data(&#039;mouse-pos-x&#039;), ctLeft, overlay.data(&#039;previous-left&#039;)),
                bottom = Math.max(top, overlay.data(&#039;previous-bottom&#039;)),
                right = Math.max(left, overlay.data(&#039;previous-right&#039;)),
                trueHeight;

            if ((top === overlay.data(&#039;previous-top&#039;) || top &lt; ctTop) &amp;&amp; (bottom === overlay.data(&#039;previous-bottom&#039;) || bottom &gt; ctBottom) &amp;&amp;
                (left === overlay.data(&#039;previous-left&#039;) || left &lt; ctLeft) &amp;&amp; (right === overlay.data(&#039;previous-right&#039;) || right &gt; ctRight) &amp;&amp;
                ctScrollTop === overlay.data(&#039;last-scroll_top_pos&#039;) &amp;&amp; ctScrollLeft === overlay.data(&#039;last-scroll_left_pos&#039;))
                return;

            var dimObj = {};
            dimObj.eventType = overlay.data(&#039;event-type&#039;);
            dimObj.overlay = {};
            dimObj.overlay.smallDim = top;
            dimObj.overlay.largeDim = bottom;
            dimObj.overlay.origin = overlay.data(&#039;origin-y&#039;);
            dimObj.overlay.mousePosition = overlay.data(&#039;mouse-pos-y&#039;);
            dimObj.container = {};
            dimObj.container.smallDim = ctTop;
            dimObj.container.largeDim = ctBottom;
            dimObj.container.scrollPos = ctScrollTop;
            dimObj.container.scrollLength = contentDiv[0].scrollHeight;
            dimObj.container.clientLength = ctHeight;

            var dims = determineOverlayDimensions(dimObj);
            trueHeight = dims.trueSize;
            ctScrollTop = dims.scrollPos;
            contentDiv.scrollTop(dims.scrollPos);
            top = dims.smallDim;
            bottom = dims.largeDim;

            dimObj.overlay.smallDim = left;
            dimObj.overlay.largeDim = right;
            dimObj.overlay.origin = overlay.data(&#039;origin-x&#039;);
            dimObj.overlay.mousePosition = overlay.data(&#039;mouse-pos-x&#039;);
            dimObj.container.smallDim = ctLeft;
            dimObj.container.largeDim = ctRight;
            dimObj.container.scrollPos = ctScrollLeft;
            dimObj.container.scrollLength = contentDiv[0].scrollWidth;
            dimObj.container.clientLength = ctWidth;

            dims = determineOverlayDimensions(dimObj);
            contentDiv.scrollLeft(dims.scrollPos);

            overlay.css(&#039;top&#039;, top).css(&#039;left&#039;, dims.smallDim).css(&#039;height&#039;, (bottom - top)).css(&#039;width&#039;, (dims.largeDim - dims.smallDim));
            overlay.data(&#039;actual-height&#039;, trueHeight).data(&#039;actual-width&#039;, dims.trueSize);
            overlay.data(&#039;previous-top&#039;, top).data(&#039;previous-left&#039;, dims.smallDim).data(&#039;previous-bottom&#039;, bottom).data(&#039;previous-right&#039;, dims.largeDim);
            overlay.data(&#039;last-scroll_top_pos&#039;, ctScrollTop).data(&#039;last-scroll_left_pos&#039;, dims.scrollPos);
        }
    }

    function determineOverlayDimensions(context) {
        var locAdjustment, scrollAdjustment, smallDim, largeDim,
            trueSize,
            scrollPos = context.container.scrollPos;
        if (context.eventType === &#039;scroll&#039;) {
            if (context.overlay.origin &lt; context.container.smallDim + context.container.scrollPos) {
                if (context.overlay.mousePosition - 20 &lt;= context.container.smallDim &amp;&amp; context.container.scrollPos &gt; 0) {
                    locAdjustment = context.overlay.smallDim + 25;
                    scrollAdjustment = context.overlay.mousePosition - locAdjustment;
                    scrollPos = context.container.scrollPos + scrollAdjustment;
                    largeDim = locAdjustment;
                    smallDim = context.overlay.smallDim;
                }
                else {
                    smallDim = context.container.smallDim;
                    largeDim = context.overlay.mousePosition &gt; context.container.largeDim ? context.container.largeDim : context.overlay.mousePosition;
                }
                trueSize = largeDim + scrollPos - context.overlay.origin;
            }
            else if (context.overlay.origin &gt; context.container.largeDim + context.container.scrollPos) {
                if (context.overlay.mousePosition + 20 &gt;= context.container.largeDim &amp;&amp; context.container.scrollPos &lt; context.container.scrollLength - context.container.clientLength) {
                    locAdjustment = context.container.largeDim - 25;
                    scrollAdjustment = locAdjustment - context.overlay.mousePosition;
                    scrollPos = context.container.scrollPos - scrollAdjustment;
                    smallDim = locAdjustment;
                    largeDim = context.overlay.largeDim;
                }
                else {
                    smallDim = context.overlay.mousePosition &lt; context.container.smallDim ? context.container.smallDim : context.overlay.mousePosition;
                    largeDim = context.container.largeDim;
                }
                trueSize = context.overlay.origin - smallDim - scrollPos;
            }
            else {
                if (context.overlay.origin &lt; context.overlay.mousePosition + context.container.scrollPos) {
                    smallDim = context.overlay.origin - context.container.scrollPos;
                    largeDim = context.overlay.mousePosition &gt; context.container.largeDim ? context.container.largeDim : context.overlay.mousePosition;
                }
                else {
                    smallDim = context.overlay.mousePosition &lt; context.container.smallDim ? context.container.smallDim : context.overlay.mousePosition;
                    largeDim = context.overlay.origin - context.container.scrollPos;
                }
                trueSize = largeDim - smallDim;
            }
        }
        else {
            if (context.overlay.origin &gt; (context.container.smallDim + context.container.scrollPos) &amp;&amp; context.overlay.origin &lt; (context.container.largeDim + context.container.scrollPos)) {
                var minVal = Math.min((context.overlay.origin - context.container.scrollPos), context.overlay.mousePosition);
                var maxVal = minVal === (context.overlay.origin - context.container.scrollPos) ? context.overlay.mousePosition : (context.overlay.origin - context.container.scrollPos);
                smallDim = minVal &lt; context.container.smallDim ? context.container.smallDim : minVal;
                largeDim = maxVal &gt; context.container.largeDim ? context.container.largeDim : maxVal;
                trueSize = largeDim - smallDim;
            }
            else if (context.overlay.origin &lt;= context.container.smallDim + context.container.scrollPos) {
                smallDim = context.container.smallDim;
                if (context.overlay.mousePosition - 20 &lt;= context.container.smallDim &amp;&amp; context.container.scrollPos &gt; 0) {
                    locAdjustment = smallDim + 25;
                    scrollAdjustment = context.overlay.mousePosition - locAdjustment;
                    scrollPos = context.container.scrollPos + scrollAdjustment;
                    largeDim = locAdjustment;
                }
                else largeDim = context.overlay.mousePosition &gt; context.container.largeDim ? context.container.largeDim : context.overlay.mousePosition;
                trueSize = largeDim + scrollPos - context.overlay.origin;
            }
            else {
                largeDim = context.container.largeDim;
                if (context.overlay.mousePosition + 20 &gt;= context.container.largeDim &amp;&amp; context.container.scrollPos &lt; context.container.scrollLength - context.container.clientLength) {
                    locAdjustment = largeDim - 25;
                    scrollAdjustment = locAdjustment - context.overlay.mousePosition;
                    scrollPos = context.container.scrollPos - scrollAdjustment;
                    smallDim = locAdjustment;
                }
                else smallDim = context.overlay.mousePosition &lt; context.container.smallDim ? context.container.smallDim : context.overlay.mousePosition;
                trueSize = context.overlay.origin - smallDim - context.container.scrollPos;
            }
        }
        return {
            trueSize: trueSize,
            smallDim: smallDim || context.overlay.smallDim,
            largeDim: largeDim || context.overlay.largeDim,
            scrollPos: scrollPos || context.container.scrollPos
        };
    }

    function selectHighlighted(overlay, gridId) {
        var contentDiv = gridState[gridId].grid.find(&#039;.grid-content-div&#039;),
            ctOffset = contentDiv.offset(),
            ctHeight = contentDiv.height,
            ctWidth = contentDiv.width(),
            width = overlay.width(),
            height = overlay.height(),
            offset = overlay.offset(),
            top = offset.top,
            left = offset.left,
            right = parseFloat(overlay.data(&#039;actual-width&#039;)) + left,
            bottom = parseFloat(overlay.data(&#039;actual-height&#039;)) + top;

        if (top + overlay.data(&#039;actual-height&#039;) &gt; ctOffset.top + ctHeight || top + height - overlay.data(&#039;actual-height&#039;) &lt; ctOffset.top) {
            if (overlay.data(&#039;origin-scroll_top&#039;) &gt; overlay.data(&#039;last-scroll_top_pos&#039;)) bottom = top + overlay.data(&#039;actual-height&#039;);
            else {
                bottom = top + height;
                top = bottom - overlay.data(&#039;actual-height&#039;);
            }
        }

        if (left + overlay.data(&#039;actual-width&#039;) &gt; ctOffset.left + ctWidth || left + width - overlay.data(&#039;actual-width&#039;) &lt; ctOffset.left) {
            if (overlay.data(&#039;origin-scroll_left&#039;) &gt; overlay.data(&#039;last-scroll_left_pos&#039;)) right = left + overlay.data(&#039;actual-width&#039;);
            else {
                right = left + width;
                left = right = overlay.data(&#039;actual-width&#039;);
            }
        }

        var gridElems = gridState[gridId].selectable === &#039;multi-cell&#039; ? contentDiv.find(&#039;td&#039;) : contentDiv.find(&#039;tr&#039;);
        gridElems = gridElems.filter(function filterDrillDownRows() {
            var gridElem = $(this);
            return !gridElem.hasClass(&#039;drill-down-parent&#039;) &amp;&amp; !gridElem.parents(&#039;.drill-down-parent&#039;).length;
        });

        gridElems.each(function highlightGridElemsCallback(idx, val) {
            var element = $(val),
                eOffset = element.offset(),
                eTop = eOffset.top,
                eLeft = eOffset.left,
                eRight = parseFloat(element.css(&#039;width&#039;)) + eLeft,
                eBottom = parseFloat(element.css(&#039;height&#039;)) + eTop;

            if (left &gt; eRight || right &lt; eLeft || top &gt; eBottom || bottom &lt; eTop) return;
            else element.addClass(&#039;selected&#039;);
        });
    }

    function createGroupTrEventHandlers(gridId) {
        gridState[gridId].grid.find(&#039;.group_acc_link&#039;).on(&#039;click&#039;, function groupedAccordionsClickListenerCallback() {
            var elem = $(this),
                accRow = elem.parents(&#039;tr&#039;),
                indent = accRow.data(&#039;group-indent&#039;);
            if (elem.data(&#039;state&#039;) === &#039;open&#039;) {
                elem.data(&#039;state&#039;, &#039;closed&#039;).removeClass(&#039;group-desc&#039;).addClass(&#039;group-asc&#039;);
                accRow.nextAll().each(function iterateAccordionRowSiblingsToCloseCallback(idx, val) {
                    var row = $(val),
                        rowIndent = row.data(&#039;group-indent&#039;);
                    if (!rowIndent || rowIndent &lt; indent)
                        row.css(&#039;display&#039;, &#039;none&#039;);
                    else return false;
                });
            }
            else {
                elem.data(&#039;state&#039;, &#039;open&#039;).removeClass(&#039;group-asc&#039;).addClass(&#039;group-desc&#039;);
                accRow.nextAll().each(function iterateAccordionRowSiblingsToOpenCallback(idx, val) {
                    var row = $(val),
                        rowIndent = row.data(&#039;group-indent&#039;);
                    if (!rowIndent || rowIndent &lt; indent)
                        row.css(&#039;display&#039;, &#039;table-row&#039;);
                    else return false;
                });
            }
        });
    }

    function makeCellEditable(id, td) {
        td.on(&#039;click&#039;, function editableCellClickHandler(e) {
            var gridContent = gridState[id].grid.find(&#039;.grid-content-div&#039;);
            var gridData = gridState[id];
            if (gridState[id].updating) return;
            if (e.target !== e.currentTarget) return;
            if (gridContent.find(&#039;.invalid&#039;).length) return;
            var cell = $(e.currentTarget);
            if (cell.children(&#039;span&#039;).hasClass(&#039;dirty&#039;))
                cell.data(&#039;dirty&#039;, true);
            else cell.data(&#039;dirty&#039;, false);
            cell.text(&#039;&#039;);

            var row = cell.parents(&#039;tr&#039;).first(),
                index = gridData.grid.find(&#039;tr&#039;).filter(function removeGroupAndChildRows() {
                    var r =  $(this);
                    return r.hasClass(&#039;data-row&#039;) &amp;&amp; !r.parents(&#039;.drill-down-parent&#039;).length &amp;&amp; !r.hasClass(&#039;drill-down-parent&#039;);
                }).index(row),
                field = cell.data(&#039;field&#039;),
                column = gridState[id].columns[gridState[id].columnIndices[field]],
                type = column.type || &#039;&#039;,
                val = column.nullable || gridState[id].dataSource.data[index][field] ? gridState[id].dataSource.data[index][field] : &#039;&#039;,
                dataAttributes = &#039;&#039;,
                gridValidation = gridState[id].useValidator ? column.validation : null,
                dataType, input, inputVal;

            if (gridValidation) {
                dataAttributes = setupCellValidation(gridValidation, dataAttributes);
                var gridBodyId = &#039;grid-content-&#039; + id.toString();
                dataAttributes += &#039; data-validateon=&quot;blur&quot; data-offsetHeight=&quot;-6&quot; data-offsetWidth=&quot;8&quot; data-modalid=&quot;&#039; + gridBodyId + &#039;&quot;&#039;;
            }

            if (gridState[id].useFormatter &amp;&amp; column.inputFormat)
                dataAttributes += &#039; data-inputformat=&quot;&#039; + column.inputFormat + &#039;&quot;&#039;;

            switch (type) {
                case &#039;boolean&#039;:
                    input = $(&#039;&lt;input type=&quot;checkbox&quot; class=&quot;input checkbox active-cell&quot;&#039; + dataAttributes + &#039;/&gt;&#039;).appendTo(cell);
                    val = typeof gridState[id].dataSource.data[index][field] === &#039;string&#039; ? gridState[id].dataSource.data[index][field] === &#039;true&#039; : !!val;
                    input[0].checked = val;
                    dataType = &#039;boolean&#039;;
                    break;
                case &#039;number&#039;:
                    if (typeof gridState[id].dataSource.data[index][field] === &#039;string&#039;)
                        val = isNumber(parseFloat(gridState[id].dataSource.data[index][field])) ? parseFloat(gridState[id].dataSource.data[index][field]) : 0;
                    else
                        val = isNumber(gridState[id].dataSource.data[index][field]) ? gridState[id].dataSource.data[index][field] : 0;
                    inputVal = val;
                    input = $(&#039;&lt;input type=&quot;text&quot; value=&quot;&#039; + inputVal + &#039;&quot; class=&quot;input textbox cell-edit-input active-cell&quot;&#039; + dataAttributes + &#039;/&gt;&#039;).appendTo(cell);
                    dataType = &#039;number&#039;;
                    break;
                case &#039;time&#039;:
                    input = $(&#039;&lt;input type=&quot;text&quot; value=&quot;&#039; + val + &#039;&quot; class=&quot;input textbox cell-edit-input active-cell&quot;&#039; + dataAttributes + &#039;/&gt;&#039;).appendTo(cell);
                    dataType = &#039;time&#039;;
                    break;
                case &#039;date&#039;:
                    var dateVal = val == null ? new Date(Date.now()) : new Date(Date.parse(val));
                    inputVal = dateVal.toISOString().split(&#039;T&#039;)[0];
                    input = $(&#039;&lt;input type=&quot;date&quot; value=&quot;&#039; + inputVal + &#039;&quot; class=&quot;input textbox active-cell&quot;&#039; + dataAttributes + &#039;/&gt;&#039;).appendTo(cell);
                    dataType = &#039;date&#039;;
                    break;
                default:
                    input = $(&#039;&lt;input type=&quot;text&quot; value=&quot;&#039; + (val || &#039;&#039;) + &#039;&quot; class=&quot;input textbox cell-edit-input active-cell&quot;&#039; + dataAttributes + &#039;/&gt;&#039;).appendTo(cell);
                    dataType = &#039;string&#039;;
                    break;
            }

            if (gridValidation) input.addClass(&#039;inputValidate&#039;);

            input[0].focus();

            if (dataType) {
                input.on(&#039;keypress&#039;, function restrictCharsHandler(e) {
                    var code = e.charCode ? e.charCode : e.keyCode;
                    if (!validateCharacter.call(this, code, dataType)) {
                        e.preventDefault();
                        return false;
                    }
                });
            }

            if (gridValidation &amp;&amp; dataAttributes !== &#039;&#039;) {
                attachValidationListener(input[0]);
            }
            else {
                input.on(&#039;blur&#039;, function cellEditBlurHandler() {
                    saveCellEditData(input);
                });
            }
            callGridEventHandlers(gridData.events.beforeCellEdit, gridData.grid, null);
        });
    }

    function makeCellSelectable(id, td) {
        td.on(&#039;click&#039;, function selectableCellClickHandler(e) {
            var gridContent = gridState[id].grid.find(&#039;.grid-content-div&#039;),
                gridData = gridState[id];
            if (e.target !== e.currentTarget) return;
            if (gridContent.find(&#039;.invalid&#039;).length) return;
            var cell = $(e.currentTarget);
            if (cell.children(&#039;span&#039;).hasClass(&#039;dirty&#039;))
                cell.data(&#039;dirty&#039;, true);
            else cell.data(&#039;dirty&#039;, false);
            cell.text(&#039;&#039;);
            var row = cell.parents(&#039;tr&#039;).first(),
                index = gridData.grid.find(&#039;tr&#039;).filter(function removeGroupAndChildRows() {
                    var r =  $(this);
                    return r.hasClass(&#039;data-row&#039;) &amp;&amp; !r.parents(&#039;.drill-down-parent&#039;).length &amp;&amp; !r.hasClass(&#039;drill-down-parent&#039;);
                }).index(row),
                field = cell.data(&#039;field&#039;);
            if (gridState[id].updating) return;     

            var column = gridState[id].columns[gridState[id].columnIndices[field]],
                value = gridState[id].dataSource.data[index][field],
                gridValidation = gridState[id].useValidator ? column.validation : null,
                dataAttributes = &#039;&#039;;

            if (gridValidation) {
                dataAttributes = setupCellValidation(gridValidation, dataAttributes);
                var gridBodyId = &#039;grid-content-&#039; + id.toString();
                dataAttributes += &#039; data-validateon=&quot;blur&quot; data-offsetHeight=&quot;-6&quot; data-offsetWidth=&quot;8&quot; data-modalid=&quot;&#039; + gridBodyId + &#039;&quot;&#039;;
            }
            var select = $(&#039;&lt;select class=&quot;input select active-cell&quot;&#039; + dataAttributes + &#039;&gt;&lt;/select&gt;&#039;).appendTo(cell),
                options = column.options.map(function _copyColumnOptions(val) { return val; });
                value = column.nullable || value != null ? value : &#039;&#039;;
                var dataType = column.type || &#039;string&#039;,
                normalizedValue = normalizeValues(dataType, value);
            if (!options.some(function _compareCellValueForUniqueness(opt) {
                if (comparator(normalizedValue, normalizeValues(dataType, opt), predicates.strictEqual))
                    return true;
            })) {
                options = options.reverse();
                options.push(value);
                options = options.reverse();
            }

            options.forEach(function _setSelectableColumnOptions(option) {
                select.append(&#039;&lt;option value=&quot;&#039; + option + &#039;&quot;&gt;&#039; + option + &#039;&lt;/option&gt;&#039;);
            });
            if (&#039;&#039; !== value &amp;&amp; (column.nullable || null !== value)) select.val(value);
            select[0].focus();

            if (gridValidation) select.addClass(&#039;inputValidate&#039;);
            if (gridValidation &amp;&amp; dataAttributes !== &#039;&#039;) attachValidationListener(select[0]);
            else {
                select.on(&#039;blur&#039;, function cellEditBlurHandler() {
                    saveCellSelectData(select);
                });
            }
            callGridEventHandlers(gridData.events.beforeCellEdit, gridData.grid, null);
        });
    }

    function setupCellValidation(columnValidation, dataAttributes) {
        if (!grid.validation) {
            Object.defineProperty(
                grid,
                &#039;validation&#039;,
                { value: {}, writable: false }
            );
        }
        if (columnValidation.required) dataAttributes += &#039;data-required&#039;;
        if (columnValidation.customRules) {
            dataAttributes += &#039; data-customrules=&quot;&#039;;
            Object.keys(columnValidation.customRules).forEach(function _applyCustomValidation(rule) {
                dataAttributes += &#039;grid.validation.&#039; + rule + &#039;,&#039;;
                if (!grid.validation[rule]) {
                    Object.defineProperty(
                        grid.validation,
                        rule,
                        { value: columnValidation.customRules[rule], writable: false, configurable: false }
                    );
                }
            });
            dataAttributes += &#039;&quot;&#039;;
        }
        return dataAttributes;
    }

    function setColWidth(gridData, gridElem) {
        var tableDiv = gridElem.find(&#039;.grid-header-wrapper&#039;),
            totalColWidth;

        totalColWidth = gridData.columns.reduce(function _calcTotalWidth(prev, col) {
            if (!col.isHidden &amp;&amp; isNumber(col.width)) return prev + col.width;
            return prev;
        }, 0);

        var headerCols = tableDiv.find(&#039;col&#039;);

        headerCols.each(function iterateColsCallback(idx, val) {
            var i = idx,
                numColPadders = 0,
                isGroupAndOrDrill = (gridData.groupedBy &amp;&amp; gridData.groupedBy.length) || gridData.drillDown;
            if (isGroupAndOrDrill) {
                numColPadders = gridData.drillDown ? 1 : 0;
                numColPadders += gridData.groupedBy &amp;&amp; gridData.groupedBy.length ? gridData.groupedBy.length : 0;
                i = idx - numColPadders;
            }
            if (isGroupAndOrDrill &amp;&amp; idx &lt; numColPadders) {
                $(val).css(&#039;width&#039;, 27);
            }
            else if (gridData.columns[i].width != null &amp;&amp; (idx !== headerCols.length - 1 ||
                totalColWidth &gt;= (tableDiv.find(&#039;table&#039;).width() + (numColPadders * 27) - 17) - gridData.columns[i].width)) {
                $(val).css(&#039;width&#039;, gridData.columns[i].width);
            }
        });
    }

    function copyGridWidth(gridElem) {
        var headerCols = gridElem.find(&#039;.grid-header-div&#039;).find(&#039;col&#039;);
        var contentCols = gridElem.find(&#039;.grid-content-div&#039;).find(&#039;col&#039;);
        var headerTable = gridElem.find(&#039;.grid-header-div&#039;).find(&#039;table&#039;);
        var contentTable = gridElem.find(&#039;.grid-content-div&#039;).find(&#039;table&#039;);

        contentTable.css(&#039;width&#039;, headerTable[0].clientWidth);

        contentCols.each(function colIterationCallback(idx, val) {
            if ($(val).hasClass(&#039;group_col&#039;)) return;
            var width;
            if (width = $(headerCols[idx]).width()) $(val).css(&#039;width&#039;, width);
        });
    }

    function attachValidationListener(elem) {
        $(document).one(&#039;validated&#039;, function validationHandlerCallback(e, eventData) {
            if (eventData.element === elem) {
                if (eventData.succeeded &amp;&amp; elem.type !== &#039;select&#039; &amp;&amp; elem.type !== &#039;select-one&#039;)
                    saveCellEditData($(elem));
                else if (eventData.succeeded)
                    saveCellSelectData($(elem));
                else {
                    elem.focus();
                    attachValidationListener(elem);
                }
            }
            else attachValidationListener(elem);
        });
    }

    function saveCellEditData(input) {
        var val;
        if (input[0].type == &#039;checkbox&#039;) val = input.is(&#039;:checked&#039;);
        else val = input.val();
        var gridContent = input.parents(&#039;.grid-wrapper&#039;).find(&#039;.grid-content-div&#039;),
            cell = input.parents(&#039;td&#039;),
            id = gridContent.data(&#039;grid_content_id&#039;),
            row = cell.parents(&#039;tr&#039;).first(),
            index = gridState[id].grid.find(&#039;tr&#039;).filter(function removeGroupAndChildRows() {
                var r =  $(this);
                return r.hasClass(&#039;data-row&#039;) &amp;&amp; !r.parents(&#039;.drill-down-parent&#039;).length &amp;&amp; !r.hasClass(&#039;drill-down-parent&#039;);
            }).index(row),
            field = cell.data(&#039;field&#039;),
            column = gridState[id].columns[gridState[id].columnIndices[field]],
            type = column.type || &#039;&#039;,
            saveVal, re, setDirtyFlag = false,
            formattedVal = getFormattedCellText(column, val),
            displayVal = formattedVal == null ? &#039;Null&#039; : formattedVal;

        input.remove();
        if (formattedVal !== null) {
            switch (type) {
                case &#039;number&#039;:
                    re = new RegExp(dataTypes.number);
                    if (!re.test(val)) val = gridState[id].currentEdit[field] || gridState[id].dataSource.data[index][field];
                    if (typeof gridState[id].dataSource.data[index][field] === &#039;string&#039;) saveVal = val;
                    else {
                        var tmpVal = parseFloat(val.replace(&#039;,&#039;, &#039;&#039;));
                        tmpVal === tmpVal ? saveVal = tmpVal : saveVal = 0;
                    }
                    break;
                case &#039;date&#039;:
                case &#039;time&#039;:
                case &#039;datetime&#039;:
                    re = new RegExp(dataTypes[type]);
                    if (!re.test(val)) val = gridState[id].currentEdit[field] || gridState[id].dataSource.data[index][field];
                    saveVal = displayVal;
                    break;
                case &#039;boolean&#039;:
                    displayVal = val.toString();
                    saveVal = val;
                    break;
                default:
                    saveVal = formattedVal == null ? null : val;
                    break;
            }
        }
        else
            saveVal = val;

        cell.text(displayVal || &#039;&#039;);
        gridState[id].currentEdit[field] = null;
        var previousVal = gridState[id].dataSource.data[index][field];
        if (previousVal !== saveVal) {
            gridState[id].dataSource.data[index][field] = saveVal;
            if (saveVal !== gridState[id].originalData[gridState[id].dataSource.data[index]._initialRowIndex][field]) {
                setDirtyFlag = true;
                if (&#039;&#039; !== saveVal) cell.prepend(&#039;&lt;span class=&quot;dirty&quot;&gt;&lt;/span&gt;&#039;);
                else if (previousVal != null) cell.prepend(&#039;&lt;span class=&quot;dirty-blank&quot;&gt;&lt;/span&gt;&#039;);
            }
        }
        if (!setDirtyFlag &amp;&amp; cell.data(&#039;dirty&#039;)) {
            if (&#039;&#039; !== saveVal) cell.prepend(&#039;&lt;span class=&quot;dirty&quot;&gt;&lt;/span&gt;&#039;);
            else cell.prepend(&#039;&lt;span class=&quot;dirty-blank&quot;&gt;&lt;/span&gt;&#039;);
        }
        callGridEventHandlers(gridState[id].events.afterCellEdit, gridState[id].grid, null);
    }

    function saveCellSelectData(select) {
        var gridContent = select.parents(&#039;.grid-wrapper&#039;).find(&#039;.grid-content-div&#039;),
            val = select.val(),
            parentCell = select.parents(&#039;td&#039;);
        select.remove();
        var id = gridContent.data(&#039;grid_content_id&#039;),
            row = parentCell.parents(&#039;tr&#039;).first(),
            index = gridState[id].grid.find(&#039;tr&#039;).filter(function removeGroupAndChildRows() {
                var r =  $(this);
                return r.hasClass(&#039;data-row&#039;) &amp;&amp; !r.parents(&#039;.drill-down-parent&#039;).length &amp;&amp; !r.hasClass(&#039;drill-down-parent&#039;);
            }).index(row),
            field = parentCell.data(&#039;field&#039;),
            column = gridState[id].columns[gridState[id].columnIndices[field]],
            type = column.type || &#039;&#039;,
            formattedVal = getFormattedCellText(column, val),
            displayVal = formattedVal == null ? &#039;Null&#039; : formattedVal,
            re, saveVal, setDirtyFlag = false;

        if (null !== formattedVal) {
            switch (type) {
                case &#039;number&#039;:
                    re = new RegExp(dataTypes.number);
                    if (!re.test(val)) val = gridState[id].currentEdit[field] || gridState[id].dataSource.data[index][field];
                    saveVal = typeof gridState[id].dataSource.data[index][field] === &#039;string&#039; ? val : parseFloat(val.replace(&#039;,&#039;, &#039;&#039;));
                    break;
                case &#039;date&#039;:
                case &#039;time&#039;:
                case &#039;datetime&#039;:
                    re = new RegExp(dataTypes[type]);
                    if (!re.test(val)) val = gridState[id].currentEdit[field] || gridState[id].dataSource.data[index][field];
                    saveVal = displayVal;
                    break;
                case &#039;boolean&#039;:
                    displayVal = val.toString();
                    saveVal = val;
                    break;
                default:        
                    saveVal = formattedVal == null ? null : val;
                    break;
            }
        }
        else
            saveVal = val;

        parentCell.text(displayVal);
        var previousVal = gridState[id].dataSource.data[index][field];
        if (previousVal !== saveVal) {  
            gridState[id].dataSource.data[index][field] = saveVal;
            if (saveVal !== gridState[id].originalData[gridState[id].dataSource.data[index]._initialRowIndex][field]) {
                parentCell.prepend(&#039;&lt;span class=&quot;dirty&quot;&gt;&lt;/span&gt;&#039;);
                setDirtyFlag = true;
            }
            gridState[id].dataSource.data[index][field] = saveVal;
        }
        if (!setDirtyFlag &amp;&amp; parentCell.data(&#039;dirty&#039;)) {
            if (&#039;&#039; !== saveVal) parentCell.prepend(&#039;&lt;span class=&quot;dirty&quot;&gt;&lt;/span&gt;&#039;);
            else parentCell.prepend(&#039;&lt;span class=&quot;dirty-blank&quot;&gt;&lt;/span&gt;&#039;);
        }
        callGridEventHandlers(gridState[id].events.afterCellEdit, gridState[id].grid, null);
    }

    function createGridToolbar(gridData, gridElem, canEdit) {
        var id = gridElem.find(&#039;.grid-wrapper&#039;).data(&#039;grid_id&#039;);
        if ($(&#039;#grid_&#039; + id + &#039;_toolbar&#039;).length) return;   

        if (typeof gridData.parentGridId !== &#039;number&#039; &amp;&amp; gridData.groupable) {
            var groupMenuBar = $(&#039;&lt;div id=&quot;grid_&#039; + id + &#039;_group_div&quot; class=&quot;group_div clearfix&quot; data-grid_id=&quot;&#039; + id + &#039;&quot;&gt;&#039; + groupMenuText + &#039;&lt;/div&gt;&#039;).prependTo(gridElem);
            groupMenuBar.on(&#039;drop&#039;, function handleDropCallback(e) {
                var droppedCol = $(&#039;#&#039; + e.originalEvent.dataTransfer.getData(&#039;text&#039;));
                droppedCol.data(&#039;dragging&#039;, false);
                var dropIndicator = $(&#039;#drop_indicator_id_&#039; + id);
                dropIndicator.css(&#039;display&#039;, &#039;none&#039;);
                var groupId = $(e.currentTarget).data(&#039;grid_id&#039;),
                    droppedId = droppedCol.parents(&#039;.grid-header-div&#039;).length ? droppedCol.parents(&#039;.grid-wrapper&#039;).data(&#039;grid_id&#039;) : null,
                    groupedItems = {};
                if (groupId == null || droppedId == null || groupId !== droppedId) return;
                if (gridState[id].updating) return;     
                if (!groupMenuBar.children().length) groupMenuBar.text(&#039;&#039;);
                var field = droppedCol.data(&#039;field&#039;),
                    title = gridState[groupId].columns[gridState[groupId].columnIndices[field]].title || field,
                    foundDupe = false;

                groupMenuBar.find(&#039;.group_item&#039;).each(function iterateGroupItemsCallback(idx, val) {
                    var item = $(val);
                    groupedItems[item.data(&#039;field&#039;)] = item;
                    if (item.data(&#039;field&#039;) === field) {
                        foundDupe = true;
                        return false;
                    }
                });
                if (foundDupe) return;  

                droppedCol.data(&#039;grouped&#039;, true);
                var groupItem = $(&#039;&lt;div class=&quot;group_item&quot; data-grid_id=&quot;&#039; + groupId + &#039;&quot; data-field=&quot;&#039; + field + &#039;&quot;&gt;&lt;/div&gt;&#039;),
                    groupDirSpan = $(&#039;&lt;span class=&quot;group_sort&quot;&gt;&lt;/span&gt;&#039;).appendTo(groupItem);
                groupDirSpan.append(&#039;&lt;span class=&quot;sort-asc-white groupSortSpan&quot;&gt;&lt;/span&gt;&#039;).append(&#039;&lt;span&gt;&#039; + title + &#039;&lt;/span&gt;&#039;);
                var cancelButton = $(&#039;&lt;span class=&quot;remove&quot;&gt;&lt;/span&gt;&#039;).appendTo(groupItem),
                    groupings = [];

                if (dropIndicator.data(&#039;field&#039;)) groupItem.insertBefore(groupedItems[dropIndicator.data(&#039;field&#039;)]);
                else groupItem.appendTo(groupMenuBar);

                groupMenuBar.find(&#039;.group_item&#039;).each(function iterateGroupedColumnsCallback(idx, val) {
                    var item = $(val);
                    groupings.push({
                        field: item.data(&#039;field&#039;),
                        sortDirection: item.find(&#039;.groupSortSpan&#039;).hasClass(&#039;sort-asc-white&#039;) ? &#039;asc&#039; : &#039;desc&#039;
                    });
                });

                if (gridState[id].sortedOn &amp;&amp; gridState[id].sortedOn.length) {
                    var sortArr = [];
                    for (var l = 0; l &lt; gridState[id].sortedOn.length; l++) {
                        if (gridState[id].sortedOn[l].field !== field) sortArr.push(gridState[id].sortedOn[l]);
                        else {
                            gridState[id].grid.find(&#039;.grid-header-wrapper&#039;).find(&#039;#&#039; + field + &#039;_grid_id_&#039; + id).find(&#039;.sortSpan&#039;).remove();
                        }
                    }
                    gridState[id].sortedOn = sortArr;
                }

                var colGroups = gridState[id].grid.find(&#039;colgroup&#039;);
                colGroups.each(function iterateColGroupsForInsertCallback(idx, val) {
                    $(val).prepend(&#039;&lt;col class=&quot;group_col&quot;/&gt;&#039;);
                });
                gridState[id].grid.find(&#039;.grid-headerRow&#039;).prepend(&#039;&lt;th class=&quot;group_spacer&quot;&gt;&amp;nbsp&lt;/th&gt;&#039;);
                gridState[id].grid.find(&#039;.summary-row-header&#039;).prepend(&#039;&lt;td class=&quot;group_spacer&quot;&gt;&amp;nbsp&lt;/td&gt;&#039;);

                gridState[id].groupedBy = groupings;
                gridState[id].pageRequest.eventType = &#039;group&#039;;
                attachGroupItemEventHandlers(groupMenuBar, groupDirSpan, cancelButton);
                preparePageDataGetRequest(id);
            });
            groupMenuBar.on(&#039;dragover&#039;, function handleHeaderDragOverCallback(e) {
                e.preventDefault();
                var gridId = groupMenuBar.data(&#039;grid_id&#039;);
                var dropIndicator = $(&#039;#drop_indicator_id_&#039; + gridId);
                if (!dropIndicator.length) {
                    dropIndicator = $(&#039;&lt;div id=&quot;drop_indicator_id_&#039; + gridId + &#039;&quot; class=&quot;drop-indicator&quot; data-grid_id=&quot;&#039; + gridId + &#039;&quot;&gt;&lt;/div&gt;&#039;);
                    dropIndicator.append(&#039;&lt;span class=&quot;drop-indicator-top&quot;&gt;&lt;/span&gt;&lt;span class=&quot;drop-indicator-bottom&quot;&gt;&lt;/span&gt;&#039;);
                    gridState[gridId].grid.append(dropIndicator);
                }

                var groupedItems = groupMenuBar.find(&#039;.group_item&#039;);
                if (groupedItems.length) {
                    var placedIndicator = false;

                    groupMenuBar.find(&#039;.group_item&#039;).each(function iterateGroupedColumnsCallback(idx, val) {
                        var groupItem = $(val);
                        var groupItemOffset = groupItem.offset();
                        if (groupItemOffset.left &lt; e.originalEvent.x &amp;&amp; groupItemOffset.left + groupItem.width() &gt; e.originalEvent.x) {
                            dropIndicator.css(&#039;left&#039;, groupItemOffset.left);
                            dropIndicator.css(&#039;top&#039;, groupItemOffset.top);
                            dropIndicator.css(&#039;height&#039;, groupItem.outerHeight());
                            dropIndicator.data(&#039;field&#039;, groupItem.data(&#039;field&#039;));
                            placedIndicator = true;
                            return false;
                        }
                    });

                    if (!placedIndicator) {
                        var lastItem = groupMenuBar.find(&#039;.group_item&#039;).last();
                        dropIndicator.css(&#039;left&#039;, lastItem.offset().left + lastItem.outerWidth());
                        dropIndicator.css(&#039;top&#039;, lastItem.offset().top);
                        dropIndicator.css(&#039;height&#039;, lastItem.outerHeight());
                        dropIndicator.data(&#039;field&#039;, &#039;&#039;);
                    }
                }
                else {
                    dropIndicator.css(&#039;height&#039;, groupMenuBar.outerHeight());
                    dropIndicator.css(&#039;left&#039;, groupMenuBar.offset().left);
                    dropIndicator.css(&#039;top&#039;, groupMenuBar.offset().top);
                }
                dropIndicator.css(&#039;display&#039;, &#039;block&#039;);
            });

            groupMenuBar.on(&#039;dragexit&#039;, function handleHeaderDragOverCallback(e) {
                e.preventDefault();
                $(&#039;#drop_indicator_id_&#039; + groupMenuBar.data(&#039;grid_id&#039;)).css(&#039;display&#039;, &#039;none&#039;);
            });
        }

        var shouldBuildGridMenu = gridData.excelExport || gridData.columnToggle || gridData.advancedFiltering || gridData.selectable;

        if (canEdit || shouldBuildGridMenu) {
            var saveBar = $(&#039;&lt;div id=&quot;grid_&#039; + id + &#039;_toolbar&quot; class=&quot;toolbar clearfix&quot; data-grid_id=&quot;&#039; + id + &#039;&quot;&gt;&lt;/div&gt;&#039;).prependTo(gridElem);
            if (shouldBuildGridMenu) {
                var menuLink = $(&#039;&lt;a href=&quot;#&quot;&gt;&lt;/a&gt;&#039;);
                menuLink.append(&#039;&lt;span class=&quot;menuSpan&quot;&gt;&lt;/span&gt;&#039;);
                saveBar.append(menuLink);
                attachMenuClickHandler(menuLink, id);
            }
            if (canEdit) {
                var saveAnchor = $(&#039;&lt;a href=&quot;#&quot; class=&quot;toolbarAnchor saveToolbar&quot;&gt;&lt;/a&gt;&#039;).appendTo(saveBar);
                saveAnchor.append(&#039;&lt;span class=&quot;toolbarSpan saveToolbarSpan&quot;&gt;&lt;/span&gt;Save Changes&#039;);

                var deleteAnchor = $(&#039;&lt;a href=&quot;#&quot; class=&quot;toolbarAnchor deleteToolbar&quot;&gt;&lt;/a&gt;&#039;).appendTo(saveBar);
                deleteAnchor.append(&#039;&lt;span class=&quot;toolbarSpan deleteToolbarSpan&quot;&gt;Delete Changes&lt;/span&gt;&#039;);

                attachSaveAndDeleteHandlers(id, gridElem, saveAnchor, deleteAnchor);
            }
        }
    }

    function attachGroupItemEventHandlers(groupMenuBar, groupDirSpan, cancelButton) {
        groupDirSpan.on(&#039;click&#039;, function changeGroupSortDirHandler() {
            var groupElem = $(this),
                id = groupElem.parents(&#039;.group_item&#039;).data(&#039;grid_id&#039;),
                sortSpan = groupElem.children(&#039;.groupSortSpan&#039;),
                groupElements = [];
            if (gridState[id].updating) return;     
            if (sortSpan.hasClass(&#039;sort-asc-white&#039;)) sortSpan.removeClass(&#039;sort-asc-white&#039;).addClass(&#039;sort-desc-white&#039;);
            else sortSpan.removeClass(&#039;sort-desc-white&#039;).addClass(&#039;sort-asc-white&#039;);
            groupMenuBar.find(&#039;.group_item&#039;).each(function iterateGroupedColumnsCallback(idx, val) {
                var item = $(val);
                groupElements.push({
                    field: item.data(&#039;field&#039;),
                    sortDirection: item.find(&#039;.groupSortSpan&#039;).hasClass(&#039;sort-asc-white&#039;) ? &#039;asc&#039; : &#039;desc&#039;
                });
            });
            gridState[id].groupedBy = groupElements;
            gridState[id].pageRequest.eventType = &#039;group&#039;;
            preparePageDataGetRequest(id);
        });

        cancelButton.on(&#039;click&#039;, function removeDataGrouping() {
            var groupElem = $(this),
                groupedCol = groupElem.parents(&#039;.group_item&#039;),
                id = groupedCol.data(&#039;grid_id&#039;),
                groupElements = [];
            if (gridState[id].updating) return;     
            gridState[id].grid.find(&#039;colgroup&#039;).first().children().first().remove();
            gridState[id].grid.find(&#039;.grid-headerRow&#039;).children(&#039;.group_spacer&#039;).first().remove();
            gridState[id].grid.find(&#039;.summary-row-header&#039;).children(&#039;.group_spacer&#039;).first().remove();
            groupedCol.remove();
            groupMenuBar.find(&#039;.group_item&#039;).each(function iterateGroupedColumnsCallback(idx, val) {
                var item = $(val);
                groupElements.push({
                    field: item.data(&#039;field&#039;),
                    sortDirection: item.find(&#039;.groupSortSpan&#039;).hasClass(&#039;sort-asc-white&#039;) ? &#039;asc&#039; : &#039;desc&#039;
                });
            });
            gridState[id].grid.find(&#039;.grid-header-div&#039;).find(&#039;th [data-field=&quot;&#039; + groupElem.data(&#039;field&#039;) + &#039;&quot;]&#039;).data(&#039;grouped&#039;, false);
            if (!groupElements.length) groupMenuBar.text(groupMenuText);
            gridState[id].groupedBy = groupElements;
            gridState[id].pageRequest.eventType = &#039;group&#039;;
            preparePageDataGetRequest(id);
        });
    }

    function attachSaveAndDeleteHandlers(id, gridElem, saveAnchor, deleteAnchor) {
        saveAnchor.on(&#039;click&#039;, function saveChangesHandler(e) {
            e.preventDefault();
            if (gridState[id].updating) return;
            var gridMenu = $(e.currentTarget).parents(&#039;.grid_menu&#039;);
            if (gridMenu.length)
                $(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);
            var dirtyCells = [],
                pageNum = gridState[id].pageNum, i;
            gridElem.find(&#039;.dirty&#039;).add(&#039;.dirty-blank&#039;).each(function iterateDirtySpansCallback(idx, val) {
                dirtyCells.push($(val).parents(&#039;td&#039;));
            });

            if (dirtyCells.length) {
                if (typeof gridState[id].dataSource.put !== &#039;function&#039;) {
                    for (i = 0; i &lt; dirtyCells.length; i++) {
                        var index = dirtyCells[i].parents(&#039;tr&#039;).index();
                        var field = dirtyCells[i].data(&#039;field&#039;);
                        var origIndex = gridState[id].dataSource.data[index]._initialRowIndex;
                        gridState[id].originalData[origIndex][field] = gridState[id].dataSource.data[index][field];
                        dirtyCells[i].find(&#039;.dirty&#039;).add(&#039;.dirty-blank&#039;).remove();
                    }
                }
                else {
                    gridState[id].putRequest.eventType = &#039;save&#039;;
                    gridState[id].putRequest.pageNum = pageNum;
                    gridState[id].putRequest.models = [];
                    var putRequestModels = gridState[id].putRequest.models;
                    for (i = 0; i &lt; dirtyCells.length; i++) {
                        var tmpModel = cloneGridData(gridState[id].dataSource.data[dirtyCells[i].parents(&#039;tr&#039;).index()]);
                        var tmpMap = tmpModel._initialRowIndex;
                        var idx = existsInPutRequest(putRequestModels, tmpModel);
                        if (~idx)
                            putRequestModels[idx].dirtyFields.push(dirtyCells[i].data(&#039;field&#039;));
                        else
                            putRequestModels.push({ cleanData: gridState[id].originalData[tmpMap], dirtyData: tmpModel, dirtyFields: [dirtyCells[i].data(&#039;field&#039;)] });
                    }

                    for (i = 0; i &lt; putRequestModels.length; i++) {
                        delete putRequestModels[i].dirtyData._initialRowIndex;
                    }

                    prepareGridDataUpdateRequest(id);
                }
            }
        });

        deleteAnchor.on(&#039;click&#039;, function deleteChangeHandler(e) {
            e.preventDefault();
            if (gridState[id].updating) return;
            var gridMenu = $(e.currentTarget).parents(&#039;.grid_menu&#039;);
            if (gridMenu.length)
                $(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);
            var dirtyCells = [];
            gridElem.find(&#039;.dirty&#039;).add(&#039;.dirty-blank&#039;).each(function iterateDirtySpansCallback(idx, val) {
                dirtyCells.push($(val).parents(&#039;td&#039;));
            });

            if (dirtyCells.length) {
                for (var i = 0; i &lt; dirtyCells.length; i++) {
                    var field = dirtyCells[i].data(&#039;field&#039;),
                        index = dirtyCells[i].parents(&#039;tr&#039;).index(),
                        pageNum = gridState[id].pageNum,
                        rowNum = gridState[id].pageSize,
                        addend = (pageNum-1)*rowNum,
                        column = gridState[id].columns[gridState[id].columnIndices[field]],
                        cellVal = gridState[id].originalData[index][field] !== undefined ? gridState[id].originalData[index][field] : &#039;&#039;,
                        text = getFormattedCellText(column, cellVal) || cellVal;
                    dirtyCells[i].text(text);
                    dirtyCells[i].find(&#039;.dirty&#039;).add(&#039;.dirty-blank&#039;).remove();
                    gridState[id].dataSource.data[index][field] = gridState[id].originalData[index + addend][field];
                }
            }
        });
    }

    function attachMenuClickHandler(menuAnchor, gridId) {
        menuAnchor.on(&#039;click&#039;, function menuAnchorClickHandler(e) {
            e.stopPropagation();    
            e.preventDefault();
            var menu = gridState[gridId].grid.find(&#039;#menu_model_grid_id_&#039; + gridId),
                newMenu;

            if (!menu.length) {
                newMenu = $(&#039;&lt;div id=&quot;menu_model_grid_id_&#039; + gridId + &#039;&quot; class=&quot;grid_menu&quot; data-grid_id=&quot;&#039; + gridId + &#039;&quot;&gt;&lt;/div&gt;&#039;);
                if (gridState[gridId].editable) {
                    newMenu.append($(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;).append(createSaveDeleteMenuItems(gridId)));
                }
                if (gridState[gridId].columnToggle) {
                    if (newMenu.children().length)
                        newMenu.append($(&#039;&lt;hr/&gt;&#039;));
                    newMenu.append(createColumnToggleMenuOptions(newMenu, gridId));
                }
                if (gridState[gridId].sortable || gridState[gridId].filterable || gridState[gridId].selectable || gridState[gridId].groupable) {
                    if (newMenu.children().length)
                        newMenu.append($(&#039;&lt;hr/&gt;&#039;));
                    if (gridState[gridId].sortable) newMenu.append($(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;).append(createSortMenuItem()));
                    if (gridState[gridId].filterable) {
                        newMenu.append($(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;).append(createFilterMenuItems()));
                        if (gridState[gridId].advancedFiltering) {
                            newMenu.append($(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;).append(createFilterModalMenuItem(gridId)));
                        }
                    }
                    if (gridState[gridId].groupable) newMenu.append($(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;).append(createGroupMenuItem()));
                    if (gridState[gridId].selectable) newMenu.append($(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;).append(createDeselectMenuOption(gridId)));
                }
                if (gridState[gridId].excelExport) {
                    if (newMenu.children().length)
                        newMenu.append($(&#039;&lt;hr/&gt;&#039;));
                    newMenu.append(createExcelExportMenuItems(newMenu, gridId));
                }
                gridState[gridId].grid.append(newMenu);
                $(document).on(&#039;click&#039;, function hideMenuHandler(e) {
                    var elem = $(e.target);
                    if (!elem.hasClass(&#039;grid_menu&#039;) &amp;&amp; !elem.hasClass(&#039;menu_item_options&#039;)) {
                        if (!elem.parents(&#039;.grid_menu&#039;).length &amp;&amp; !elem.parents(&#039;.menu_item_options&#039;).length) {
                            gridState[gridId].grid.find(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);
                            gridState[gridId].grid.find(&#039;.menu_item_options&#039;).css(&#039;display&#039;, &#039;none&#039;);
                        }
                    }
                });

                $(document).on(&#039;scroll&#039;, function adjustMenuHandler() {
                    var scrollMenuAnchorOffset = menuAnchor.offset();
                    newMenu.css(&#039;top&#039;, (scrollMenuAnchorOffset.top - $(window).scrollTop()));
                    newMenu.css(&#039;left&#039;, (scrollMenuAnchorOffset.left - $(window).scrollLeft()));
                });
            }
            else {
                newMenu = menu;
                newMenu.removeClass(&#039;hiddenMenu&#039;);
            }

            var menuAnchorOffset = menuAnchor.offset();
            newMenu.css(&#039;top&#039;, (menuAnchorOffset.top - $(window).scrollTop()));
            newMenu.css(&#039;left&#039;, (menuAnchorOffset.left - $(window).scrollLeft()));
        });
    }

    function createExcelExportMenuItems(menu, gridId) {
        var menuList = $(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;);
        var menuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;);
        var menuAnchor = $(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Export to Excel&lt;span class=&quot;menu_arrow&quot;/&gt;&lt;/span&gt;&lt;/a&gt;&#039;);
        menuItem.on(&#039;mouseover&#039;, function excelMenuItemHoverHandler() {
            var exportOptions = gridState[gridId].grid.find(&#039;#excel_grid_id_&#039; + gridId);
            if (!exportOptions.length) {
                exportOptions = $(&#039;&lt;div id=&quot;excel_grid_id_&#039; + gridId + &#039;&quot; class=&quot;menu_item_options&quot; data-grid_id=&quot;&#039; + gridId + &#039;&quot; style=&quot;display: none;&quot;&gt;&lt;/div&gt;&#039;);
                var exportList = $(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;);
                if (gridState[gridId].dataSource.rowCount &lt;= gridState[gridId].pageSize)
                    exportList.append(&#039;&lt;li data-value=&quot;page&quot; class=&quot;menu_item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Current Page Data&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;&#039;);
                exportList.append(&#039;&lt;li data-value=&quot;all&quot; class=&quot;menu_item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;All Page Data&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;&#039;);
                if (gridState[gridId].selectable &amp;&amp; gridState[gridId].grid.find(&#039;.selected&#039;).length) {
                    exportList.append(&#039;&lt;li data-value=&quot;select&quot; class=&quot;menu_item&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Selected Grid Data&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;&#039;);
                }
                var options = exportList.find(&#039;li&#039;);
                options.on(&#039;click&#039;, function excelExportItemClickHandler() {
                    exportDataAsExcelFile(gridId, this.dataset.value);
                    gridState[gridId].grid.find(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);
                    toggle(exportOptions, {duration: 20, callback: function checkForMouseOver() {

                    }});
                });
                exportOptions.append(exportList);
                gridState[gridId].grid.append(exportOptions);
            }
            else exportOptions.removeClass(&#039;hidden_menu_item&#039;);

            if (exportOptions.css(&#039;display&#039;) === &#039;none&#039;) {
                var groupAnchorOffset = menuAnchor.offset(),
                    newMenuOffset = menu.offset();
                exportOptions.css(&#039;top&#039;, (groupAnchorOffset.top - 3 - $(window).scrollTop()));
                exportOptions.css(&#039;left&#039;, newMenuOffset.left + (menu.outerWidth() - exportOptions.outerWidth()));
                toggle(exportOptions, {duration: 200, callback: function checkForMouseOver() {}});
            }
        });
        menuList.on(&#039;mouseleave&#039;, function excelMenuItemHoverHandler(evt) {
            setTimeout(function detectMouseLeave() {
                var excelOptions = $(&#039;#excel_grid_id_&#039; + gridId),
                    excelOptionsOffset = excelOptions.offset();
                if (evt.pageX &gt;= excelOptionsOffset.left &amp;&amp; evt.pageX &lt;= (excelOptionsOffset.left + excelOptions.width()) &amp;&amp; evt.pageY &gt;= excelOptionsOffset.top &amp;&amp;
                    evt.pageY &lt;= (excelOptionsOffset.top + excelOptions.height())) {
                    return;
                }
                toggle(excelOptions, { duration: 200 });
            }, 200);
        });
        menuList.append(menuItem.append(menuAnchor));
        return menuList;
    }

    function createDeselectMenuOption(gridId) {
        var deSelectMenuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;).append($(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Remove Grid Selection&lt;/a&gt;&#039;));
        deSelectMenuItem.on(&#039;click&#039;, function deselectGridClickHandler(e) {
            gridState[gridId].grid.find(&#039;.selected&#039;).removeClass(&#039;selected&#039;);
            $(e.currentTarget).parents(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);
        });
        return deSelectMenuItem;
    }

    function createSaveDeleteMenuItems(gridId) {
        var saveMenuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;);
        var saveMenuAnchor = $(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Save Grid Changes&lt;/a&gt;&#039;);
        var deleteMenuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;);
        var deleteMenuAnchor = $(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Delete Grid Changes&lt;/a&gt;&#039;);

        attachSaveAndDeleteHandlers(gridId, gridState[gridId].grid, saveMenuItem, deleteMenuItem);

        saveMenuItem.append(saveMenuAnchor);
        deleteMenuItem.append(deleteMenuAnchor);
        return [saveMenuItem, deleteMenuItem];
    }

    function createSortMenuItem() {
        var sortMenuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;).append($(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Remove All Column Sorts&lt;/a&gt;&#039;));
        sortMenuItem.on(&#039;click&#039;, removeAllColumnSorts);
        return sortMenuItem;
    }

    function createFilterMenuItems() {
        var filterMenuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;).append($(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Remove All Grid Filters&lt;/a&gt;&#039;));
        filterMenuItem.on(&#039;click&#039;, resetAllFilters);
        return filterMenuItem;
    }

    function createFilterModalMenuItem(gridId) {
        var filterModalMenuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;).append($(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Advanced Filters&lt;/a&gt;&#039;));
        filterModalMenuItem.on(&#039;click&#039;, function openAdvancedFilterModal(e) {
            e.stopPropagation();
            var advancedFiltersModal = gridState[gridId].grid.find(&#039;.filter_modal&#039;);
            if (!advancedFiltersModal.length) {
                var toolbarHeight = gridState[gridId].grid.find(&#039;.toolbar&#039;).height(),
                    groupHeight = gridState[gridId].grid.find(&#039;.group_div&#039;).height(),
                    wrapperHeight = gridState[gridId].grid.find(&#039;.grid-wrapper&#039;).length ? gridState[gridId].grid.find(&#039;.grid-wrapper&#039;).height() : 0;

                advancedFiltersModal = $(&#039;&lt;div class=&quot;filter_modal&quot; data-grid_id=&quot;&#039; + gridId + &#039;&quot;&gt;&#039;).css(&#039;max-height&#039;, wrapperHeight + toolbarHeight + groupHeight - 3);
                var groupSelector = &#039;&lt;select class=&quot;input group_conjunction&quot;&gt;&lt;option value=&quot;and&quot;&gt;All&lt;/option&gt;&lt;option value=&quot;or&quot;&gt;Any&lt;/option&gt;&lt;/select&gt; of the following:&lt;/span&gt;&#039;;
                advancedFiltersModal.append(&#039;&lt;span class=&quot;group-select&quot; data-filter_group_num=&quot;1&quot;&gt;Match&#039; + groupSelector);
                var advancedFiltersContainer = $(&#039;&lt;div class=&quot;filter_group_container&quot; data-filter_group_num=&quot;1&quot;&gt;&lt;/div&gt;&#039;).appendTo(advancedFiltersModal);
                addNewAdvancedFilter(advancedFiltersContainer, true );

                $(document).on(&#039;click&#039;, function hideFilterModalHandler(e) {
                    var ct = $(e.target);
                    if (!ct.hasClass(&#039;filter_modal&#039;) &amp;&amp; !ct.parents(&#039;.filter_modal&#039;).length) {
                        var filterModal = gridState[gridId].grid.find(&#039;.filter_modal&#039;);
                        filterModal.find(&#039;.advanced_filter_value&#039;)
                            .filter(&#039;:disabled&#039;).add(&#039;.invalid-grid-input&#039;).each(function removeEmptyFilters(idx, val) {
                            var filterVal = $(val);
                            var filterRow = filterVal.parent(&#039;.filter_row_div&#039;);
                            if (filterVal.data(&#039;type&#039;) === &#039;boolean&#039; &amp;&amp; filterRow.children(&#039;.filterType&#039;).val() !== null)
                                return true;
                            else if (filterRow.data(&#039;filter_idx&#039;) === 1) {
                                if (filterVal.hasClass(&#039;invalid-grid-input&#039;)) {
                                    filterVal.removeClass(&#039;invalid-grid-input&#039;);
                                    filterModal.find(&#039;span[data-filter_idx=&quot;&#039; + filterModal.data(&#039;filter_idx&#039;) + &#039;&quot;]&#039;).remove();
                                    filterVal.val(&#039;&#039;);
                                    var columnSelector = filterRow.children(&#039;.filter_column_selector&#039;);
                                    columnSelector.find(&#039;option&#039;).remove();
                                    columnSelector.append(&#039;&lt;option value=&quot;&quot;&gt;Select a column&lt;/option&gt;&#039;);
                                    gridState[gridId].columns.forEach(function _addFilterableOptions(col) {
                                        if (col.filterable) columnSelector.append(&#039;&lt;option value=&quot;&#039; + col.field + &#039;&quot;&gt;&#039; + (col.title || col.field) + &#039;&lt;/option&gt;&#039;);
                                    });
                                    filterVal.prop(&#039;disabled&#039;, true);
                                    filterRow.children(&#039;.filterType&#039;).prop(&#039;disabled&#039;, true).find(&#039;option&#039;).remove();
                                }
                                return true;
                            }
                            else
                                filterRow.remove();
                        });

                        filterModal.find(&#039;.filter_group_container&#039;).each(function removeEmptyFilterGroups(idx, val) {
                            var filterGrp = $(val);
                            if (!filterGrp.children(&#039;.filter_row_div&#039;).length) {
                                var filterGrpNum = filterGrp.data(&#039;filter_group_num&#039;);
                                filterModal.find(&#039;span[data-filter_group_num=&quot;&#039; + filterGrpNum + &#039;&quot;]&#039;).remove();
                                filterGrp.remove();
                            }
                        });

                        filterModal.css(&#039;display&#039;, &#039;none&#039;);
                    }
                    else e.stopPropagation();
                });

                var applyFiltersButton = $(&#039;&lt;input type=&quot;button&quot; value=&quot;Apply Filter(s)&quot; class=&quot;advanced_filters_button&quot;/&gt;&#039;).appendTo(advancedFiltersModal);
                applyFiltersButton.on(&#039;click&#039;, function applyAdvancedFiltersHandler() {
                    if (gridState[gridId].updating) return;     
                    gridState[gridId].grid.find(&#039;filterInput&#039;).val(&#039;&#039;);

                    advancedFiltersModal.find(&#039;.advanced_filter_value&#039;).each(function checkFilterValuesForValidContent(idx, val) {
                        var currValue = $(val),
                            dataType = currValue.data(&#039;type&#039;);
                        if (dataType) {
                            var parentDiv = currValue.parent(&#039;.filter_row_div&#039;),
                                parentIdx = parentDiv.data(&#039;filter_idx&#039;);
                            if (dataTypes[dataType]) {
                                var re = new RegExp(dataTypes[dataType]);
                                if (!re.test(currValue.val()) &amp;&amp; !parentDiv.find(&#039;.filter_error_span&#039;).length) {
                                    currValue.addClass(&#039;invalid-grid-input&#039;);
                                    if (!parentDiv.find(&#039;span[data-filter_idx=&quot;&#039; + parentIdx + &#039;&quot;]&#039;).length) {
                                        var errorSpan = $(&#039;&lt;span class=&quot;filter_error_span hidden_error&quot; data-filter_idx=&quot;&#039; + parentIdx + &#039;&quot;&gt;Invalid &#039; + dataType + &#039;&lt;/span&gt;&#039;);
                                        parentDiv.append(errorSpan);
                                        errorSpan.css(&#039;top&#039;, parentDiv.offset().top / 2);
                                        errorSpan.css(&#039;left&#039;, parentDiv.width() - errorSpan.width());
                                    }
                                }
                                else {
                                    parentDiv.find(&#039;.filter_error_span&#039;).remove();
                                    currValue.removeClass(&#039;invalid-grid-input&#039;);
                                }
                            }
                            if (currValue.val() === &#039;&#039; &amp;&amp; currValue.data(&#039;type&#039;) !== &#039;boolean&#039;) {
                                parentDiv.remove();
                                var filterGrp = currValue.parents(&#039;.filter_group_container&#039;);
                                if (!filterGrp.find(&#039;.filter_row_div&#039;).length) {
                                    advancedFiltersModal.find(&#039;span[data-filter_group_num=&quot;&#039; + filterGrp.data(&#039;filter_group_num&#039;) + &#039;&quot;]&#039;).remove();
                                    filterGrp.remove();
                                }
                            }
                        }
                    });

                    if (advancedFiltersModal.find(&#039;.filter_error_span&#039;).length) return;

                    var advancedFilters = {};
                    createFilterGroups(advancedFiltersContainer, advancedFilters);
                    if (advancedFilters.filterGroup.length) {
                        gridState[gridId].filters = advancedFilters;
                        gridState[gridId].advancedFilters = advancedFilters;
                        gridState[gridId].basicFilters.filterGroup = [];

                        advancedFiltersModal.css(&#039;display&#039;, &#039;none&#039;);
                        gridState[gridId].pageRequest.eventType = &#039;filter&#039;;
                        preparePageDataGetRequest(gridId);
                    }
                });
                gridState[gridId].grid.append(advancedFiltersModal);
            }
            else advancedFiltersModal.css(&#039;display&#039;, &#039;block&#039;);

            var gridOffset = gridState[gridId].grid.offset(),
                gridWidth = gridState[gridId].grid.width(),
                toolbarOffset = gridState[gridId].grid.find(&#039;.toolbar&#039;).offset();

            var leftLoc = gridOffset.left - (advancedFiltersModal.outerWidth() / 2) + (gridWidth / 2);
            advancedFiltersModal.css(&#039;top&#039;, toolbarOffset.top).css(&#039;left&#039;, leftLoc);
            gridState[gridId].grid.find(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);
        });
        return filterModalMenuItem;
    }

    function createFilterGroups(groupContainer, filterObject) {
        var groupConjunct = groupContainer.parents(&#039;.filter_modal&#039;).find(&#039;span[data-filter_group_num=&quot;&#039; + groupContainer.data(&#039;filter_group_num&#039;) + &#039;&quot;]&#039;).children(&#039;select&#039;);
        filterObject.filterGroup = [];
        filterObject.conjunct = groupConjunct.val();
        findFilters(groupContainer, filterObject);
    }

    function findFilters(groupContainer, filterObject) {
        var gridId = groupContainer.parents(&#039;.filter_modal&#039;).data(&#039;grid_id&#039;);
        groupContainer.children(&#039;.filter_row_div&#039;).each(function iterateFilterDivsCallback() {
            createFilterObjects($(this), filterObject.filterGroup, gridId);
        });

        groupContainer.children(&#039;.filter_group_container&#039;).each(function createNestedFilterGroupsCallback(idx, val) {
            var nestedGroup = {};
            filterObject.filterGroup.push(nestedGroup);
            createFilterGroups($(val), nestedGroup);
        });
    }

    function createFilterObjects(filterDiv, filterGroupArr, gridId) {
        var field = filterDiv.find(&#039;.filter_column_selector&#039;).val(),
            operation, value,
            filterType = filterDiv.find(&#039;.filterType&#039;).val();
        if (filterType !== &#039;false&#039; &amp;&amp; filterType !== &#039;true&#039;) {
            operation = filterType;
            value = filterDiv.find(&#039;.advanced_filter_value&#039;).val();
        }
        else {
            operation = &#039;eq&#039;;
            value = filterType;
        }

        if (value) {
            filterGroupArr.push({ field: field, value: value, operation: operation, dataType: (gridState[gridId].columns[gridState[gridId].columnIndices[field]].type || &#039;string&#039;) });
        }
    }

    function addFilterButtonHandler(e) {
        var filterModal = $(e.currentTarget).parents(&#039;.filter_modal&#039;),
            gridId = filterModal.data(&#039;grid_id&#039;),
            numFiltersAllowed = gridState[gridId].columns.length;
        if (typeof gridState[gridId].advancedFiltering === &#039;object&#039; &amp;&amp; typeof gridState[gridId].advancedFiltering.filtersCount === &#039;number&#039;)
            numFiltersAllowed = gridState[gridId].advancedFiltering.filtersCount;

        if (filterModal.find(&#039;.filter_row_div&#039;).length &gt;= numFiltersAllowed) return;
        else if (filterModal.find(&#039;.filter_row_div&#039;).length === numFiltersAllowed - 1) filterModal.find(&#039;.add_filter_group&#039;).prop(&#039;disabled&#039;, true);

        addNewAdvancedFilter($(e.currentTarget).closest(&#039;.filter_group_container&#039;), false );
    }

    function addNewAdvancedFilter(advancedFiltersContainer, isFirstFilter) {
        var gridId = advancedFiltersContainer.parents(&#039;.filter_modal&#039;).data(&#039;grid_id&#039;),
            filterRowIdx = getFilterRowIdx(advancedFiltersContainer.parents(&#039;.filter_modal&#039;)),
            filterRowDiv = $(&#039;&lt;div class=&quot;filter_row_div&quot; data-filter_idx=&quot;&#039; + filterRowIdx + &#039;&quot;&gt;&lt;/div&gt;&#039;);
        isFirstFilter ? advancedFiltersContainer.append(filterRowDiv) : advancedFiltersContainer.children(&#039;.filter_row_div&#039;).last().after(filterRowDiv);

        var columnSelector = $(&#039;&lt;select class=&quot;input filter_column_selector&quot;&gt;&lt;/select&gt;&#039;).appendTo(filterRowDiv);
        columnSelector.addClass(&#039;select&#039;);
        columnSelector.append(&#039;&lt;option value=&quot;&quot;&gt;Select a column&lt;/option&gt;&#039;);
        gridState[gridId].columns.forEach(function _appendFilterableOption(col) {
            if (col.filterable) columnSelector.append(&#039;&lt;option value=&quot;&#039; + col.field + &#039;&quot;&gt;&#039; + (col.title || col.field) + &#039;&lt;/option&gt;&#039;);
        });

        var filterTypeSelector = $(&#039;&lt;select class=&quot;input select filterType&quot; disabled&gt;&lt;/select&gt;&#039;).appendTo(filterRowDiv);
        var filterValue = $(&#039;&lt;input type=&quot;text&quot; class=&quot;advanced_filter_value&quot; disabled /&gt;&#039;);
        filterValue.appendTo(filterRowDiv);
        filterValue.on(&#039;keypress&#039;, function validateFilterValueHandler(e) {
            var code = e.charCode? e.charCode : e.keyCode,
                type = $(this).data(&#039;type&#039;);
            if (!validateCharacter.call(this, code, type)) {
                e.preventDefault();
                return false;
            }
        })
        .on(&#039;mouseover&#039;, function displayErrorMessageHandler() {
            filterRowDiv.find(&#039;span[data-filter_idx=&quot;&#039; + filterRowDiv.data(&#039;filter_idx&#039;) + &#039;&quot;]&#039;).removeClass(&#039;hidden_error&#039;);
        })
        .on(&#039;mouseout&#039;, function hideErrorMessageHandler() {
            filterRowDiv.find(&#039;span[data-filter_idx=&quot;&#039; + filterRowDiv.data(&#039;filter_idx&#039;) + &#039;&quot;]&#039;).addClass(&#039;hidden_error&#039;);
        });

        var deleteHandler = isFirstFilter ? clearFirstFilterButtonHandler : deleteFilterButtonHandler;

        $(&#039;&lt;input type=&quot;button&quot; value=&quot;X&quot; class=&quot;filter_row_button&quot;/&gt;&#039;).appendTo(filterRowDiv).on(&#039;click&#039;, deleteHandler);

        if (!isFirstFilter) {
            var addNewFilterButton = filterRowDiv.prev().find(&#039;.new_filter&#039;),
                addFilterGroup = filterRowDiv.prev().find(&#039;.add_filter_group&#039;);
            addNewFilterButton.detach();
            addFilterGroup.detach();
            filterRowDiv.append(addNewFilterButton).append(addFilterGroup);
        }
        else {
            $(&#039;&lt;input type=&quot;button&quot; value=&quot;+&quot; class=&quot;filter_row_button new_filter&quot;/&gt;&#039;)
                .appendTo(filterRowDiv)
                .on(&#039;click&#039;, addFilterButtonHandler);

            $(&#039;&lt;input type=&quot;button&quot; value=&quot;+ Group&quot; class=&quot;advanced_filters_button add_filter_group&quot;/&gt;&#039;)
                .appendTo(filterRowDiv)
                .on(&#039;click&#039;, addFilterGroupHandler);
        }

        columnSelector.on(&#039;change&#039;, function columnSelectorCallback() {
            var columnDataType = gridState[gridId].columns[gridState[gridId].columnIndices[columnSelector.val()]].type || &#039;string&#039;;
            filterTypeSelector.find(&#039;option&#039;).remove();
            filterTypeSelector.prop(&#039;disabled&#039;, false);
            filterRowDiv.find(&#039;.advanced_filter_value&#039;).val(&#039;&#039;);
            createFilterOptionsByDataType(filterTypeSelector, columnDataType);

            if (columnDataType !== &#039;boolean&#039;)
                filterValue.prop(&#039;disabled&#039;, false);
            else
                filterValue.prop(&#039;disabled&#039;, true);
            filterValue.data(&#039;type&#039;, columnDataType);
        });
    }

    function addFilterGroupHandler() {
        var numGroupsAllowed = 0,
            filterModal = $(this).parents(&#039;.filter_modal&#039;),
            gridId = filterModal.data(&#039;grid_id&#039;),
            filterGroups = filterModal.find(&#039;.filter_group_container&#039;),
            parentGroup = $(this).parents(&#039;.filter_group_container&#039;).first(),
            filterGroupCount = filterGroups.length,
            numFiltersAllowed = gridState[gridId].columns.length;
        if (typeof gridState[gridId].advancedFiltering === &#039;object&#039; &amp;&amp; typeof gridState[gridId].advancedFiltering.groupsCount === &#039;number&#039;)
            numGroupsAllowed = gridState[gridId].advancedFiltering.groupsCount;
        else numGroupsAllowed = 3;

        if (filterGroupCount &gt;= numGroupsAllowed) return;
        else if (filterGroupCount === numGroupsAllowed - 1)
            filterModal.find(&#039;.add_filter_group&#039;).prop(&#039;disabled&#039;, true);

        if (typeof gridState[gridId].advancedFiltering === &#039;object&#039; &amp;&amp; typeof gridState[gridId].advancedFiltering.filtersCount === &#039;number&#039;)
            numFiltersAllowed = gridState[gridId].advancedFiltering.filtersCount;

        if (filterModal.find(&#039;.filter_row_div&#039;).length &gt;= numFiltersAllowed) return;
        else if (filterModal.find(&#039;.filter_row_div&#039;).length === numFiltersAllowed - 1) filterModal.find(&#039;.add_filter_group&#039;).prop(&#039;disabled&#039;, true);

        var previousGroupNum = parseInt(filterGroups.last().data(&#039;filter_group_num&#039;));

        var groupSelector = &#039;&lt;select class=&quot;input group_conjunction&quot;&gt;&lt;option value=&quot;and&quot;&gt;All&lt;/option&gt;&lt;option value=&quot;or&quot;&gt;Any&lt;/option&gt;&lt;/select&gt; of the following:&lt;/span&gt;&#039;;
        parentGroup.append(&#039;&lt;span class=&quot;group-select&quot; data-filter_group_num=&quot;&#039; + (previousGroupNum + 1) + &#039;&quot;&gt;Match&#039; + groupSelector);

        var filterGroupContainer = $(&#039;&lt;div class=&quot;filter_group_container&quot; data-filter_group_num=&quot;&#039; + (previousGroupNum + 1) + &#039;&quot;&gt;&lt;/div&gt;&#039;);
        parentGroup.append(filterGroupContainer);
        var removeGroup = $(&#039;&lt;span class=&quot;remove_filter_group&quot;&gt;&lt;/span&gt;&#039;)
            .on(&#039;click&#039;, function closeFilterGroupHandler(e) {
                var filterContainerGroup = $(e.currentTarget).closest(&#039;.filter_group_container&#039;);
                filterContainerGroup.prev(&#039;.group-select&#039;).remove();
                filterContainerGroup.remove();

                if (filterModal.find(&#039;.group_conjunction&#039;).length &lt; numGroupsAllowed)
                    filterModal.find(&#039;.add_filter_group&#039;).prop(&#039;disabled&#039;, false);
                e.stopPropagation();
            })
            .data(&#039;filter_group_num&#039;, filterGroupCount + 1)
            .css(&#039;left&#039;, (filterGroupContainer.outerWidth()));
        filterGroupContainer.append(removeGroup).append(&#039;&lt;/br&gt;&#039;);
        addNewAdvancedFilter(filterGroupContainer, true );
    }

    function deleteFilterButtonHandler(e) {
        var target = $(e.currentTarget);
        var filterRowDiv = target.parents(&#039;.filter_row_div&#039;),
            addNewFilterButton = filterRowDiv.find(&#039;.new_filter&#039;),
            filterModal = target.parents(&#039;.filter_modal&#039;),
            newFilterGroupButton = filterRowDiv.find(&#039;.add_filter_group&#039;);
        if (addNewFilterButton.length) {
            filterRowDiv.prev().append(addNewFilterButton.detach());
        }
        if (newFilterGroupButton.length) {
            filterRowDiv.prev().append(newFilterGroupButton.detach());
        }
        filterRowDiv.remove();

        var gridId = filterModal.data(&#039;grid_id&#039;),
            numFilters = filterModal.find(&#039;.filter_row_div&#039;).length,
            allowedFilters = gridState[gridId].columns.length;
        if (typeof gridState[gridId].advancedFiltering === &#039;object&#039;&amp;&amp; typeof gridState[gridId].advancedFiltering.filtersCount === &#039;number&#039;)
            allowedFilters = gridState[gridId].advancedFiltering.filtersCount;
        if (allowedFilters &gt; numFilters)
            filterModal.find(&#039;.add_filter_group&#039;).prop(&#039;disabled&#039;, false);
        e.stopPropagation();
    }

    function clearFirstFilterButtonHandler(e) {
        var filterRowDiv = $(e.currentTarget).parents(&#039;.filter_row_div&#039;),
            columnSelector = filterRowDiv.find(&#039;.filter_column_selector&#039;),
            gridId = filterRowDiv.parents(&#039;.filter_modal&#039;).data(&#039;grid_id&#039;);
        columnSelector.find(&#039;option&#039;).remove();
        columnSelector.append(&#039;&lt;option value=&quot;&quot;&gt;Select a column&lt;/option&gt;&#039;);
        gridState[gridId].columns.forEach(function _appendFilterableOption(col) {
            if (col.filterable) columnSelector.append(&#039;&lt;option value=&quot;&#039; + col.field + &#039;&quot;&gt;&#039; + (col.title || col.field) + &#039;&lt;/option&gt;&#039;);
        });
        filterRowDiv.find(&#039;.filterType&#039;).prop(&#039;disabled&#039;, true).find(&#039;option&#039;).remove();
        filterRowDiv.find(&#039;.advanced_filter_value&#039;).val(&#039;&#039;).prop(&#039;disabled&#039;, true);
    }

    function getFilterRowIdx(filterModal) {
        return filterModal.find(&#039;.filter_row_div&#039;).length ? filterModal.find(&#039;.filter_row_div&#039;).last().data(&#039;filter_idx&#039;) + 1 : 1;
    }

    function removeAllColumnSorts(e) {
        var gridMenu = $(e.currentTarget).parents(&#039;.grid_menu&#039;),
            gridId = gridMenu.data(&#039;grid_id&#039;);
        $(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);

        gridState[gridId].grid.find(&#039;.sortSpan&#039;).remove();
        if (gridState[gridId].sortedOn.length) {
            gridState[gridId].sortedOn = [];
            gridState[gridId].pageRequest.eventType = &#039;sort&#039;;
            preparePageDataGetRequest(gridId);
        }
        e.preventDefault();
    }

    function createGroupMenuItem() {
        var groupMenuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;).append($(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Remove All Column Grouping&lt;/a&gt;&#039;));
        groupMenuItem.on(&#039;click&#039;, removeAllColumnGrouping);
        return groupMenuItem;
    }

    function removeAllColumnGrouping(e) {
        var gridMenu = $(e.currentTarget).parents(&#039;.grid_menu&#039;),
            gridId = gridMenu.data(&#039;grid_id&#039;);
        $(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);

        var groupItems = gridState[gridId].grid.find(&#039;.group_item&#039;),
            groupItemsCount = groupItems.length,
            headerColGroup = gridState[gridId].grid.find(&#039;colgroup&#039;).first();
        groupItems.remove();
        for (var i = 0; i &lt; groupItemsCount; i++) {
            headerColGroup.children().first().remove();
        }
        gridState[gridId].grid.find(&#039;.grid-headerRow&#039;).children(&#039;.group_spacer&#039;).remove();
        gridState[gridId].grid.find(&#039;.summary-row-header&#039;).children(&#039;.group_spacer&#039;).remove();
        gridState[gridId].grid.find(&#039;.group_div&#039;).text(groupMenuText);

        if (gridState[gridId].groupedBy.length) {
            gridState[gridId].groupedBy = [];
            gridState[gridId].pageRequest.eventType = &#039;group&#039;;
            preparePageDataGetRequest(gridId);
        }
        e.preventDefault();
    }

    function createColumnToggleMenuOptions(menu, gridId) {
        var menuList = $(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;);
        var menuItem = $(&#039;&lt;li class=&quot;menu_item&quot;&gt;&lt;/li&gt;&#039;);
        var menuAnchor = $(&#039;&lt;a href=&quot;#&quot; class=&quot;menu_option&quot;&gt;&lt;span class=&quot;excel_span&quot;&gt;Toggle Columns&lt;span class=&quot;menu_arrow&quot;/&gt;&lt;/span&gt;&lt;/a&gt;&#039;);
        menuItem.on(&#039;mouseover&#039;, function columnToggleMenuItemHoverHandler() {
            var toggleOptions = gridState[gridId].grid.find(&#039;#toggle_grid_id_&#039; + gridId);
            if (!toggleOptions.length || gridState[gridId].hasAddedColumn) {
                if (gridState[gridId].hasAddedColumn) gridState[gridId].hasAddedColumn = false;
                toggleOptions = $(&#039;&lt;div id=&quot;toggle_grid_id_&#039; + gridId + &#039;&quot; class=&quot;menu_item_options&quot; data-grid_id=&quot;&#039; + gridId + &#039;&quot; style=&quot;display: none;&quot;&gt;&lt;/div&gt;&#039;);
                var columnList = $(&#039;&lt;ul class=&quot;menu-list&quot;&gt;&lt;/ul&gt;&#039;);
                gridState[gridId].columns.forEach(function _createToggableColumns(col) {
                    var columnOption = $(&#039;&lt;li data-value=&quot;&#039; + col.field + &#039;&quot; class=&quot;menu_item&quot;&gt;&#039;);
                    var columnToggle = $(&#039;&lt;span class=&quot;excel_span&quot;&gt;&lt;input type=&quot;checkbox&quot; data-field=&quot;&#039; + col.field + &#039;&quot;&gt; &#039; + (col.title || col.field) + &#039;&lt;/span&gt;&#039;);
                    columnToggle.appendTo(columnOption);
                    columnList.append(columnOption);
                });
                var options = columnList.find(&#039;input&#039;);
                options.on(&#039;click&#039;, function excelExportItemClickHandler() {
                    var uncheckedCol = false;
                    $(this).parents(&#039;ul&#039;).find(&#039;input&#039;).each(function findTotalCheckedColumns() {
                        if (!this.checked) {
                            uncheckedCol = true;
                            return false;
                        }
                    });
                    if (uncheckedCol &amp;&amp; this.checked) gridState[gridId].grid[0].grid.hideColumn($(this).data(&#039;field&#039;));
                    else if (this.checked) this.checked = false;
                    else gridState[gridId].grid[0].grid.showColumn($(this).data(&#039;field&#039;));
                });
                toggleOptions.append(columnList);
                gridState[gridId].grid.append(toggleOptions);
            }
            if (toggleOptions.css(&#039;display&#039;) === &#039;none&#039;) {
                var groupAnchorOffset = menuAnchor.offset(),
                    newMenuOffset = menu.offset();
                toggleOptions.css(&#039;top&#039;, (groupAnchorOffset.top - 3 - $(window).scrollTop()));
                toggleOptions.css(&#039;left&#039;, newMenuOffset.left + (menu.outerWidth() - toggleOptions.outerWidth()));
                toggle(toggleOptions, {duration: 200 });
            }
        });
        menuList.on(&#039;mouseleave&#039;, function columnToggleItemHoverHandler(evt) {
            setTimeout(function detectMouseLeave() {
                var toggleOptions = $(&#039;#toggle_grid_id_&#039; + gridId),
                    toggleOptionsOffset = toggleOptions.offset();
                if (evt.pageX &gt;= toggleOptionsOffset.left &amp;&amp; evt.pageX &lt;= (toggleOptionsOffset.left + toggleOptions.width()) &amp;&amp; evt.pageY &gt;= toggleOptionsOffset.top &amp;&amp;
                    evt.pageY &lt;= (toggleOptionsOffset.top + toggleOptions.height())) {
                    return;
                }
                toggle(toggleOptions, { duration: 200 });
            }, 200);
        });
        menuList.append(menuItem.append(menuAnchor));
        return menuList;
    }

    function createGridFooter(gridData, gridElem) {
        var gridFooter = gridElem.find(&#039;.grid-footer-div&#039;),
            id = gridFooter.data(&#039;grid_footer_id&#039;),
            count = gridState[id].dataSource.rowCount || gridState[id].dataSource.data.length,
            displayedRows = (count - gridState[id].pageSize) &gt; 0 ? gridState[id].pageSize : count,
            totalPages = (count - displayedRows) &gt; 0 ? Math.ceil((count - displayedRows)/displayedRows) + 1: 1,
            pageNum = gridState[id].pageNum;

        var first = $(&#039;&lt;a href=&quot;#&quot; class=&quot;grid-page-link&quot; data-link=&quot;first&quot; data-pagenum=&quot;1&quot; title=&quot;First Page&quot;&gt;&lt;span class=&quot;grid-page-span span-first&quot;&gt;First Page&lt;/span&gt;&lt;/a&gt;&#039;).appendTo(gridFooter);
        var prev = $(&#039;&lt;a href=&quot;#&quot; class=&quot;grid-page-link&quot; data-link=&quot;prev&quot; data-pagenum=&quot;1&quot; title=&quot;Previous Page&quot;&gt;&lt;span class=&quot;grid-page-span span-prev&quot;&gt;Prev Page&lt;/span&gt;&lt;/a&gt;&#039;).appendTo(gridFooter);
        var text = &#039;Page &#039; + gridState[parseInt(gridFooter.data(&#039;grid_footer_id&#039;))].pageNum + &#039;/&#039; + (totalPages);
        gridFooter.append(&#039;&lt;span class=&quot;grid-pagenum-span page-counter&quot;&gt;&#039; + text + &#039;&lt;/span&gt;&#039;);
        var next = $(&#039;&lt;a href=&quot;#&quot; class=&quot;grid-page-link&quot; data-link=&quot;next&quot; data-pagenum=&quot;2&quot; title=&quot;Next Page&quot;&gt;&lt;span class=&quot;grid-page-span span-next&quot;&gt;Next Page&lt;/span&gt;&lt;/a&gt;&#039;).appendTo(gridFooter);
        var last = $(&#039;&lt;a href=&quot;#&quot; class=&quot;grid-page-link&quot; data-link=&quot;last&quot; data-pagenum=&quot;&#039; + (totalPages) + &#039;&quot; title=&quot;Last Page&quot;&gt;&lt;span class=&quot;grid-page-span span-last&quot;&gt;Last Page&lt;/span&gt;&lt;/a&gt;&#039;).appendTo(gridFooter);

        if (pageNum === 1) {
            first.addClass(&#039;link-disabled&#039;);
            prev.addClass(&#039;link-disabled&#039;);
        }
        if (pageNum === totalPages) {
            next.addClass(&#039;link-disabled&#039;);
            last.addClass(&#039;link-disabled&#039;);
        }

        var pageOptions = gridData.pagingOptions;
        if (pageOptions &amp;&amp; pageOptions.constructor === Array) {
            var sizeSelectorSpan = $(&#039;&lt;span class=&quot;page-size-span&quot;&gt;&lt;/span&gt;&#039;),
                sizeSelect = $(&#039;&lt;select class=&quot;size-selector input&quot;&gt;&lt;/select&gt;&#039;),
                numOptions = 0;
            for (var i = 0; i &lt; pageOptions.length; i++) {
                if (isNumber(parseFloat(pageOptions[i]))) {
                    sizeSelect.append(&#039;&lt;option value=&quot;&#039; + pageOptions[i] + &#039;&quot;&gt;&#039; + pageOptions[i] + &#039;&lt;/option&gt;&#039;);
                    numOptions++;
                }
            }
            if (numOptions) {
                sizeSelectorSpan.appendTo(gridFooter);
                sizeSelect.appendTo(sizeSelectorSpan);
            }
            sizeSelect.val(~pageOptions.indexOf(gridState[id].pageSize) ? gridState[id].pageSize : pageOptions[0]);
            sizeSelectorSpan.append(&#039;Rows per page&#039;);

            sizeSelect.on(&#039;change&#039;, function pageSizeSelectorClickHandler(e) {
                var pageSize = $(this).val(),
                displayedRows = (count - pageSize) &gt; 0 ? pageSize : count,
                totalPages = (count - displayedRows) &gt; 0 ? Math.ceil((count - displayedRows)/displayedRows) + 1: 1;
                gridState[id].pageRequest.pageSize = parseInt(pageSize);
                gridState[id].pageRequest.eventType = &#039;pageSize&#039;;
                gridState[id].pageRequest.pageNum = totalPages &lt; gridState[id].pageNum ? totalPages : gridState[id].pageNum;
                preparePageDataGetRequest(id);
                e.preventDefault();
            });
        }

        var rowStart = displayedRows ? (1 + (displayedRows * (pageNum - 1))) : 0;
        var rowEnd = gridData.dataSource.rowCount &lt; gridData.pageSize * pageNum ? gridData.dataSource.rowCount : gridData.pageSize * pageNum;
        text = rowStart + &#039; - &#039; + rowEnd + &#039; of &#039; + count + &#039; rows&#039;;
        gridFooter.append(&#039;&lt;span class=&quot;pageinfo&quot;&gt;&#039; + text + &#039;&lt;/span&gt;&#039;);

        setPagerEventListeners(gridFooter);
    }

    function setPagerEventListeners(gridFooter) {
        gridFooter.find(&#039;a&#039;).each(function iterateGridFooterAnchorsCallback(idx, val) {
            $(val).on(&#039;click&#039;, function gridFooterAnchorClickHandlerCallback(e) {
                e.preventDefault();
                var link = e.currentTarget.tagName === &#039;A&#039; ? $(e.currentTarget) : $(e.srcElement).parents(&#039;.grid-page-link&#039;);
                if (link.hasClass(&#039;link-disabled&#039;)) {   
                    return;
                }
                var gridFooter = link.parents(&#039;.grid-footer-div&#039;);
                var allPagers = gridFooter.find(&#039;a&#039;);
                var id = parseInt(link.parents(&#039;.grid-wrapper&#039;)[0].dataset.grid_id);
                if (gridState[id].updating) return;     
                var gridData = gridState[id];
                var pageSize = gridData.pageSize;
                var pagerInfo = gridFooter.find(&#039;.pageinfo&#039;);
                var pagerSpan = gridFooter.find(&#039;.grid-pagenum-span&#039;);
                var totalPages = (gridData.dataSource.rowCount - pageSize) &gt; 0 ? Math.ceil((gridData.dataSource.rowCount - pageSize)/pageSize) + 1 : 1;
                var pageNum = parseInt(link[0].dataset.pagenum);
                gridData.pageNum = pageNum;
                var rowStart = 1 + (pageSize * (pageNum - 1));
                var rowEnd = pageSize * pageNum;

                switch (link.data(&#039;link&#039;)) {
                    case &#039;first&#039;:
                        link.addClass(&#039;link-disable&#039;);
                        $(allPagers[1]).addClass(&#039;link-disabled&#039;)[0].dataset.pagenum = 1;
                        $(allPagers[2]).removeClass(&#039;link-disabled&#039;)[0].dataset.pagenum = pageNum + 1;
                        $(allPagers[3]).removeClass(&#039;link-disabled&#039;);
                        break;
                    case &#039;prev&#039;:
                        link[0].dataset.pagenum = pageNum - 1;
                        if (pageNum === 1) {
                            link.addClass(&#039;link-disabled&#039;);
                            $(allPagers[0]).addClass(&#039;link-disabled&#039;);
                        }
                        $(allPagers[2]).removeClass(&#039;link-disabled&#039;)[0].dataset.pagenum = pageNum + 1;
                        $(allPagers[3]).removeClass(&#039;link-disabled&#039;);
                        break;
                    case &#039;next&#039;:
                        rowEnd = gridData.dataSource.rowCount &lt; pageSize * pageNum ? gridData.dataSource.rowCount : pageSize * pageNum;
                        link[0].dataset.pagenum = pageNum + 1;
                        if (pageNum === totalPages) {
                            link.addClass(&#039;link-disabled&#039;);
                            $(allPagers[3]).addClass(&#039;link-disabled&#039;);
                        }
                        $(allPagers[0]).removeClass(&#039;link-disabled&#039;);
                        $(allPagers[1]).removeClass(&#039;link-disabled&#039;)[0].dataset.pagenum = pageNum - 1;
                        break;
                    case &#039;last&#039;:
                        rowEnd = gridData.dataSource.rowCount &lt; pageSize * pageNum ? gridData.dataSource.rowCount : pageSize * pageNum;
                        link.addClass(&#039;link-disabled&#039;);
                        $(allPagers[2]).addClass(&#039;link-disabled&#039;)[0].dataset.pagenum = pageNum;
                        $(allPagers[0]).removeClass(&#039;link-disabled&#039;);
                        $(allPagers[1]).removeClass(&#039;link-disabled&#039;)[0].dataset.pagenum = pageNum - 1;
                        break;
                }
                pagerSpan.text(&#039;Page &#039; + pageNum + &#039;/&#039; + totalPages);
                pagerInfo.text(rowStart + &#039; - &#039; + rowEnd + &#039; of &#039; + gridData.dataSource.rowCount + &#039; rows&#039;);
                gridData.grid.find(&#039;.grid-content-div&#039;).empty();
                gridData.pageRequest.eventType = &#039;page&#039;;
                gridData.pageRequest.pageNum = pageNum;
                preparePageDataGetRequest(id);
            });
        });
    }

    function attachFilterListener(filterElem) {
        filterElem.on(&#039;click&#039;, function filterClickCallback(e) {
            e.stopPropagation();    
            e.preventDefault();
            var filterAnchor = $(e.target);
            var filterCell = filterAnchor.parents(&#039;th&#039;);
            var type = filterAnchor.data(&#039;type&#039;);
            var grid = filterElem.parents(&#039;.grid-wrapper&#039;).first();
            var id = grid.data(&#039;grid_id&#039;);
            if (gridState[id].updating) return;     
            var filters = grid.find(&#039;.filter-div&#039;);
            var currFilter = null;
            var field = filterAnchor.data(&#039;field&#039;);
            var title = gridState[id].columns[gridState[id].columnIndices[field]].title || field;

            if (filters.length) {
                filters.each(function iterateFiltersCallback(idx, val) {
                    var filter = $(val);
                    if (filter.data(&#039;parentfield&#039;) === filterAnchor.data(&#039;field&#039;)) {
                        filter.removeClass(&#039;hiddenFilter&#039;);
                        currFilter = $(val);
                    }
                    else filter.addClass(&#039;hiddenFilter&#039;);
                });
            }

            if (!currFilter) {
                createFilterDiv(type, field, grid, title);
                currFilter = grid.find(&#039;.filter-div&#039;);
            }
            var filterCellOffset = filterCell.offset();
            currFilter.css(&#039;top&#039;, (filterCellOffset.top + filterCell.height() - $(window).scrollTop()));
            currFilter.css(&#039;left&#039;, (filterCellOffset.left + filterCell.width() - $(window).scrollLeft()));
        });
    }

    function createFilterDiv(type, field, grid, title) {
        var filterDiv = $(&#039;&lt;div class=&quot;filter-div&quot; data-parentfield=&quot;&#039; + field + &#039;&quot; data-type=&quot;&#039; + type + &#039;&quot;&gt;&lt;/div&gt;&#039;).appendTo(grid),
            domName = title ? title : type,
            filterInput, resetButton, button,
            modalText = &#039;Filter rows where &#039; + domName,
            id = grid.data(&#039;grid_id&#039;);
        modalText = type !== &#039;string&#039; ? modalText + &#039; is:&#039; : modalText + &#039;:&#039;;
        $(&#039;&lt;span class=&quot;filterTextSpan&quot;&gt;&#039; + modalText + &#039;&lt;/span&gt;&#039;).appendTo(filterDiv);
        var select = $(&#039;&lt;select class=&quot;filterSelect select input&quot;&gt;&lt;/select&gt;&#039;).appendTo(filterDiv),
            column = gridState[id].columns[gridState[id].columnIndices[field]];

        createFilterOptionsByDataType(select, type, column.nullable);

        if (column.nullable) {
            select.on(&#039;change&#039;, function handleNullValueSelect() {
                if (gridState[id].updating) return;     
                var val = $(this).val(),
                    operation = val === &#039;null&#039; ? &#039;eq&#039; : &#039;neq&#039;;
                if (val === &#039;null&#039; || val === &#039;not_null&#039;) {
                    if (filterInput) filterInput.val(&#039;&#039;);
                    var dataType = column.type || &#039;string&#039;,
                        extantFilters = gridState[id].basicFilters.filterGroup || [],
                        tmpFilters = [], updatedFilter = [], foundColumn,
                        errors = filterDiv.find(&#039;.filter-div-error&#039;);

                    if (errors.length) errors.remove();
                    for (var i = 0; i &lt; extantFilters.length; i++) {
                        if (extantFilters[i].field !== field) tmpFilters.push(extantFilters[i]);
                        else {
                            updatedFilter = extantFilters[i];
                            updatedFilter.operation = operation;
                            updatedFilter.value = null;
                            foundColumn = true;
                        }
                    }

                    tmpFilters.push(foundColumn ? updatedFilter : { field: field, value: null, operation: operation, dataType: dataType });
                    gridState[id].filters = { conjunct: &#039;and&#039;, filterGroup: tmpFilters };
                    gridState[id].basicFilters.filterGroup = tmpFilters;
                    gridState[id].advancedFilters = {};

                    filterDiv.addClass(&#039;hiddenFilter&#039;);
                    gridState[id].pageRequest.eventType = &#039;filter&#039;;
                    preparePageDataGetRequest(id);
                }
            });
        }

        if (type !== &#039;boolean&#039;) {
            filterInput = $(&#039;&lt;input type=&quot;text&quot; class=&quot;filterInput input&quot; id=&quot;filterInput&#039; + type + field + &#039;&quot;/&gt;&#039;).appendTo(filterDiv);
        }
        resetButton = $(&#039;&lt;input type=&quot;button&quot; value=&quot;Reset&quot; class=&quot;button resetButton&quot; data-field=&quot;&#039; + field + &#039;&quot;/&gt;&#039;).appendTo(filterDiv);
        button = $(&#039;&lt;input type=&quot;button&quot; value=&quot;Filter&quot; class=&quot;filterButton button&quot; data-field=&quot;&#039; + field + &#039;&quot;/&gt;&#039;).appendTo(filterDiv);
        resetButton.on(&#039;click&#039;, resetButtonClickHandler);
        button.on(&#039;click&#039;, filterButtonClickHandler);
        if (filterInput &amp;&amp; type !==&#039;time&#039; &amp;&amp; type !== &#039;date&#039;) filterInputValidation(filterInput);
    }

    function createFilterOptionsByDataType(select, type, isNullable) {
        switch (type) {
            case &#039;number&#039;:
                select.append(&#039;&lt;option value=&quot;gte&quot;&gt;Greater than or equal to:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;gt&quot;&gt;Greater than:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;lte&quot;&gt;Less than or equal to:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;lt&quot;&gt;Less than:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;eq&quot;&gt;Equal to:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;neq&quot;&gt;Not equal to:&lt;/option&gt;&#039;);
                break;
            case &#039;date&#039;:
            case &#039;time&#039;:
            case &#039;datetime&#039;:
                select.append(&#039;&lt;option value=&quot;gte&quot;&gt;Equal to or later than:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;gt&quot;&gt;Later than:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;lte&quot;&gt;Equal to or before:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;lt&quot;&gt;Before:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;eq&quot;&gt;Equal to:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;neq&quot;&gt;Not equal to:&lt;/option&gt;&#039;);
                break;
            case &#039;boolean&#039;:
                select.append(&#039;&lt;option value=&quot;true&quot;&gt;True&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;false&quot;&gt;False&lt;/option&gt;&#039;);
                break;
            case &#039;string&#039;:
                select.append(&#039;&lt;option value=&quot;ct&quot;&gt;Contains:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;nct&quot;&gt;Does not contain:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;eq&quot;&gt;Equal to:&lt;/option&gt;&#039;)
                    .append(&#039;&lt;option value=&quot;neq&quot;&gt;Not equal to:&lt;/option&gt;&#039;);
                break;
        }

        if (isNullable) {
            select.append(&#039;&lt;option value=&quot;null&quot;&gt;Is null:&lt;/option&gt;&#039;);
            select.append(&#039;&lt;option value=&quot;not_null&quot;&gt;Is not null:&lt;/option&gt;&#039;);
        }
    }

    function filterInputValidation(input) {
        input.on(&#039;keypress&#039;, function restrictCharsHandler(e) {
            var code = e.charCode? e.charCode : e.keyCode,
                type = $(this).parents(&#039;.filter-div&#039;).data(&#039;type&#039;);
            if (!validateCharacter.call(this, code, type)) {
                e.preventDefault();
                return false;
            }
        });
    }

    function resetAllFilters(e) {
        var gridMenu = $(e.currentTarget).parents(&#039;.grid_menu&#039;),
            gridId = gridMenu.data(&#039;grid_id&#039;);
        if (gridState[gridId].updating) return;     
        $(&#039;.grid_menu&#039;).addClass(&#039;hiddenMenu&#039;);
        gridState[gridId].grid.find(&#039;filterInput&#039;).val(&#039;&#039;);

        var filterModal = gridState[gridId].grid.find(&#039;.filter_modal&#039;);
        filterModal.find(&#039;.filter_group_container&#039;).each(function removeFilterGroups() {
            var grpContainer = $(this);
            if (grpContainer.data(&#039;filter_group_num&#039;) !== 1) grpContainer.remove();
            else {
                grpContainer.find(&#039;.filter_row_div&#039;).each(function removeFilterRows() {
                    var filterRow = $(this);
                    if (filterRow.data(&#039;filter_idx&#039;) !== 1) filterRow.remove();
                    else {
                        var columnSelector = filterRow.find(&#039;.filter_column_selector&#039;);
                        columnSelector.find(&#039;option&#039;).remove();
                        columnSelector.append(&#039;&lt;option value=&quot;&quot;&gt;Select a column&lt;/option&gt;&#039;);
                        gridState[gridId].columns.forEach(function _addFilterableOption(col) {
                            if (col.filterable) columnSelector.append(&#039;&lt;option value=&quot;&#039; + col.field + &#039;&quot;&gt;&#039; + (col.title || col.field) + &#039;&lt;/option&gt;&#039;);
                        });

                        filterRow.find(&#039;.filterType&#039;).prop(&#039;disabled&#039;, true).find(&#039;option&#039;).remove();
                        filterRow.find(&#039;.advanced_filter_value&#039;).prop(&#039;disabled&#039;, true).removeClass(&#039;invalid-grid-input&#039;).val(&#039;&#039;);
                    }
                });
            }
        });

        filterModal.find(&#039;filter_error&#039;).remove();

        if (gridState[gridId].filters &amp;&amp; Object.keys(gridState[gridId].filters.filterGroup).length) {
            gridState[gridId].filters = {};
            gridState[gridId].pageRequest.eventType = &#039;filter&#039;;
            preparePageDataGetRequest(gridId);
        }
    }

    function resetButtonClickHandler(e) {
        var filterDiv = $(e.currentTarget).parents(&#039;.filter-div&#039;),
            value = filterDiv.find(&#039;.filterInput&#039;).val(),
            field = $(this).data(&#039;field&#039;),
            remainingFilters = [],
            gridId = filterDiv.parents(&#039;.grid-wrapper&#039;).first().data(&#039;grid_id&#039;);
        if (gridState[gridId].updating) return;     
        var gridData = gridState[gridId];

        if (value === &#039;&#039; &amp;&amp; !gridData.filters.filterGroup.length) return;
        filterDiv.find(&#039;.filterInput&#039;).val(&#039;&#039;);
        filterDiv.addClass(&#039;hiddenFilter&#039;);

        for (var i = 0; i &lt; gridState[gridId].filters.filterGroup.length; i++) {
            if (gridState[gridId].filters.filterGroup[i].field !== field) {
                remainingFilters.push(gridState[gridId].filters.filterGroup[i]);
            }
        }

        gridData.filters.filterGroup = remainingFilters;
        gridData.pageRequest.eventType = &#039;filter&#039;;
        preparePageDataGetRequest(gridId);
        e.preventDefault();
    }

    function filterButtonClickHandler(e) {
        var filterDiv = $(e.currentTarget).parents(&#039;.filter-div&#039;),
            selected = filterDiv.find(&#039;.filterSelect&#039;).val(),
            value = filterDiv.find(&#039;.filterInput&#039;).val(),
            gridId = filterDiv.parents(&#039;.grid-wrapper&#039;).data(&#039;grid_id&#039;);
        if (gridState[gridId].updating) return;     
        var gridData = gridState[gridId],
            type = filterDiv.data(&#039;type&#039;),
            errors = filterDiv.find(&#039;.filter-div-error&#039;),
            field = $(this).data(&#039;field&#039;),
            column = gridState[gridId].columns[gridState[gridId].columnIndices[field]],
            tmpFilters = [],
            foundColumn = false,
            re, updatedFilter;

        if (dataTypes[type]) {
            re = new RegExp(dataTypes[type]);
            if (!re.test(value)) {
                if (type === &#039;datetime&#039; &amp;&amp; new RegExp(dataTypes[&#039;date&#039;]).test(value)) {
                    value += &#039; 00:00:00&#039;;
                }
                else {
                    $(&#039;&lt;span class=&quot;filter-div-error&quot;&gt;Invalid &#039; + type + &#039;&lt;/span&gt;&#039;).appendTo(filterDiv);
                    return;
                }
            }
        }

        var dataType = column.type || &#039;string&#039;,
            extantFilters = gridState[gridId].basicFilters.filterGroup || [];

        if (errors.length) errors.remove();
        if (value === &#039;&#039; &amp;&amp; !gridData.basicFilters.length) return;
        if (dataType === &#039;boolean&#039;) {
            value = selected;
            selected = &#039;eq&#039;;
        }

        for (var i = 0; i &lt; extantFilters.length; i++) {
            if (extantFilters[i].field !== field) tmpFilters.push(extantFilters[i]);
            else {
                updatedFilter = extantFilters[i];
                updatedFilter.operation = selected;
                updatedFilter.value = value;
                foundColumn = true;
            }
        }

        tmpFilters.push(foundColumn ? updatedFilter : { field: field, value: value, operation: selected, dataType: dataType });
        gridState[gridId].filters = { conjunct: &#039;and&#039;, filterGroup: tmpFilters };
        gridState[gridId].basicFilters.filterGroup = tmpFilters;
        gridState[gridId].advancedFilters = {};

        filterDiv.addClass(&#039;hiddenFilter&#039;);
        gridData.pageRequest.eventType = &#039;filter&#039;;
        preparePageDataGetRequest(gridId);
    }

    function setDragAndDropListeners(elem) {
        elem.on(&#039;dragstart&#039;, function handleDragStartCallback(e) {
            e.originalEvent.dataTransfer.setData(&#039;text/plain&#039;, e.currentTarget.id);
            $(e.currentTarget).data(&#039;dragging&#039;, true);
        });
        elem.on(&#039;drop&#039;, handleDropCallback);
        elem.on(&#039;dragover&#039;, function handleHeaderDragOverCallback(e) {
            e.preventDefault();
            var gridId = elem.parents(&#039;.grid-header-div&#039;).data(&#039;grid_header_id&#039;);
            var dropIndicator = $(&#039;#drop_indicator_id_&#039; + gridId);
            if (!dropIndicator.length) {
                dropIndicator = $(&#039;&lt;div id=&quot;drop_indicator_id_&#039; + gridId + &#039;&quot; class=&quot;drop-indicator&quot; data-grid_id=&quot;&#039; + gridId + &#039;&quot;&gt;&lt;/div&gt;&#039;);
                dropIndicator.append(&#039;&lt;span class=&quot;drop-indicator-top&quot;&gt;&lt;/span&gt;&lt;span class=&quot;drop-indicator-bottom&quot;&gt;&lt;/span&gt;&#039;);
                gridState[gridId].grid.append(dropIndicator);
            }
            else
                dropIndicator.css(&#039;display&#039;, &#039;block&#039;);

            var originalColumn;
            gridState[gridId].grid.find(&#039;.grid-header-cell&#039;).each(function iterateGridHeadersCallback(idx, val) {
                if ($(val).data(&#039;dragging&#039;)) originalColumn = $(val);
            });

            if (originalColumn &amp;&amp; originalColumn[0] !== elem[0]) {
                dropIndicator.css(&#039;display&#039;, &#039;block&#039;);
                dropIndicator.css(&#039;height&#039;, elem.outerHeight());
                if (originalColumn.offset().left &lt; elem.offset().left) {
                    dropIndicator.css(&#039;left&#039;, elem.offset().left + elem.outerWidth());
                    dropIndicator.css(&#039;top&#039;, elem.offset().top);
                }
                else {
                    dropIndicator.css(&#039;left&#039;, elem.offset().left);
                    dropIndicator.css(&#039;top&#039;, elem.offset().top);
                }
            }
            else {
                dropIndicator.css(&#039;display&#039;, &#039;none&#039;);
            }
        });
    }

    function handleDropCallback(e) {
        var droppedCol = $(&#039;#&#039; + e.originalEvent.dataTransfer.getData(&#039;text&#039;));
        droppedCol.data(&#039;dragging&#039;, false);
        var targetCol = $(e.currentTarget);
        var id = targetCol.parents(&#039;.grid-header-div&#039;).length ? targetCol.parents(&#039;.grid-wrapper&#039;).data(&#039;grid_id&#039;) : null;
        var droppedId = droppedCol.parents(&#039;.grid-header-div&#039;).length ? droppedCol.parents(&#039;.grid-wrapper&#039;).data(&#039;grid_id&#039;) : null;
        if (id == null || droppedId == null || id !== droppedId) return;  
        if (gridState[id].updating) return;     
        if (droppedCol[0].cellIndex === targetCol[0].cellIndex) return;
        if (droppedCol[0].id === &#039;sliderDiv&#039;) return;

        var parentDiv = targetCol.parents(&#039;.grid-header-div&#039;);
        var parentDivId = parentDiv.data(&#039;grid_header_id&#039;);
        var gridWrapper = parentDiv.parent(&#039;.grid-wrapper&#039;);
        var colGroups = gridWrapper.find(&#039;colgroup&#039;);

        var droppedIndex = droppedCol[0].dataset.index;
        var targetIndex = targetCol[0].dataset.index;

        var droppedClone = droppedCol.clone(false, true);
        var targetClone = targetCol.clone(false, true);

        var droppedEvents = $._data(droppedCol[0], &#039;events&#039;);
        var targetEvents = $._data(targetCol[0], &#039;events&#039;);
        if (droppedEvents.click) setSortableClickListener(droppedClone);
        if (gridState[id].resizable) {
            droppedClone.on(&#039;mouseleave&#039;, mouseLeaveHandlerCallback);
            targetClone.on(&#039;mouseleave&#039;, mouseLeaveHandlerCallback);
        }
        setDragAndDropListeners(droppedClone);
        if (targetEvents.click) setSortableClickListener(targetClone);
        setDragAndDropListeners(targetClone);

        if (droppedClone.find(&#039;.filterSpan&#039;).length) attachFilterListener(droppedClone.find(&#039;.filterSpan&#039;));
        if (targetClone.find(&#039;.filterSpan&#039;).length) attachFilterListener(targetClone.find(&#039;.filterSpan&#039;));

        droppedCol.replaceWith(targetClone);
        targetCol.replaceWith(droppedClone);
        droppedClone[0].dataset.index = targetIndex;
        targetClone[0].dataset.index = droppedIndex;

        swapContentCells(parentDivId, droppedIndex, targetIndex);

        if (gridState[id].groupedBy &amp;&amp; gridState[id].groupedBy.length &amp;&amp; gridState[id].groupedBy !== &#039;none&#039;) {
            ++droppedIndex;
            ++targetIndex;
        }

        if (gridState[id].drillDown) {
            ++droppedIndex;
            ++targetIndex;
        }

        var targetWidth = colGroups[0].children[droppedIndex].style.width;
        var droppedWidth = colGroups[0].children[targetIndex].style.width;

        colGroups[0].children[targetIndex].style.width = targetWidth;
        colGroups[0].children[droppedIndex].style.width = droppedWidth;
        colGroups[1].children[targetIndex].style.width = targetWidth;
        colGroups[1].children[droppedIndex].style.width = droppedWidth;

        var sumRow = parentDiv.find(&#039;.summary-row-header&#039;);
        if (sumRow.length) {
            var droppedColSum = null,
                targetColSum = null;
            sumRow.children().each(function iterateSumRowCellsCallback(idx, val) {
                if ($(val).data(&#039;field&#039;) === droppedCol.data(&#039;field&#039;)) droppedColSum = $(val);
                else if ($(val).data(&#039;field&#039;) === targetCol.data(&#039;field&#039;)) targetColSum = $(val);
            });
            if (droppedColSum.length &amp;&amp; targetColSum.length) {
                var droppedColSumClone = droppedColSum.clone(true, true);
                var targetColSumClone = targetColSum.clone(true, true);
                droppedColSum.replaceWith(targetColSumClone);
                targetColSum.replaceWith(droppedColSumClone);
            }
        }
        $(&#039;#drop_indicator_id_&#039; + id).css(&#039;display&#039;, &#039;none&#039;);
        e.preventDefault();
        var evtObj = {
            element: gridState[id].grid,
            droppedColumn: droppedCol.data(&#039;field&#039;),
            targetColumn: targetCol.data(&#039;field&#039;),
            droppedIndex: droppedIndex,
            targetIndex: targetIndex
        };
        callGridEventHandlers(gridState[id].events.columnReorder, gridState[id].grid, evtObj);
    }

    function mouseLeaveHandlerCallback(e) {
        var target = $(e.currentTarget),
            targetOffset = target.offset(),
            targetWidth = target.innerWidth(),
            mousePos = { x: e.originalEvent.pageX, y: e.originalEvent.pageY },
            parentDiv = target.parents(&#039;.grid-header-wrapper&#039;),
            id = parentDiv.parent().data(&#039;grid_header_id&#039;),
            sliderDiv = $(&#039;#sliderDiv&#039; + id);

        if (Math.abs(mousePos.x - (targetOffset.left + targetWidth)) &lt; 10) {
            if (!sliderDiv.length) {
                sliderDiv = $(&#039;&lt;div id=&quot;sliderDiv&#039; + id + &#039;&quot; style=&quot;width:10px; height:&#039; + target.innerHeight() + &#039;px; cursor: col-resize; position: absolute&quot; draggable=true&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&#039;).appendTo(parentDiv);
                sliderDiv.on(&#039;dragstart&#039;, function handleResizeDragStartCallback(e) {
                    e.originalEvent.dataTransfer.setData(&#039;text&#039;, e.currentTarget.id);
                    gridState[id].resizing = true;
                });
                sliderDiv.on(&#039;dragend&#039;, function handleResizeDragEndCallback() {
                    gridState[id].resizing = false;
                });
                sliderDiv.on(&#039;dragover&#039;, function handleResizeDragOverCallback(e) {
                    e.preventDefault();
                });
                sliderDiv.on(&#039;drop&#039;, function handleResizeDropCallback(e) {
                    e.preventDefault();
                });
                sliderDiv.on(&#039;drag&#039;, handleResizeDragCallback);
                sliderDiv.on(&#039;dblclick&#039;, function doubleClickHandler() {
                    var targetCol = gridState[id].grid.find(&#039;#&#039; + sliderDiv.data(&#039;targetindex&#039;)),
                        targetColIdx = targetCol.data(&#039;index&#039;);
                    if (targetColIdx === gridState[id].columns.length - 1) return;
                    if (gridState[id].drillDown) ++targetColIdx;
                    if (gridState[id].groupedBy &amp;&amp; gridState[id].groupedBy.length) {
                        targetColIdx = targetColIdx + gridState[id].groupedBy.length;
                    }

                    var colGroups = gridState[id].grid.find(&#039;colgroup&#039;).filter(function removeParentOrChildCols() {
                        var cg = $(this);
                        if (gridState[id].parentGridId != null) {
                            return cg.parents(&#039;tr.drill-down-parent&#039;).length;
                        }
                        else return !cg.parents(&#039;tr.drill-down-parent&#039;).length;
                    });

                    var headerCol = $($(colGroups[0]).children()[targetColIdx]),
                        contentCol = $($(colGroups[1]).children()[targetColIdx]);

                    var tables = gridState[id].grid.find(&#039;table&#039;).filter(function removeParentOrChildCols() {
                        var cg = $(this);
                        if (gridState[id].parentGridId != null) {
                            return cg.parents(&#039;tr.drill-down-parent&#039;).length;
                        }
                        else return !cg.parents(&#039;tr.drill-down-parent&#039;).length;
                    });

                    var headerCell = $(tables[0]).find(&#039;th&#039;)[targetColIdx],
                        aggregateCell = $(tables[0]).find(&#039;td&#039;)[targetColIdx] || null,
                        headerMultiplier = 8.1,
                        aggregateMultiplier = 7.5,
                        contentMultiplier = 6.75,
                        maxLength = headerCell.innerText.length * headerMultiplier,
                        newWidth,
                        column = gridState[id].columns[gridState[id].columnIndices[targetCol.data(&#039;field&#039;)]];

                    if (column.sortable) maxLength += 16;

                    if (column.filterable) maxLength += 40;

                    if (aggregateCell &amp;&amp; aggregateCell.innerText.length * aggregateMultiplier &gt; maxLength)
                        maxLength = aggregateCell.innerText.length * aggregateMultiplier;

                    $(tables[1]).find(&#039;tr&#039;).each(function findTargetContentCells() {
                        var row = $(this);
                        if (gridState[id].parentGridId != null) {
                            if (row.parents(&#039;tr.drill-down-parent&#039;).length) {
                                if (row.find(&#039;td&#039;)[targetColIdx].innerText.length * contentMultiplier &gt; maxLength)
                                    maxLength = row.find(&#039;td&#039;)[targetColIdx].innerText.length * contentMultiplier;
                            }
                        }
                        else {
                            if (!row.parents(&#039;tr.drill-down-parent&#039;).length) {
                                if (row.find(&#039;td&#039;)[targetColIdx].innerText.length * contentMultiplier &gt; maxLength)
                                    maxLength = row.find(&#039;td&#039;)[targetColIdx].innerText.length * contentMultiplier;
                            }
                        }
                    });

                    newWidth = Math.ceil(maxLength) + 24;
                    tables.css(&#039;width&#039;, tables.width() - (headerCol.width() - newWidth));
                    headerCol.css(&#039;width&#039;, newWidth);
                    contentCol.css(&#039;width&#039;, newWidth);
                });
            }
            sliderDiv.data(&#039;targetindex&#039;, target[0].id);
            sliderDiv.css(&#039;top&#039;, targetOffset.top + &#039;px&#039;);
            sliderDiv.css(&#039;left&#039;, (targetOffset.left + targetWidth -4) + &#039;px&#039;);
            sliderDiv.css(&#039;position&#039;, &#039;absolute&#039;);
        }
    }

    function setSortableClickListener(elem) {
        elem.on(&#039;click&#039;, function handleHeaderClickCallback(e) {
            var headerDiv = elem.parents(&#039;.grid-header-div&#039;);
            var id = parseInt(headerDiv.data(&#039;grid_header_id&#039;));
            if (gridState[id].updating) return;     
            var field = elem.data(&#039;field&#039;),
                foundColumn = false;

            if (gridState[id].groupedBy.length) {
                for (var j = 0; j &lt; gridState[id].groupedBy.length; j++) {
                    if (gridState[id].groupedBy[j].field === field) return; 
                }
            }

            for (var i = 0; i &lt; gridState[id].sortedOn.length; i++) {
                if (gridState[id].sortedOn[i].field === field) {
                    foundColumn = true;
                    if (gridState[id].sortedOn[i].sortDirection === &#039;asc&#039;) {
                        gridState[id].sortedOn[i].sortDirection = &#039;desc&#039;;
                        elem.find(&#039;.sortSpan&#039;).addClass(&#039;sort-desc&#039;).removeClass(&#039;sort-asc&#039;);
                    }
                    else {
                        gridState[id].sortedOn =  gridState[id].sortedOn.filter(function filterSortedColumns(item) {
                            return item.field !== field;
                        });
                        elem.find(&#039;.sortSpan&#039;).remove();
                        gridState[id].alteredData = cloneGridData(gridState[id].originalData);
                    }
                }
            }

            if (!foundColumn) {
                gridState[id].sortedOn.push({ field: field, sortDirection: &#039;asc&#039; });
                elem.find(&#039;.header-anchor&#039;).append(&#039;&lt;span class=&quot;sort-asc sortSpan&quot;&gt;Sort&lt;/span&gt;&#039;);
            }
            gridState[id].pageRequest.eventType = &#039;sort&#039;;
            preparePageDataGetRequest(id);
            e.preventDefault();
        });
    }

    function setFilterableClickListener(elem, gridData, col) {
        var type = gridData.columns[gridData.columnIndices[col]].type || &#039;string&#039;;
        var anchor = $(&#039;&lt;a href=&quot;#&quot;&gt;&lt;/a&gt;&#039;).appendTo(elem);
        anchor.append(&#039;&lt;span class=&quot;filterSpan&quot; data-type=&quot;&#039; + type + &#039;&quot; data-field=&quot;&#039; + elem.data(&#039;field&#039;) + &#039;&quot;&gt;&lt;/span&gt;&#039;);
        attachFilterListener(anchor);
        if ($(document).find(&#039;.filterSpan&#039;).length &lt; 2) {
            $(document).on(&#039;click&#039;, function hideFilterHandler(e) {
                if (!$(e.target).hasClass(&#039;filter-div&#039;)) {
                    if ($(e.target).parents(&#039;.filter-div&#039;).length &lt; 1) {
                        $(document).find(&#039;.filter-div&#039;).each(function iterateFilterDivsCallback(idx, val) {
                            if ($(val).find(&#039;.filterInput&#039;).length)
                                $(val).find(&#039;.filterInput&#039;).val(&#039;&#039;);
                            $(val).addClass(&#039;hiddenFilter&#039;);
                        });
                    }
                }
            });
        }
        $(document).on(&#039;scroll&#039;, function scrollFilterHandler() {
            $(document).find(&#039;.filter-div&#039;).each(function iterateFilterDivsCallback(idx, val) {
                var filter = $(val);
                if (!filter.hasClass(&#039;hiddenFilter&#039;)) {
                    var gridWrapper = filter.parents(&#039;.grid-wrapper&#039;);
                    var filterCell = gridWrapper.find(&#039;th&#039;).filter(function headerIterationCallback(idx, val) {
                        return $(val).data(&#039;field&#039;) === filter.data(&#039;parentfield&#039;);
                    });
                    var filterCellOffset = filterCell.offset();
                    filter.css(&#039;top&#039;, (filterCellOffset.top + filterCell.height() - $(window).scrollTop()));
                    filter.css(&#039;left&#039;, (filterCellOffset.left + filterCell.width() - $(window).scrollLeft()));
                }
            });
        });
    }

    function handleResizeDragCallback(e) {
        e.preventDefault();
        var sliderDiv = $(e.currentTarget);
        var id = sliderDiv.parents(&#039;.grid-wrapper&#039;).data(&#039;grid_id&#039;);
        if (gridState[id].updating) return;     
        var targetCell = document.getElementById(sliderDiv.data(&#039;targetindex&#039;));
        var targetBox = targetCell.getBoundingClientRect();
        var endPos = e.originalEvent.pageX;
        var startPos = targetBox.left;
        var width = endPos - startPos;
        var space = endPos - targetBox.right;

        if (width &gt; 11) {
            var index = targetCell.dataset.index;
            var gridWrapper = $(targetCell).parents(&#039;.grid-wrapper&#039;).first();
            var colGroups = gridWrapper.find(&#039;colgroup&#039;);
            var tables = gridWrapper.find(&#039;table&#039;);
            if (gridState[id].groupedBy &amp;&amp; gridState[id].groupedBy.length &amp;&amp; gridState[id].groupedBy !== &#039;none&#039;)
                index += gridState[id].groupedBy.length;
            if (gridState[id].drillDown)
                ++index;

            var contentDiv = gridWrapper.find(&#039;.grid-content-div&#039;);
            var scrollLeft = contentDiv.scrollLeft();
            var clientWidth = contentDiv[0].clientWidth;
            var scrollWidth = contentDiv[0].scrollWidth;
            var add = scrollLeft + clientWidth;
            var isTrue = add === scrollWidth;

            if (space &lt; 0 &amp;&amp; scrollWidth &gt; clientWidth &amp;&amp; isTrue) {
                space -= -3;
                width -= -3;
            }

            for (var i = 0; i &lt; colGroups.length; i++) {
                var currWidth = $(tables[i]).width();
                $(colGroups[i].children[index]).width(width);
                $(tables[i]).width(currWidth + space);

            }
            sliderDiv.css(&#039;left&#039;, e.originalEvent.pageX + &#039;px&#039;);
        }
    }

    function swapContentCells(gridId, droppedIndex, targetIndex) {
        var gridData = gridState[gridId];
        $(&#039;#grid-content-&#039; + gridId).find(&#039;tr&#039;).filter(function filterNestedGridRows() {
            return !$(this).hasClass(&#039;drill-down-parent&#039;) &amp;&amp; !$(this).parents(&#039;.drill-down-parent&#039;).length;
        }).each(function iterateContentRowsCallback(idx, val) {
            if ($(val).hasClass(&#039;grouped_row_header&#039;))
                return true;
            var droppedIdx = 1 + parseInt(droppedIndex);
            var targetIdx = 1 + parseInt(targetIndex);
            if (gridData.groupedBy &amp;&amp; gridData.groupedBy.length &amp;&amp; gridData.groupedBy !== &#039;none&#039;) {
                droppedIdx++;
                targetIdx++;
            }

            if (gridData.drillDown) {
                ++droppedIdx;
                ++targetIdx;
            }

            var droppedCell = $(val).children(&#039;td:nth-child(&#039; + droppedIdx + &#039;)&#039;);
            var targetCell = $(val).children(&#039;td:nth-child(&#039; + targetIdx + &#039;)&#039;);

            var droppedClone = droppedCell.clone(true, true);
            var targetClone = targetCell.clone(true, true);
            targetCell.replaceWith(droppedClone);
            droppedCell.replaceWith(targetClone);

            droppedClone[0].dataset.index = targetIndex;
            targetClone[0].dataset.index = droppedIndex;
        });
    }

    function preparePageDataGetRequest(id) {
        gridState[id].updating = true;
        var gridData = gridState[id];
        var pageNum = gridData.pageRequest.pageNum || gridData.pageNum;
        var pageSize = gridData.pageRequest.pageSize || gridData.pageSize;

        var requestObj = {};
        if (gridData.sortable) requestObj.sortedOn = gridData.sortedOn.length ? gridData.sortedOn : [];
        if (gridData.filterable) requestObj.filters = gridData.filters.filterGroup &amp;&amp; gridData.filters.filterGroup.length? gridData.filters : { conjunct: null, filterGroup: [] };
        if (gridData.groupable) requestObj.groupedBy = gridData.groupedBy.length? gridData.groupedBy : [];

        requestObj.pageSize = pageSize;
        requestObj.pageNum = gridData.pageRequest.eventType === &#039;filter&#039; ? 1 : pageNum;

        gridData.grid.find(&#039;.grid-content-div&#039;).empty();

        callGridEventHandlers(gridState[id].events.pageRequested, gridData.grid, { element: gridData.grid });
        if (gridData.dataSource.get &amp;&amp; typeof gridData.dataSource.get === &#039;function&#039;) gridData.dataSource.get(requestObj, getPageDataRequestCallback);
        else {
            if (!gridData.alteredData || gridData.pageRequest.eventType === &#039;filter&#039;) gridData.alteredData = cloneGridData(gridData.originalData);
            getPageData(requestObj, id, getPageDataRequestCallback);
        }

        function getPageDataRequestCallback(response) {
            if (response) {
                gridData.dataSource.data = response.data;
                gridData.pageSize = requestObj.pageSize;
                gridData.pageNum = requestObj.pageNum;
                gridData.dataSource.rowCount = response.rowCount != null ? response.rowCount : response.data.length;
                gridData.groupedBy = requestObj.groupedBy || [];
                gridData.sortedOn = requestObj.sortedOn || [];
                gridData.filters = requestObj.filters || {};

                if (gridData.pageRequest.eventType === &#039;newGrid&#039; || gridData.pageRequest.eventType === &#039;group&#039;)
                    setColWidth(gridData, gridState[id].grid);

                createGridContent(gridData, gridState[id].grid);
                if (gridData.pageRequest.eventType === &#039;filter&#039; || gridData.pageRequest.eventType === &#039;pageSize&#039;) {
                    gridData.grid.find(&#039;.grid-footer-div&#039;).empty();
                    createGridFooter(gridData, gridData.grid);
                }
                if (gridData.pageRequest.eventType === &#039;filter&#039; &amp;&amp; gridData.aggregates &amp;&amp; gridData.aggregates.positionAt === &#039;top&#039;) {
                    if (response.aggregations) {
                        for (var col in response.aggregations) {
                            if (col in gridData.aggregates)
                                gridData.aggregates[col].value = response.aggregations[col];
                        }
                        constructAggregationsFromServer(id, gridData.gridAggregations);
                    }
                    buildHeaderAggregations(id);
                }
                gridData.pageRequest = {};
            }
        }
    }

    function prepareGridDataUpdateRequest(id) {
        gridState[id].updating = true;
        var requestObj = {
            models: gridState[id].putRequest.models,
            pageNum: gridState[id].putRequest.pageNum
        };

        gridState[id].dataSource.put(requestObj, updatePageDataPutRequestCallback);

        function updatePageDataPutRequestCallback(response) {
            gridState[id].updating = false;
            if (response) {
                gridState[id].grid.find(&#039;.dirty&#039;).add(&#039;.dirty-blank&#039;).each(function iterateDirtySpansCallback(idx, val) {
                    var index = $(val).parents(&#039;tr&#039;).index();
                    var field = $(val).parents(&#039;td&#039;).data(&#039;field&#039;);
                    var origIdx = gridState[id].dataSource.data[index]._initialRowIndex;
                    gridState[id].originalData[origIdx][field] = gridState[id].dataSource.data[index][field];
                    $(val).remove();
                });
            }
            else {
                gridState[id].grid.find(&#039;.dirty&#039;).add(&#039;.dirty-blank&#039;).each(function iterateDirtySpansCallback(idx, val) {
                    var cell = $(val).parents(&#039;td&#039;),
                        index = cell.parents(&#039;tr&#039;).index(),
                        field = cell.data(&#039;field&#039;),
                        column = gridState[id].columns[gridState[id].columnIndices[field]],
                        text = getFormattedCellText(column, gridState[id].originalData[index][field]) || gridState[id].originalData[index][field];
                    cell.text(text);
                    $(val).remove();
                });
            }
        }
    }

    function getPageData(requestObj, id, callback) {
        var eventType = gridState[id].pageRequest.eventType;
        var fullGridData = cloneGridData(gridState[id].alteredData);

        if (eventType === &#039;page&#039; || eventType === &#039;pageSize&#039; || eventType === &#039;newGrid&#039;) {
            limitPageData(requestObj, fullGridData, callback);
            return;
        }
        if (requestObj.filters &amp;&amp; requestObj.filters.filterGroup &amp;&amp; requestObj.filters.filterGroup.length) {
            fullGridData = expressionParser.createFilterTreeFromFilterObject(requestObj.filters).filterCollection(cloneGridData(gridState[id].originalData));
            requestObj.pageNum = 1;     
            gridState[id].alteredData = fullGridData;
        }
        if (requestObj.groupedBy &amp;&amp; requestObj.groupedBy.length || requestObj.sortedOn.length) {
            var sortedData = sortGridData((requestObj.groupedBy || []).concat(requestObj.sortedOn), fullGridData || cloneGridData(gridState[id].originalData), id);
            gridState[id].alteredData = sortedData;
            limitPageData(requestObj, sortedData, callback);
            return;
        }
        gridState[id].alteredData = fullGridData;
        limitPageData(requestObj, fullGridData, callback);
    }


    function limitPageData(requestObj, fullGridData, callback) {
        var returnData;
        if (requestObj.pageSize &gt;= fullGridData.length) returnData = fullGridData;
        else {
            var startRow = (requestObj.pageNum-1) * (requestObj.pageSize);
            var endRow = fullGridData.length &gt;= (startRow + parseInt(requestObj.pageSize)) ? (startRow + parseInt(requestObj.pageSize)) : fullGridData.length;
            returnData = fullGridData.slice(startRow, endRow);
        }

        callback({ rowCount: fullGridData.length, data: returnData });
    }

    function comparator(val, base, type) {
        switch (type) {
            case &#039;eq&#039;:
            case &#039;===&#039;:
                return val === base;
            case &#039;==&#039;:
                return val == base;
            case &#039;neq&#039;:
            case &#039;!==&#039;:
                return val !== base;
            case &#039;!=&#039;:
                return val != base;
            case &#039;gte&#039;:
            case &#039;&gt;=&#039;:
                return val &gt;= base;
            case &#039;gt&#039;:
            case &#039;&gt;&#039;:
                return val &gt; base;
            case &#039;lte&#039;:
            case &#039;&lt;=&#039;:
                return val &lt;= base;
            case &#039;lt&#039;:
            case &#039;&lt;&#039;:
                return val &lt; base;
            case &#039;not&#039;:
            case &#039;!&#039;:
            case &#039;falsey&#039;:
                return !val;
            case &#039;truthy&#039;:
                return !!val;
            case &#039;ct&#039;:
                return !!~val.toLowerCase().indexOf(base.toLowerCase());
            case &#039;nct&#039;:
                return !~val.toLowerCase().indexOf(base.toLowerCase());
        }
    }

    function sortGridData (sortedItems, gridData, gridId) {
        sortedItems.forEach(function _sortItems(cur, idx) {
            var columnIdx = gridState[gridId].columnIndices[cur.field];
            var column = gridState[gridId].columns[columnIdx];
            if (idx === 0)
                gridData = mergeSort(gridData, cur, column.type || &#039;string&#039;);
            else {
                var sortedGridData = [];
                var itemsToSort = [];
                gridData.forEach(function _sortGridData(data, i) {
                    var prevField = sortedItems[idx - 1].field,
                        prevVal = itemsToSort.length ? itemsToSort[0][prevField] : null,
                        prevColIdx = itemsToSort.length ? gridState[gridId].columnIndices[prevField] : null,
                        dataType = itemsToSort.length ? gridState[gridId].columns[prevColIdx].type : null;
                    if (!itemsToSort.length || comparator(normalizeValues(dataType, prevVal), normalizeValues(dataType, gridData[i][prevField]), predicates.strictEqual))
                        itemsToSort.push(gridData[i]);
                    else {
                        if (itemsToSort.length === 1) sortedGridData = sortedGridData.concat(itemsToSort);
                        else sortedGridData = sortedGridData.concat(mergeSort(itemsToSort, sortedItems[idx], column.type || &#039;string&#039;));
                        itemsToSort.length = 0;
                        itemsToSort.push(gridData[i]);
                    }
                    if (i === gridData.length - 1)
                        sortedGridData = sortedGridData.concat(mergeSort(itemsToSort, sortedItems[idx], column.type || &#039;string&#039;));
                });
                gridData = sortedGridData;
            }
        });
        return gridData;
    }

    function mergeSort(data, sortObj, type) {
        if (data.length &lt; 2) return data;
        var middle = parseInt(data.length / 2);
        var left   = data.slice(0, middle);
        var right  = data.slice(middle, data.length);
        return merge(mergeSort(left, sortObj, type), mergeSort(right, sortObj, type), sortObj, type);
    }

    function merge(left, right, sortObj, type) {
        var result = [], leftVal, rightVal;
        while (left.length &amp;&amp; right.length) {
            leftVal = normalizeValues(type, left[0][sortObj.field]);
            rightVal = normalizeValues(type, right[0][sortObj.field]);
            var operator = sortObj.sortDirection === &#039;asc&#039; ? predicates.lessThanOrEqual : predicates.greaterThanOrEqual;
            comparator(leftVal, rightVal, operator) ? result.push(left.shift()) : result.push(right.shift());
        }

        while (left.length)
            result.push(left.shift());

        while (right.length)
            result.push(right.shift());

        return result;
    }

    function normalizeValues(dataType, val) {
        if (val == null) return null;
        var value;
        switch(dataType) {
            case &#039;time&#039;:
                value = getNumbersFromTime(val);
                if (val.indexOf(&#039;PM&#039;) &gt; -1) value[0] += 12;
                value = convertTimeArrayToSeconds(value);
                break;
            case &#039;datetime&#039;:
                var re = new RegExp(dataTypes[&#039;datetime&#039;]),
                    execVal1;
                if (re.test(val)) {
                    execVal1 = re.exec(val);

                    var dateComp1 = execVal1[2],
                        timeComp1 = execVal1[42];
                    timeComp1 = getNumbersFromTime(timeComp1);
                    if (timeComp1[3] &amp;&amp; timeComp1[3] === &#039;PM&#039;)
                        timeComp1[0] += 12;
                    dateComp1 = new Date(dateComp1);
                    value = dateComp1.getTime() + convertTimeArrayToSeconds(timeComp1);
                }
                else {
                    value = 0;
                }
                break;
            case &#039;number&#039;:
                value = parseFloat(val);
                break;
            case &#039;date&#039;:
                value = new Date(val);
                break;
            case &#039;boolean&#039;:
                value = val.toString();
                break;
            default:
                value = val.toString();
                break;
        }
        return value;
    }

    function callGridEventHandlers(events, context, param) {
        if (events.length) {
            events.forEach(function callEventHandlers(fn) {
                fn.call(context, param);
            });
        }
    }

    function existsInPutRequest(putRequest, model) {
        putRequest.forEach(function _findModelIdx(cur, idx) {
            if (model._initialRowIndex == putRequest[idx].dirtyData._initialRowIndex)
                return idx;
        });
        return -1;
    }

    function getFormattedCellText(column, value) {
        var text,
            type = column.type || &#039;string&#039;;
        if (value == null || (&#039;&#039; === value &amp;&amp; column.nullable)) return column.nullable ? null : &#039; &#039;;
        switch(type) {
            case &#039;number&#039;:
                text = formatNumericCellData(value, column.format);
                break;
            case &#039;date&#039;:
                text = formatDateCellData(value, column.format);
                break;
            case &#039;time&#039;:
                text = formatTimeCellData(value, column);
                break;
            case &#039;datetime&#039;:
                var re = new RegExp(dataTypes[&#039;datetime&#039;]),
                    execVal = re.exec(value),
                    timeText = formatTimeCellData(execVal[42], column),
                    dateComp = new Date(execVal[2]),
                    dateFormat = column.format || &#039;mm/dd/yyyy hh:mm:ss&#039;;
                dateFormat = dateFormat.substring(0, (dateFormat.indexOf(&#039; &#039;) || dateFormat.indexOf(&#039;T&#039;)));
                text = dateFormat.replace(&#039;dd&#039;, dateComp.getUTCDate().toString())
                        .replace(&#039;mm&#039;, (dateComp.getUTCMonth() + 1).toString())
                        .replace(&#039;yyyy&#039;, dateComp.getUTCFullYear().toString()) + &#039; &#039; + timeText;
                break;
            case &#039;string&#039;:
            case &#039;boolean&#039;:
                text = value;
                break;
            default:
                text = value;
        }

        var template = column.template;
        if (template &amp;&amp; text !== &#039;&#039;) {
            if (typeof template === &#039;function&#039;)
                return template.call(column, text);
            else if (typeof template === &#039;string&#039;)
                return template.replace(&#039;{{data}}&#039;, text);
            return text;
        }
        return text;
    }

    function getNumbersFromTime(val) {
        var re = new RegExp(dataTypes.time);
        if (!re.test(val)) return [];
        var timeGroups = re.exec(val);
        var hours = timeGroups[1] ? +timeGroups[1] : +timeGroups[6];
        var minutes, seconds, meridiem, retVal = [];
        if (timeGroups[2]) {
            minutes = timeGroups[3] || &#039;00&#039;;
            seconds = timeGroups[4]  || &#039;00&#039;;
            meridiem = timeGroups[5].replace(&#039; &#039;, &#039;&#039;) || null;
        }
        else if (timeGroups[6]) {
            minutes = timeGroups[8] || &#039;00&#039;;
            seconds = timeGroups[9] || &#039;00&#039;;
        }
        else{
            minutes = &#039;00&#039;;
            seconds = &#039;00&#039;;
        }
        retVal.push(hours);
        retVal.push(minutes);
        retVal.push(seconds);
        if (meridiem) retVal.push(meridiem);
        return retVal;
    }

    function convertTimeArrayToSeconds(timeArray) {
        var hourVal = parseInt(timeArray[0].toString()) === 12 || parseInt(timeArray[0].toString()) === 24 ? parseInt(timeArray[0].toString()) - 12 : parseInt(timeArray[0]);
        return 3660 * hourVal + 60 * parseInt(timeArray[1]) + parseInt(timeArray[2]);
    }

    function validateCharacter(code, dataType) {
        var key = String.fromCharCode(code);
        if (dataTypes[dataType]) {
            var re = new RegExp(dataTypes[dataType + &#039;Char&#039;]);
            return re.test(key);
        }
        return true;
    }

    function exportDataAsExcelFile(gridId, option) {
        if (excelExporter &amp;&amp; typeof excelExporter.createWorkBook === &#039;function&#039;) {
            determineGridDataToExport(gridId, (option || &#039;page&#039;), function gridDataCallback(excelDataAndColumns) {
                excelExporter.exportWorkBook(excelExporter.createWorkBook().createWorkSheet(excelDataAndColumns.data, excelDataAndColumns.columns, &#039;testSheet&#039;));
            });
        }
    }

    function determineGridDataToExport(gridId, option, callback) {
        var columns = getGridColumns(gridId);
        switch (option) {
            case &#039;select&#039;:
                var selectedData = gridState[gridId].grid[0].grid.selectedData;
                if (!selectedData.length) return;
                var data = [], currentRow = selectedData[0].rowIndex;
                selectedData.forEach(function _constructObjects(item, idx) {
                    if (!data.length || currentRow !== item.rowIndex) {
                        var tmpObj = {};
                        tmpObj[item.field] = selectedData[idx].data;
                        data.push(tmpObj);
                        currentRow = selectedData[idx].rowIndex;
                    }
                    else data[data.length - 1][item.field] = item.data;
                });
                callback({ data: data, columns: columns});
                break;
            case &#039;all&#039;:
                if (typeof gridState[gridId].dataSource.get === &#039;function&#039; &amp;&amp; gridState[gridId].dataSource.rowCount &gt; gridState[gridId].pageSize) {
                    gridState[gridId].dataSource.get(createExcelRequestObject(gridId), function excelDataCallback(response) {
                        callback({ data: response.data, columns: columns});
                    });
                }
                else callback({ data: gridState[gridId].originalData, columns: columns });
                break;
            case &#039;page&#039;:
            default:
                callback({ data: gridState[gridId].dataSource.data, columns: columns });
        }
    }

    function getGridColumns(gridId) {
        return gridState[gridId].columns.filter(function _returnDisplayedColumns(col) {
            return !col.isHidden;
        });
    }

    function createExcelRequestObject(gridId) {
        var gridData = gridState[gridId],
            requestObj = {};
        if (gridData.sortable) requestObj.sortedOn = gridData.sortedOn.length ? gridData.sortedOn : [];
        if (gridData.filterable) requestObj.filters = gridData.filters.filterGroup &amp;&amp; gridData.filters.filterGroup.length? gridData.filters : { conjunct: null, filterGroup: [] };
        if (gridData.groupable) requestObj.groupedBy = gridData.groupedBy.length? gridData.groupedBy : [];

        requestObj.pageSize = gridData.dataSource.rowCount;
        requestObj.pageNum = 1;
        return requestObj;
    }

    dataTypes = {
        number: &#039;^-?(?:[1-9]{1}[0-9]{0,2}(?:,[0-9]{3})*(?:\\.[0-9]+)?|[1-9]{1}[0-9]{0,}(?:\\.[0-9]+)?|0(?:\\.[0-9]+)?|(?:\\.[0-9]+)?)$&#039;,
        numberChar: &#039;[\\d,\\.-]&#039;,
        integer: &#039;^\\-?\\d+$&#039;,
        time: &#039;^(0?[1-9]|1[012])(?:(?:(:|\\.)([0-5]\\d))(?:\\2([0-5]\\d))?)?(?:(\\ [AP]M))$|^([01]?\\d|2[0-3])(?:(?:(:|\\.)([0-5]\\d))(?:\\7([0-5]\\d))?)$&#039;,
        timeChar: &#039;[\\d\\.:\\ AMP]&#039;,
        date: &#039;^(?:(?:(?:(?:(?:(?:(?:(0?[13578]|1[02])(\\/|-|\\.)(31))\\2|(?:(0?[1,3-9]|1[0-2])(\\/|-|\\.)(29|30)\\5))|(?:(?:(?:(?:(31)(\\/|-|\\.)(0?[13578]|1[02])\\8)|(?:(29|30)(\\/|-|\\.)&#039; +
        &#039;(0?[1,3-9]|1[0-2])\\11)))))((?:1[6-9]|[2-9]\\d)?\\d{2})|(?:(?:(?:(0?2)(\\/|-|\\.)(29)\\15)|(?:(29)(\\/|-|\\.)(0?2))\\18)((?:(?:1[6-9]|[2-9]\\d)?(?:0[48]|[2468][048]|[13579][26])&#039; +
        &#039;|(?:(?:16|[2468][048]|[3579][26])00))))|(?:(?:((?:0?[1-9])|(?:1[0-2]))(\\/|-|\\.)(0?[1-9]|1\\d|2[0-8]))\\22|(0?[1-9]|1\\d|2[0-8])(\\/|-|\\.)((?:0?[1-9])|(?:1[0-2]))\\25)((?:1[6-9]|[2-9]\\d)?\\d{2}))))&#039; +
        &#039;|(?:(?:((?:1[6-9]|[2-9]\\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00)))(\\/|-|\\.)(?:(?:(?:(0?2)(?:\\29)(29))))|((?:1[6-9]|[2-9]\\d)?\\d{2})(\\/|-|\\.)&#039; +
        &#039;(?:(?:(?:(0?[13578]|1[02])\\33(31))|(?:(0?[1,3-9]|1[0-2])\\33(29|30)))|((?:0?[1-9])|(?:1[0-2]))\\33(0?[1-9]|1\\d|2[0-8]))))$&#039;,
        datetime: &#039;^(((?:(?:(?:(?:(?:(?:(?:(0?[13578]|1[02])(\\/|-|\\.)(31))\\4|(?:(0?[1,3-9]|1[0-2])(\\/|-|\\.)(29|30)\\7))|(?:(?:(?:(?:(31)(\\/|-|\\.)(0?[13578]|1[02])\\10)|(?:(29|30)(\\/|-|\\.)&#039; +
        &#039;(0?[1,3-9]|1[0-2])\\13)))))((?:1[6-9]|[2-9]\\d)?\\d{2})|(?:(?:(?:(0?2)(\\/|-|\\.)(29)\\17)|(?:(29)(\\/|-|\\.)(0?2))\\20)((?:(?:1[6-9]|[2-9]\\d)?(?:0[48]|[2468][048]|[13579][26])&#039; +
        &#039;|(?:(?:16|[2468][048]|[3579][26])00))))|(?:(?:((?:0?[1-9])|(?:1[0-2]))(\\/|-|\\.)(0?[1-9]|1\\d|2[0-8]))\\24|(0?[1-9]|1\\d|2[0-8])(\\/|-|\\.)((?:0?[1-9])|(?:1[0-2]))\\27)&#039; +
        &#039;((?:1[6-9]|[2-9]\\d)?\\d{2}))))|(?:(?:((?:1[6-9]|[2-9]\\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00)))(\\/|-|\\.)(?:(?:(?:(0?2)(?:\\31)(29))))&#039; +
        &#039;|((?:1[6-9]|[2-9]\\d)?\\d{2})(\\/|-|\\.)(?:(?:(?:(0?[13578]|1[02])\\35(31))|(?:(0?[1,3-9]|1[0-2])\\35(29|30)))|((?:0?[1-9])|(?:1[0-2]))\\35(0?[1-9]|1\\d|2[0-8])))))&#039; +
        &#039;(?: |T)((0?[1-9]|1[012])(?:(?:(:|\\.)([0-5]\\d))(?:\\44([0-5]\\d))?)?(?:(\\ [AP]M))$|([01]?\\d|2[0-3])(?:(?:(:|\\.)([0-5]\\d))(?:\\49([0-5]\\d))?)$))&#039;,
        dateChar: &#039;\\d|\\-|\\/|\\.&#039;
    };

    events = [&#039;cellEditChange&#039;, &#039;beforeCellEdit&#039;, &#039;afterCellEdit&#039;, &#039;pageRequested&#039;, &#039;beforeDataBind&#039;, &#039;afterDataBind&#039;, &#039;columnReorder&#039;];

    aggregates = { count: &#039;Count: &#039;, average: &#039;Avg: &#039;, max: &#039;Max: &#039;, min: &#039;Min: &#039;, total: &#039;Total: &#039; };

    function formatTimeCellData(time, column) {
        var timeArray = getNumbersFromTime(time),
            formattedTime,
            format = column.format || &#039;hh:mm:ss&#039;,
            timeFormat = column.timeFormat || &#039;24&#039;;

        if (timeArray.length &lt; 2) return &#039;&#039;;

        if (~format.indexOf(&#039; &#039;) || ~format.indexOf(&#039;T&#039;)) {
            var dateIdxEnd = ~format.indexOf(&#039; &#039;) ? format.indexOf(&#039; &#039;) : format.indexOf(&#039;T&#039;);
            format = format.substring(dateIdxEnd + 1, format.length);
        }

        if (timeFormat == &#039;24&#039; &amp;&amp; timeArray.length === 4 &amp;&amp; timeArray[3] === &#039;PM&#039;)
            timeArray[0] = timeArray[0] === &#039;12&#039; ? &#039;00&#039; : (parseInt(timeArray[0]) + 12).toString();
        else if (timeFormat === &#039;12&#039; &amp;&amp; parseInt(timeArray[0]) &gt; 12) {
            timeArray[0] = (parseInt(timeArray[0]) - 12).toString();
            timeArray[3] = &#039;PM&#039;;
        }
        else if (timeFormat === &#039;12&#039; &amp;&amp; timeArray.length &lt; 4)
            timeArray[3] = &#039;AM&#039;;

        timeArray[0] = timeArray[0] ? timeArray[0] : &#039;00&#039;;
        timeArray[1] = timeArray[1] ? timeArray[1] : &#039;00&#039;;
        timeArray[2] = timeArray[2] ? timeArray[2] : &#039;00&#039;;
        var meridiem = timeArray[3] || &#039;AM&#039;;

        if (timeArray.length &amp;&amp; format) {
            formattedTime = format.replace(&#039;hh&#039;, timeArray[0]).replace(&#039;mm&#039;, timeArray[1]).replace(&#039;ss&#039;, timeArray[2]).replace(&#039;A/PM&#039;, meridiem);
            return timeArray.length === 4 ? formattedTime + &#039; &#039; + timeArray[3] : formattedTime;
        }
        else if (timeArray.length) {
            formattedTime = timeArray[0] + &#039;:&#039; + timeArray[1] + &#039;:&#039; + timeArray[2] + &#039; &#039; + timeArray[3];
            return timeArray.length === 3 ? formattedTime + &#039; &#039; + timeArray[3] : formattedTime;
        }
        return &#039;&#039;;
    }

    function formatDateCellData(date, format) {
        if (!format) return date;
        var parseDate = Date.parse(date);
        var jsDate = new Date(parseDate);
        if (!isNaN(parseDate) &amp;&amp; format)
            return format.replace(&#039;mm&#039;, (jsDate.getUTCMonth() + 1).toString()).replace(&#039;dd&#039;, jsDate.getUTCDate().toString()).replace(&#039;yyyy&#039;, jsDate.getUTCFullYear().toString());
        else if (!isNaN(parseDate))
            return new Date(jsDate);
        return &#039;&#039;;
    }

    function formatNumericCellData(num, format) {
        if (!format) return num;
        var formatSections = [];
        var dataSections = [];
        format = format.toUpperCase();
        var formatObject = (~format.indexOf(&#039;P&#039;) || ~format.indexOf(&#039;C&#039;) || ~format.indexOf(&#039;N&#039;)) ? createCurrencyNumberOrPercentFormat(format) : verifyFormat(format);
        format = formatObject.value;

        var formatDecimalIndex = ~format.indexOf(&#039;.&#039;) ? format.indexOf(&#039;.&#039;) : format.length;
        formatSections[0] = format.substring(0, formatDecimalIndex).split(&#039;&#039;).reverse().join(&#039;&#039;);
        if (formatDecimalIndex &lt; format.length)
            formatSections[1] = format.substring(formatDecimalIndex + 1, format.length);

        var decimals = formatSections[1] ? formatSections[1].length : 0;

        if (formatObject.alterer)
            num = formatObject.alterer(+num);
        num = roundNumber(+num, decimals);
        var sign = 0 &gt; +num ? -1 : 1;
        num = num.toString();
        num = num.replace(new RegExp(&#039;,&#039;, &#039;g&#039;), &#039;&#039;).replace(&#039;-&#039;, &#039;&#039;);   
        var dataDecimalIndex = ~num.indexOf(&#039;.&#039;) ? num.indexOf(&#039;.&#039;) : num.length;
        dataSections[0] = num.substring(0, dataDecimalIndex).split(&#039;&#039;).reverse().join(&#039;&#039;);
        if (dataDecimalIndex &lt; format.length)
            dataSections[1] = num.substring(dataDecimalIndex + 1, num.length);
        else if (formatDecimalIndex &lt; format.length)
            dataSections[1] = &#039;&#039;;

        var wholeNums = [];
        var charsSinceComma = 0;
        if (formatSections[0].length) {
            var finalCharIndex, i;
            if (formatSections[0].length) {
                finalCharIndex = formatSections[0].length &gt; dataSections[0].length ? formatSections[0].length : dataSections[0].length;
                for (i = 0; i &lt; finalCharIndex; i++) {
                    if (formatObject.shouldInsertSeparators &amp;&amp; charsSinceComma === 3 &amp;&amp; (dataSections[0].charAt(i) || formatSections[0].charAt(i) === &#039;0&#039;)) {
                        wholeNums.push(&#039;,&#039;);
                        charsSinceComma = 0;
                    }
                    if (dataSections[0].charAt(i)) {
                        wholeNums.push(dataSections[0].charAt(i));
                        charsSinceComma++;
                    }
                    else if (formatSections[0].charAt(i) === &#039;0&#039;) {
                        wholeNums.push(&#039;0&#039;);
                        charsSinceComma++;
                    }
                    else break;
                }
            }
            wholeNums = wholeNums.reverse().join(&#039;&#039;);

            var fractionNums = [];
            if (formatSections.length &gt; 1) {
                finalCharIndex = formatSections[1].length &gt; dataSections[1].length ? formatSections[1].length : dataSections[1].length;
                for (i = 0; i &lt; finalCharIndex; i++) {
                    if (formatSections[1].charAt(i) &amp;&amp; dataSections[1].charAt(i))
                        fractionNums.push(dataSections[1].charAt(i));
                    else if (formatSections[1].charAt(i) === &#039;0&#039;)
                        fractionNums.push(&#039;0&#039;);
                    else break;
                }
            }
            fractionNums = fractionNums.join(&#039;&#039;);

            var value = fractionNums.length ? wholeNums + &#039;.&#039; + fractionNums : wholeNums;
            return sign === -1 ? formatObject.prependedSymbol + &#039;-&#039; + value + formatObject.appendedSymbol : formatObject.prependedSymbol + value + formatObject.appendedSymbol;
        }
        return num;
    }

    function verifyFormat(format) {
        var formatSections = [];
        format = format.replace(/[^0#,.]/g , &#039;&#039;);

        var decimalIndex = ~format.indexOf(&#039;.&#039;) ? format.indexOf(&#039;.&#039;) : format.length;
        var leadingChars = format.substring(0, decimalIndex);
        var shouldInsertSeparators = leadingChars.indexOf(&#039;,&#039;) &gt; -1;
        leadingChars = leadingChars.replace(new RegExp(&#039;,&#039;, &#039;g&#039;), &#039;&#039;);

        formatSections[0] = leadingChars;
        if (decimalIndex &lt; format.length)
            formatSections[1] = format.substring(decimalIndex + 1, format.length).split(&#039;&#039;).reverse().join(&#039;&#039;);

        for (var i = 0; i &lt; formatSections.length; i++) {
            var zeroFound = false;
            for (var j = 0; j &lt; formatSections[i].length; j++) {
                if (zeroFound &amp;&amp; formatSections[i].charAt(j) !== &#039;0&#039;)
                    formatSections[i] = formatSections[i].substring(0, j) + &#039;0&#039; + formatSections[i].substring(j + 1, formatSections[i].length);
                else if (!zeroFound &amp;&amp; formatSections[i].charAt(j) === &#039;0&#039;)
                    zeroFound = true;
            }
        }

        return {
            value: formatSections.length &lt; 2 ? formatSections[0] : formatSections[0] + &#039;.&#039; + formatSections[1].split(&#039;&#039;).reverse().join(&#039;&#039;),
            shouldInsertSeparators: shouldInsertSeparators,
            alterer: null,
            prependedSymbol: &#039;&#039;,
            appendedSymbol: &#039;&#039;
        };
    }

    function createCurrencyNumberOrPercentFormat(format) {
        var charStripper = &#039;\\d{0,2}]&#039;,
            cPOrN = ~format.indexOf(&#039;P&#039;) ? &#039;P&#039; : ~format.indexOf(&#039;N&#039;) ? &#039;N&#039; : &#039;C&#039;;
        format = format.split(cPOrN);
        var wholeNums = verifyFormat(format[0]),
            re = new RegExp(&#039;[^&#039; + cPOrN + charStripper, &#039;g&#039;);
        format = format[1].replace(re, &#039;&#039;);
        var numDecimals = 2, newFormat;
        if (format.length)
            numDecimals = parseInt(format.substring(0,2));

        if (wholeNums.value)
            newFormat = numDecimals ? wholeNums.value + &#039;.&#039; : wholeNums.value;
        else if (numDecimals &amp;&amp; cPOrN === &#039;C&#039;)
            newFormat = &#039;0.&#039;;
        else if (numDecimals &amp;&amp; cPOrN === &#039;P&#039;)
            newFormat = &#039;00.&#039;;
        else if (numDecimals &amp;&amp; cPOrN === &#039;N&#039;)
            newFormat = &#039;0.&#039;;
        else newFormat = cPOrN === &#039;C&#039; || cPOrN === &#039;N&#039; ? &#039;0&#039; : &#039;00&#039;;

        for (var i = 0; i &lt; numDecimals; i++) {
            newFormat += &#039;0&#039;;
        }
        return { value: newFormat,
            shouldInsertSeparators: wholeNums.shouldInsertSeparators,
            alterer: cPOrN === &#039;C&#039; || cPOrN === &#039;N&#039; ? null : x100,
            prependedSymbol: cPOrN === &#039;C&#039; ? &#039;$&#039; : &#039;&#039;,
            appendedSymbol: cPOrN === &#039;P&#039; ? &#039;%&#039; : &#039;&#039;
        };
    }

    function x100(val) {
        return val * 100;
    }

    function roundNumber(val, dec) {
        var pow = Math.pow(10, dec || 0);
        return Math.round((val*pow))/pow;
    }

    function cloneGridData(gridData) { 
        if (gridData == null || typeof (gridData) !== &#039;object&#039;)
            return gridData;

        if (Object.prototype.toString.call(gridData) === &#039;[object Array]&#039;)
            return cloneArray(gridData);

        var temp = {};
        for (var key in gridData)
            temp[key] = cloneGridData(gridData[key]);

        return temp;
    }

    function cloneArray(arr) {
        var length = arr.length,
            newArr = new arr.constructor(length);

        if (length &amp;&amp; typeof arr[0] == &#039;string&#039; &amp;&amp; hasOwnProperty.call(arr, &#039;index&#039;)) {
            newArr.index = arr.index;
            newArr.input = arr.input;
        }

        var index = -1;
        while (++index &lt; length) {
            newArr[index] = cloneGridData(arr[index]);
        }
        return newArr;
    }

    function isDomElement(node) {
        return node &amp;&amp; node instanceof Element &amp;&amp; node instanceof Node &amp;&amp; typeof node.ownerDocument === &#039;object&#039;;
    }

    function isNumber(value) {
        return typeof value === &#039;number&#039; &amp;&amp; value === value;
    }

    function isInteger(value) {
        return isNumber(value) &amp;&amp; value % 1 === 0;
    }

    expressionParser = (function _expressionParser() {
        var stack = {
            init: function _init() {
                this.data = [];
                this.top = 0;
            },
            push: function _push(item) {
                this.data[this.top++] = item;
            },
            pop: function _pop() {
                return this.data[--this.top];
            },
            peek: function _peek() {
                return this.data[this.top - 1];
            },
            clear: function _clear() {
                this.top = 0;
            },
            length: function _length() {
                return this.top;
            }
        },
            associativity = { RTL: 1, LTR: 2 },
            booleanExpressionTree = {
            init: function _init() {
                this.tree = null;
                this.context = null;
                this.rootNode = null;
                return this;
            }
        };

        booleanExpressionTree.setTree = function _setTree(tree) {
            this.queue = tree;
            this.rootNode = tree[this.queue.length - 1];
            return this;
        };
        booleanExpressionTree.createTree = function _createTree() {
            this.queue.pop();
            if (this.queue.length)
                this.rootNode.addChildren(this.queue);
        };
        booleanExpressionTree.filterCollection = function _filterCollection(collection) {
            return collection.filter(function collectionMap(curr) {
                this.context = curr;
                return this.rootNode.evaluate(curr);
            }, this);
        };
        booleanExpressionTree.internalGetContext = function _internalGetContext() {
            return this.context;
        };
        booleanExpressionTree.getContext = function _getContext() {
            return this.internalGetContext.bind(this);
        };
        booleanExpressionTree.isTrue = function _isTrue(item) {
            this.context = item;
            return this.rootNode.value;
        };

        var astNode = {
            createNode: function _createNode(node) {
                var operatorCharacteristics = getOperatorPrecedence(node);
                if (operatorCharacteristics) {
                    this.operator = node;
                    this.numberOfOperands = getNumberOfOperands(this.operator);
                    this.precedence = operatorCharacteristics.precedence;
                    this.associativity = operatorCharacteristics.associativity;
                    this.children = [];
                }
                else {
                    this.field = node.field;
                    this.standard = node.value;
                    this.operation = node.operation;
                    this.dataType = node.dataType;
                    this.context = null;
                }
                this._value = null;
                this.getContext = null;
                this.queue = null;
            }
        };

        astNode.createTree = function _createTree(queue) {
            this.queue = queue.reverse();
            this.tree = this.queue;
            this.addChildren(this.queue);
        };

        astNode.addChildren = function _addChildren(tree) {
            if (this.children &amp;&amp; this.children.length &lt; this.numberOfOperands) {
                var child = tree.pop();
                child.addChildren(tree);
                this.children.push(child);
                child = tree.pop();
                child.addChildren(tree);
                this.children.push(child);
            }
            return this;
        };

        astNode.addChild = function _addChild(child) {
            if (this.children &amp;&amp; this.children.length &lt; this.numberOfOperands)
                this.children.push(child);
            return this;
        };

        astNode.evaluate = function _evaluate() {
            if (this.children &amp;&amp; this.children.length) {
                switch (this.operator) {
                    case &#039;or&#039;:
                        return this.children[1].evaluate() || this.children[0].evaluate();
                    case &#039;and&#039;:
                        return this.children[1].evaluate() &amp;&amp; this.children[0].evaluate();
                    case &#039;xor&#039;:
                        return !!(this.children[1].evaluate() ^ this.children[0].evaluate());
                    case &#039;nor&#039;:
                        return !(this.children[1].evaluate() || this.children[0].evaluate());
                    case &#039;nand&#039;:
                        return !(this.children[1].evaluate() &amp;&amp; this.children[0].evaluate());
                    case &#039;xnor&#039;:
                        return !(this.children[1].evaluate() ^ this.children[0].evaluate());
                }
            }
            else {
                var initialVal = this.getContext()[this.field],
                    normalizedBase = this.standard != null ? normalizeValues(this.dataType, this.standard) : null;
                this._value = comparator(normalizeValues(this.dataType, initialVal), normalizedBase, this.operation);
                return this._value;
            }
        };

        astNode.getValue = function _getValue() {
            if (this._value == null) this._value = this.evaluate();
            return this._value;
        };

        Object.defineProperty(astNode, &#039;value&#039;, {
            get: function _getValue() {
                if (!this._value) this._value = this.evaluate();
                return this._value;
            }
        });

        function getNodeContext(bet) {
            return bet.internalGetContext.bind(bet);
        }

        function createFilterTreeFromFilterObject(filterObject) {
            var ret = Object.create(booleanExpressionTree);
            ret.init();
            var operandStack = Object.create(stack);
            operandStack.init();
            var queue = [],
                topOfStack;

            iterateFilterGroup(filterObject, operandStack, queue, getNodeContext(ret));

            while (operandStack.length()) {
                topOfStack = operandStack.peek();
                if (topOfStack.operator !== &#039;(&#039;) queue.push(operandStack.pop());
                else operandStack.pop();
            }

            ret.setTree(queue);
            ret.createTree();
            return ret;
        }

        function iterateFilterGroup(filterObject, stack, queue, contextGetter) {
            var conjunction = filterObject.conjunct,
                idx = 0,
                topOfStack;

            while (idx &lt; filterObject.filterGroup.length) {
                if (idx &gt; 0) {
                    var conjunctObj = Object.create(astNode);
                    conjunctObj.createNode(conjunction);
                    pushConjunctionOntoStack(conjunctObj, stack, queue);
                }
                if (filterObject.filterGroup[idx].conjunct) {
                    var paren = Object.create(astNode);
                    paren.createNode(&#039;(&#039;);
                    stack.push(paren);
                    iterateFilterGroup(filterObject.filterGroup[idx], stack, queue, contextGetter);
                    while (stack.length()) {
                        topOfStack = stack.peek();
                        if (topOfStack.operator !== &#039;(&#039;) queue.push(stack.pop());
                        else {
                            stack.pop();
                            break;
                        }
                    }
                }
                else {
                    var leafNode = Object.create(astNode);
                    leafNode.createNode(filterObject.filterGroup[idx]);
                    leafNode.getContext = contextGetter;
                    queue.push(leafNode);
                }
                ++idx;
            }
        }

        function pushConjunctionOntoStack(conjunction, stack, queue) {
            while (stack.length()) {
                var topOfStack = stack.peek();
                if ((conjunction.associativity === associativity.LTR &amp;&amp; conjunction.precedence &lt;= topOfStack.precedence) ||
                    (conjunction.associativity === associativity.RTL &amp;&amp; conjunction.precedence &lt; topOfStack.precedence))
                    queue.push(stack.pop());
                else
                    break;
            }
            stack.push(conjunction);
        }

        function getNumberOfOperands(operator) {
            switch (operator) {
                case &#039;!&#039;:
                    return 1;
                case &#039;(&#039;:
                case &#039;)&#039;:
                    return 0;
                default:
                    return 2;
            }
        }

        function getOperatorPrecedence(operator) {
            switch (operator) {
                case &#039;!&#039;:
                    return { precedence: 1, associativity: associativity.LTR };
                case &#039;and&#039;:
                    return { precedence: 2, associativity: associativity.RTL };
                case &#039;xor&#039;:
                    return { precedence: 3, associativity: associativity.RTL };
                case &#039;or&#039;:
                    return { precedence: 4, associativity: associativity.RTL };
                case &#039;(&#039;:
                case &#039;)&#039;:
                    return { precedence: null, associativity: null };
                default:
                    return null;
            }
        }

        return {
            createFilterTreeFromFilterObject: createFilterTreeFromFilterObject
        };
    })();

    generateId = (function guid(seed) {
        return function _generateId() {
            seed++;
            return seed.toString();
        };
    })(-1);

    var gridApi = {};

    return Object.defineProperties(
        gridApi, {
            &#039;getGridInstance&#039;: {
                value: function getGridInstance(elem) {
                    elem = $(elem);
                    for (var i = 0; i &lt; gridState.length; i++) {
                        if (elem[0] === gridState[i].grid[0])
                            return gridState[i].grid[0].grid;
                    }
                },
                writable: false,
                configurable: false
            },
            &#039;createGrid&#039;: {
                get: function _createGrid() {
                    return create;
                }
            }
        }
    );
})(jQuery);</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
